<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Your Central Workspace</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            height: 100vh;
        }
        
        /* Left Side - Login Form */
        .left-side {
            flex: 0 0 45%;
            background: white;
            display: flex;
            flex-direction: column;
            padding: 60px 80px;
            overflow-y: auto;
        }
        
        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 60px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .logo svg {
            width: 28px;
            height: 28px;
        }
        
        .form-container {
            max-width: 400px;
            width: 100%;
        }
        
        h1 {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 32px;
            line-height: 1.5;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 32px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            font-size: 15px;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            position: relative;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        
        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid #e5e7eb;
            border-radius: 8px;
            font-size: 15px;
            color: #1f2937;
            transition: all 0.2s;
            background: white;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group input::placeholder {
            color: #9ca3af;
        }
        
        .password-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .forgot-password {
            font-size: 13px;
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        
        .forgot-password:hover {
            text-decoration: underline;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .get-otp-button {
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: 1.5px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .get-otp-button:hover {
            background: #f3f4f6;
        }
        
        .get-otp-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .signin-button {
            flex: 1;
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .signin-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .signin-button:active {
            transform: translateY(0);
        }
        
        .signin-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .message {
            min-height: 24px;
            font-size: 14px;
            margin-top: 12px;
            text-align: center;
        }
        
        .error-message {
            color: #ef4444;
        }
        
        .success-message {
            color: #10b981;
        }
        
        /* Right Side - Image/Branding */
        .right-side {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        
        .right-side::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
        }
        
        .branding-content {
            position: relative;
            z-index: 1;
            text-align: center;
            padding: 60px;
            color: white;
        }
        
        .branding-image {
            width: 400px;
            height: 400px;
            border-radius: 20px;
            margin-bottom: 40px;
            object-fit: cover;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .branding-content h2 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 16px;
            line-height: 1.3;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .branding-content p {
            font-size: 18px;
            opacity: 0.95;
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .left-side {
                flex: 0 0 50%;
                padding: 40px 50px;
            }
            
            .branding-image {
                width: 300px;
                height: 300px;
            }
            
            .branding-content h2 {
                font-size: 28px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .left-side {
                flex: 1;
                padding: 30px;
            }
            
            .right-side {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Left Side - Login Form -->
        <div class="left-side">
            <div class="logo">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 10V3L4 14h7v7l9-11h-7z" fill="white"/>
                </svg>
            </div>
            
            <div class="form-container">
                <h1>Sign In</h1>
                <p class="subtitle">Sign In to continue to your workspace</p>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" id="tab-otp" onclick="switchTab('otp', this)">Phone & OTP</button>
                    <button class="tab" id="tab-password" onclick="switchTab('password', this)">Phone & Password</button>
                </div>
                
                <form id="loginForm" onsubmit="return handleSignIn(event)">
                    <!-- OTP Tab Content -->
                    <div id="otp-tab" class="tab-content active">
                        <div class="form-group">
                            <label for="phone-otp">Phone Number*</label>
                            <input 
                                type="tel" 
                                id="phone-otp" 
                                name="phone-otp" 
                                placeholder="Enter your phone number"
                                required
                                autocomplete="tel"
                                pattern="[0-9]{10,}"
                                minlength="10"
                            >
                        </div>
                        
                        <div class="form-group">
                            <label for="otp">OTP*</label>
                            <input 
                                type="text" 
                                id="otp" 
                                name="otp" 
                                placeholder="Enter OTP"
                                required
                                maxlength="6"
                                minlength="4"
                                pattern="[0-9]+"
                                inputmode="numeric"
                            >
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="get-otp-button" id="getOtpBtn" onclick="requestOTP()">Get OTP</button>
                            <button type="submit" class="signin-button" id="signinBtn">Sign in</button>
                        </div>
                    </div>
                    
                    <!-- Password Tab Content -->
                    <div id="password-tab" class="tab-content">
                        <div class="form-group">
                            <label for="phone-password">Phone Number*</label>
                            <input 
                                type="tel" 
                                id="phone-password" 
                                name="phone-password" 
                                placeholder="Enter your phone number"
                                required
                                autocomplete="tel"
                                pattern="[0-9]{10,}"
                                minlength="10"
                            >
                        </div>
                        
                        <div class="form-group">
                            <div class="password-header">
                                <label for="password">Password*</label>
                                <a href="#" class="forgot-password" onclick="handleForgotPassword(event)">Forgot Password?</a>
                            </div>
                            <input 
                                type="password" 
                                id="password" 
                                name="password" 
                                placeholder="Enter Password"
                                required
                                autocomplete="current-password"
                            >
                        </div>
                        
                        <button type="submit" class="signin-button" id="signinBtnPwd">Sign in</button>
                    </div>
                    
                    <div id="message" class="message"></div>
                </form>
            </div>
        </div>
        
        <!-- Right Side - Branding -->
        <div class="right-side">
            <div class="branding-content">
                <div class="branding-image">
                    <svg width="200" height="200" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="100" cy="60" r="40" fill="white" opacity="0.9"/>
                        <rect x="50" y="120" width="100" height="12" rx="6" fill="white" opacity="0.7"/>
                        <rect x="60" y="145" width="80" height="10" rx="5" fill="white" opacity="0.6"/>
                        <rect x="70" y="165" width="60" height="8" rx="4" fill="white" opacity="0.5"/>
                    </svg>
                </div>
                <h2>Your Central Workspace<br>for Everyday Work</h2>
                <p>Streamline your productivity and manage your tasks efficiently with our comprehensive tracking solution.</p>
            </div>
        </div>
    </div>
    
    <script>
        let currentTab = 'otp';
        let isSubmitting = false;
        
        function switchTab(tab, element) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            } else {
                document.getElementById('tab-' + tab).classList.add('active');
            }
            
            // Update tab content
            document.getElementById('otp-tab').classList.toggle('active', tab === 'otp');
            document.getElementById('password-tab').classList.toggle('active', tab === 'password');
            
            // Clear messages
            showMessage('');
            
            // Focus on first input of active tab
            setTimeout(() => {
                if (tab === 'otp') {
                    const phoneInput = document.getElementById('phone-otp');
                    if (phoneInput) phoneInput.focus();
                } else {
                    const phoneInput = document.getElementById('phone-password');
                    if (phoneInput) phoneInput.focus();
                }
            }, 100);
        }
        
        function showMessage(text, isError = true) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = isError ? 'message error-message' : 'message success-message';
        }
        
        function handleForgotPassword(event) {
            event.preventDefault();
            showMessage('Please contact your administrator to reset your password', false);
        }
        
        async function requestOTP() {
            const phone = document.getElementById('phone-otp').value.trim();
            const getOtpBtn = document.getElementById('getOtpBtn');
            
            if (!phone) {
                showMessage('Please enter your phone number');
                return;
            }
            
            // Basic phone validation
            if (phone.length < 10) {
                showMessage('Please enter a valid phone number (at least 10 digits)');
                return;
            }
            
            getOtpBtn.disabled = true;
            getOtpBtn.textContent = 'Sending...';
            showMessage('');
            
            try {
                if (typeof pywebview === 'undefined' || !pywebview.api) {
                    showMessage('Application API not available. Please restart the application.');
                    getOtpBtn.disabled = false;
                    getOtpBtn.textContent = 'Get OTP';
                    return;
                }
                
                if (!pywebview.api.request_otp) {
                    showMessage('OTP request method not available. Please restart the application.');
                    getOtpBtn.disabled = false;
                    getOtpBtn.textContent = 'Get OTP';
                    return;
                }
                
                const result = await pywebview.api.request_otp(phone);
                
                if (result && result.success) {
                    showMessage(result.message || 'OTP sent successfully! Check your phone.', false);
                    getOtpBtn.textContent = 'Resend OTP';
                    // Focus on OTP input field
                    document.getElementById('otp').focus();
                } else {
                    showMessage(result.message || 'Failed to send OTP. Please try again.');
                    getOtpBtn.textContent = 'Get OTP';
                }
            } catch (error) {
                console.error('OTP request error:', error);
                showMessage('An error occurred. Please check your internet connection and try again.');
                getOtpBtn.textContent = 'Get OTP';
            } finally {
                getOtpBtn.disabled = false;
            }
        }
        
        async function handleSignIn(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation(); // Prevent other handlers
            }
            
            if (isSubmitting) {
                console.log('Login already in progress, ignoring duplicate call');
                return false;
            }
            
            // Set flag immediately to prevent duplicate calls
            isSubmitting = true;
            console.log('handleSignIn called, isSubmitting set to true');
            
            let credentials = {};
            let signinBtn;
            
            if (currentTab === 'otp') {
                const phone = document.getElementById('phone-otp').value.trim();
                const otp = document.getElementById('otp').value.trim();
                signinBtn = document.getElementById('signinBtn');
                
                if (!phone || !otp) {
                    showMessage('Please enter phone number and OTP');
                    isSubmitting = false;
                    return false;
                }
                
                // Validate phone number
                if (phone.length < 10) {
                    showMessage('Please enter a valid phone number (at least 10 digits)');
                    isSubmitting = false;
                    return false;
                }
                
                // Validate OTP
                if (!/^\d+$/.test(otp)) {
                    showMessage('OTP should contain only numbers');
                    isSubmitting = false;
                    return false;
                }
                
                if (otp.length < 4 || otp.length > 6) {
                    showMessage('Please enter a valid OTP (4-6 digits)');
                    isSubmitting = false;
                    return false;
                }
                
                credentials = {
                    method: 'otp',
                    phone: phone,
                    otp: otp
                };
            } else {
                const phone = document.getElementById('phone-password').value.trim();
                const password = document.getElementById('password').value;
                signinBtn = document.getElementById('signinBtnPwd');
                
                if (!phone || !password) {
                    showMessage('Please enter phone number and password');
                    isSubmitting = false;
                    return false;
                }
                
                // Validate phone number
                if (phone.length < 10) {
                    showMessage('Please enter a valid phone number (at least 10 digits)');
                    isSubmitting = false;
                    return false;
                }
                
                // Validate password
                if (password.length < 4) {
                    showMessage('Password should be at least 4 characters');
                    isSubmitting = false;
                    return false;
                }
                
                credentials = {
                    method: 'password',
                    phone: phone,
                    password: password,
                    remember: false
                };
            }
            
            // Check if button exists
            if (!signinBtn) {
                console.error('Sign in button not found!');
                showMessage('Error: Sign in button not found. Please refresh the page.');
                isSubmitting = false;
                return false;
            }
            
            signinBtn.disabled = true;
            signinBtn.textContent = 'Signing in...';
            showMessage('');
            
            console.log('Submitting login with credentials:', { 
                method: credentials.method, 
                phone: credentials.phone,
                hasOtp: !!credentials.otp,
                hasPassword: !!credentials.password
            });
            
            try {
                // Check if pywebview API is available
                if (typeof pywebview === 'undefined' || !pywebview.api) {
                    console.error('pywebview API not available');
                    showMessage('Application API not available. Please restart the application.');
                    signinBtn.disabled = false;
                    signinBtn.textContent = 'Sign in';
                    isSubmitting = false;
                    return false;
                }
                
                if (!pywebview.api.submit_login) {
                    console.error('submit_login method not available');
                    showMessage('Login method not available. Please restart the application.');
                    signinBtn.disabled = false;
                    signinBtn.textContent = 'Sign in';
                    isSubmitting = false;
                    return false;
                }
                
                console.log('Calling pywebview.api.submit_login...');
                const result = await pywebview.api.submit_login(credentials);
                
                console.log('Login result received:', result);
                
                if (result && result.success) {
                    console.log('Login successful!');
                    showMessage('Login successful! Redirecting...', false);
                    // Window will close automatically on success
                    // Don't reset isSubmitting - let window close
                } else {
                    const errorMsg = (result && result.message) || 'Login failed. Please check your credentials.';
                    console.error('Login failed:', errorMsg);
                    showMessage(errorMsg);
                    signinBtn.disabled = false;
                    signinBtn.textContent = 'Sign in';
                    isSubmitting = false;
                }
            } catch (error) {
                console.error('Login error:', error);
                console.error('Error stack:', error.stack);
                const errorMsg = error.message || 'An error occurred. Please try again.';
                showMessage('Error: ' + errorMsg);
                signinBtn.disabled = false;
                signinBtn.textContent = 'Sign in';
                isSubmitting = false;
            }
            
            return false;
        }
        
        // Focus on phone input when page loads
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('phone-otp').focus();
            
            // Debug info
            console.log('Login page loaded', {
                pywebview: typeof pywebview !== 'undefined',
                pywebviewApi: typeof pywebview !== 'undefined' && !!pywebview.api
            });
            
            // Add explicit click handlers to sign in buttons
            const signinBtn = document.getElementById('signinBtn');
            const signinBtnPwd = document.getElementById('signinBtnPwd');
            
            if (signinBtn) {
                signinBtn.addEventListener('click', function(e) {
                    console.log('Sign in button (OTP) clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    handleSignIn(e);
                });
            }
            
            if (signinBtnPwd) {
                signinBtnPwd.addEventListener('click', function(e) {
                    console.log('Sign in button (Password) clicked');
                    e.preventDefault();
                    e.stopPropagation();
                    handleSignIn(e);
                });
            }
            
            // Also ensure form submission works
            const form = document.getElementById('loginForm');
            if (form) {
                form.addEventListener('submit', function(e) {
                    console.log('Form submit event triggered');
                    e.preventDefault();
                    e.stopPropagation();
                    handleSignIn(e);
                });
            }
        });
        
        // Handle Enter key
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isSubmitting) {
                const activeElement = document.activeElement;
                if (activeElement && activeElement.tagName === 'INPUT') {
                    e.preventDefault();
                    handleSignIn(e);
                }
            }
        });
    </script>
</body>
</html>
