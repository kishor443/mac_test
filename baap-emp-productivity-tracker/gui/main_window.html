<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baap Company - Productivity Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            font-family: 'Inter', sans-serif;
            background: #F5F7FA;
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }
        
        /* Dashboard Layout */
        .dashboard-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Left Sidebar */
        .sidebar {
            width: 260px;
            background: white;
            color: #1F2937;
            padding: 24px 0;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            left: 0;
            transition: left 0.3s ease;
            z-index: 1000;
            border-right: 1px solid #E5E7EB;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .sidebar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .sidebar.hidden {
            left: -260px;
        }
        
        .sidebar-logo {
            padding: 0 24px 32px;
            font-size: 20px;
            font-weight: 700;
            color: #1F2937;
        }
        
        .sidebar-nav {
            flex: 1;
        }
        
        .nav-item {
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6B7280;
            font-size: 15px;
            font-weight: 500;
        }
        
        .nav-item:hover:not(.active) {
            background: rgba(147, 51, 234, 0.05);
            color: #9333EA;
        }
        
        .nav-item:hover:not(.active) .nav-icon svg {
            stroke: #9333EA;
        }
        
        .nav-item.active {
            background: #9333EA;
            color: white;
            border-radius: 8px;
            margin: 0 12px;
            font-weight: 600;
        }
        
        .nav-item.active .nav-icon {
            color: white;
        }
        
        .nav-item.active .nav-icon svg {
            stroke: white;
            fill: none;
        }
        
        /* Task Management Dropdown */
        .nav-item-dropdown {
            padding: 14px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
            font-size: 15px;
            font-weight: 500;
            background: #F3F4F6;
            margin: 4px 16px;
            border-radius: 8px;
        }
        
        .nav-item-dropdown:hover {
            background: #E5E7EB;
        }
        
        .nav-item-dropdown.active {
            background: #464f5d;
            color: white;
        }
        
        .nav-dropdown-content {
            padding-left: 16px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        
        .nav-dropdown-content.show {
            max-height: 500px;
        }
        
        .nav-sub-item {
            padding: 12px 24px;
            padding-left: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            color: #6B7280;
            font-size: 14px;
            font-weight: 400;
            margin: 2px 16px;
            border-radius: 8px;
        }
        
        .nav-sub-item:hover {
            background: #F9FAFB;
            color: #374151;
        }
        
        .nav-sub-item.active {
            background: #EFF6FF;
            color: #2563EB;
            font-weight: 500;
        }
        
        .dropdown-arrow {
            font-size: 12px;
            transition: transform 0.3s ease;
        }
        
        .dropdown-arrow.rotated {
            transform: rotate(90deg);
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }
        
        .nav-icon svg {
            width: 20px;
            height: 20px;
            stroke: #6B7280;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .nav-item.active .nav-icon svg {
            stroke: white;
        }
        
        .sidebar-promo {
            margin: 24px 16px;
            padding: 20px;
            background: #2563EB;
            border-radius: 12px;
            font-size: 13px;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-promo::before {
            content: '';
            position: absolute;
            top: -20px;
            right: -20px;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .sidebar-promo::after {
            content: '';
            position: absolute;
            bottom: -30px;
            right: -10px;
            width: 60px;
            height: 60px;
            background: rgba(147, 197, 253, 0.2);
            border-radius: 50%;
        }
        
        .sidebar-promo-title {
            font-weight: 700;
            margin-bottom: 12px;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-promo-list {
            list-style: none;
            padding-left: 0;
            position: relative;
            z-index: 1;
        }
        
        .sidebar-promo-list li {
            padding: 6px 0;
            font-size: 12px;
            opacity: 0.95;
        }
        
        /* 3-Dot Menu Button */
        .menu-dots-btn {
            width: 40px;
            height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
            margin-right: 12px;
        }
        
        .menu-dots-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .menu-dot {
            width: 4px;
            height: 4px;
            background: #374151;
            border-radius: 50%;
        }
        
        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.show {
            display: block;
            opacity: 1;
        }
        
        /* Main Content Area */
        .main-content {
            flex: 1;
            margin-left: 260px;
            margin-right: 340px;
            padding: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background: #F5F7FA;
            transition: margin-left 0.3s ease;
            padding-top: 64px; /* space for fixed header */
            height: 100vh;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .main-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .main-content.sidebar-hidden {
            margin-left: 0;
        }
        
        /* Top Header */
        .top-header {
            position: fixed;
            top: 0;
            left: 260px; /* align with sidebar */
            right: 0;
            height: 64px;
            background: white;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #E5E7EB;
            z-index: 1000;
            gap: 16px;
        }
        
        .header-left {
            display: none;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-left: auto;
        }
        
        .search-box {
            padding: 12px 16px;
            border: 1px solid #E5E7EB;
            border-radius: 10px;
            font-size: 14px;
            width: 420px;
            background: #FFFFFF;
            outline: none;
            transition: all 0.2s;
            max-width: 540px;
        }
        
        .search-box:focus {
            border-color: #6B5CF6;
            box-shadow: 0 0 0 3px rgba(107, 92, 246, 0.12);
            background: #FFFFFF;
        }
        
        .search-box::placeholder {
            color: #9CA3AF;
            font-size: 14px;
        }
        
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }
        
        .user-menu {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-menu svg {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            background: #EFF6FF;
            color: #2563EB;
        }
        
        .clock-display {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        /* Content Area */
        .content {
            padding: 24px 32px;
        }
        
        /* Top row buttons (Clock In / Clock Out / Start Break) */
        .top-row {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 16px;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        /* Welcome Banner */
        .welcome-banner {
            background: #1E293B;
            border-radius: 20px;
            padding: 32px 40px;
            margin-bottom: 24px;
            color: white;
            position: relative;
            overflow: hidden;
            min-height: 180px;
        }
        
        .welcome-content {
            position: relative;
            z-index: 1;
        }
        
        .welcome-title {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.85);
            margin-bottom: 24px;
        }
        
        .welcome-subtitle .task-count-highlight {
            color: #fff;
            font-weight: 600;
        }

        /* Decorative art in welcome banner */
        .welcome-art {
            position: absolute;
            right: 20px;
            bottom: 0;
            width: 200px;
            height: 140px;
            pointer-events: none;
            display: flex;
            align-items: flex-end;
            justify-content: flex-end;
            gap: 0;
        }

        .welcome-art-circle {
            position: absolute;
            border-radius: 999px 999px 0 0;
            bottom: 0;
        }

        /* Blue arc - leftmost, smallest */
        .welcome-art-circle.c1 {
            background: #4A7FB5;
            width: 70px;
            height: 85px;
            right: 140px;
            z-index: 1;
        }

        /* Teal/cyan arc - middle */
        .welcome-art-circle.c2 {
            background: #6B9E9B;
            width: 75px;
            height: 110px;
            right: 85px;
            z-index: 2;
        }

        /* Light blue-green overlay on teal */
        .welcome-art-circle.c2b {
            background: #8FBCB8;
            width: 55px;
            height: 75px;
            right: 95px;
            z-index: 3;
        }

        /* Olive/khaki arc - rightmost, tallest */
        .welcome-art-circle.c3 {
            background: #A09060;
            width: 80px;
            height: 130px;
            right: 20px;
            z-index: 4;
        }

        /* Light beige overlay on olive */
        .welcome-art-circle.c3b {
            background: #C4B896;
            width: 60px;
            height: 95px;
            right: 30px;
            z-index: 5;
        }
        
        /* Task Overview Cards */
        .task-overview {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .task-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .task-icon.blue { background: #DBEAFE; color: #2563EB; }
        .task-icon.green { background: #D1FAE5; color: #10B981; }
        .task-icon.yellow { background: #FEF3C7; color: #F59E0B; }
        
        .task-content {
            flex: 1;
        }
        
        .task-value {
            font-size: 24px;
            font-weight: 700;
            color: #1F2937;
        }
        
        .task-label {
            font-size: 14px;
            color: #6B7280;
            margin-top: 4px;
        }
        
        /* Shift / Session / Worked / Break cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 cards upar, 2 cards niche */
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stats-card {
            position: relative;
            background: #FFFFFF;
            border-radius: 16px;
            padding: 14px 18px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.03);
            border: 1px solid #E5E7EB;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .stats-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
        }
        
        .stats-sub {
            font-size: 12px;
            color: #6B7280;
        }
        
        .stats-icon {
            position: absolute;
            right: 16px;
            top: 16px;
            width: 28px;
            height: 28px;
            border-radius: 999px;
            background: #F3E8FF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #9333EA;
        }
        
        .stats-icon svg {
            width: 18px;
            height: 18px;
            stroke: #9333EA;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .stats-title-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-badge {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 999px;
            background: #DCFCE7;
            color: #166534;
        }
        
        /* Widget Grid */
        .widget-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 24px;
        }
        
        .widget-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .widget-title {
            font-size: 16px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 16px;
        }
        
        /* Action Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            background: #ffffff;
            color: #111827;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.12);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-primary {
            background: #9333EA; /* vibrant purple */
            color: white;
            box-shadow: 0 8px 20px rgba(147, 51, 234, 0.35);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #7E22CE;
        }
        
        .btn-clock-out {
            background: #FF6B7A; /* coral red */
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 122, 0.35);
        }
        
        .btn-clock-out:hover:not(:disabled) {
            background: #FF5566;
        }
        
        .btn-start-break {
            background: #E9D5FF; /* light lavender */
            color: #9333EA; /* darker purple text */
            box-shadow: 0 8px 20px rgba(233, 213, 255, 0.35);
        }
        
        .btn-start-break:hover:not(:disabled) {
            background: #DDD6FE;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.35);
        }
        
        .btn-success:hover:not(:disabled) {
            background: #059669;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .btn-icon-circle {
            width: 20px;
            height: 20px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.75);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            background: rgba(255, 255, 255, 0.12);
            flex-shrink: 0;
        }
        
        .btn-icon-circle svg {
            display: block;
        }
        
        .btn-icon-circle.dark {
            border: none;
            background: transparent;
            color: #9333EA; /* darker purple for start break icon */
        }
        
        /* Button icons */
        .btn-icon {
            font-size: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Right Sidebar */
        .right-sidebar {
            width: 340px;
            background: white;
            padding: 24px;
            position: fixed;
            right: 0;
            height: calc(100vh - 64px);
            overflow-y: auto;
            border-left: 1px solid #E5E7EB;
            top: 64px; /* sits below fixed header */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .right-sidebar::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .sidebar-widget {
            margin-bottom: 24px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }
        
        .schedule-widget {
            overflow: hidden; /* keep calendar inside card */
            padding: 12px 14px 16px 14px;
        }
        
        .sidebar-widget-title {
            font-size: 16px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .calendar-nav {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #374151;
        }
        
        .schedule-widget .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            column-gap: 4px;
            row-gap: 8px;
            margin-top: 8px;
        }
        
        .calendar-day {
            padding: 6px;
            text-align: center;
            font-size: 11px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .calendar-day.weekday {
            font-weight: 600;
            color: #6B7280;
        }
        
        .calendar-day.date {
            color: #374151;
        }
        
        .calendar-day.date:hover {
            background: #F3F4F6;
        }
        
        .calendar-day.date.highlight {
            background: #3B82F6;
            color: white;
        }
        
        .calendar-day.date.red {
            background: #EF4444;
            color: white;
        }
        
        /* Schedule, Reminder, Activity Lists */
        .list-item {
            padding: 12px 0;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item-title {
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 4px;
        }
        
        .list-item-time {
            font-size: 12px;
            color: #6B7280;
        }
        
        /* Page container */
        .page {
            display: none;
            overflow: visible;
            height: auto;
            min-height: 100%;
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
            height: auto;
            min-height: 100%;
            overflow: visible;
        }
        
        /* Project Dashboard Styles */
        .project-dashboard-container {
            padding: 32px;
            background: #F5F7FA;
            min-height: 100vh;
        }
        
        .project-dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .project-header-left {
            flex: 1;
        }
        
        .project-dashboard-title {
            font-size: 28px;
            font-weight: 700;
            color: #1F2937;
            margin: 0 0 8px 0;
        }
        
        .project-dashboard-subtitle {
            font-size: 14px;
            color: #6B7280;
            margin: 0;
        }
        
        .project-header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .project-search-box {
            position: relative;
            width: 280px;
        }
        
        .project-search-input {
            width: 100%;
            padding: 10px 40px 10px 16px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            color: #1F2937;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        
        .project-search-input::placeholder {
            color: #9CA3AF;
        }
        
        .project-search-input:focus {
            background: #FFFFFF;
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .project-search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #6B7280;
            pointer-events: none;
        }
        
        .project-new-btn {
            padding: 10px 20px;
            background: #2563EB;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .project-new-btn:hover {
            background: #1D4ED8;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.25);
        }
        
        .project-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }
        
        @media (max-width: 1600px) {
            .project-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1200px) {
            .project-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .project-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .project-card {
            background: #FFFFFF;
            border-radius: 12px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 1px solid #E5E7EB;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .project-card:hover {
            background: #F9FAFB;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-color: #2563EB;
        }
        
        .project-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        
        .project-name {
            font-size: 18px;
            font-weight: 600;
            color: #1F2937;
            margin: 0;
            flex: 1;
            padding-right: 12px;
        }
        
        .project-menu-btn {
            background: transparent;
            border: none;
            color: #9CA3AF;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .project-menu-btn:hover {
            color: #1F2937;
        }
        
        .project-tasks {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .project-task-count {
            font-size: 16px;
            font-weight: 600;
            color: #10B981;
        }
        
        .project-task-label {
            font-size: 14px;
            color: #6B7280;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #FFFFFF;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #111827;
        }
        
        .modal-close {
            font-size: 28px;
            font-weight: 300;
            color: #6B7280;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: #111827;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
            color: #111827;
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #6B5CF6;
            box-shadow: 0 0 0 3px rgba(107, 92, 246, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        
        .btn-secondary {
            padding: 10px 20px;
            background: #F3F4F6;
            color: #374151;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-secondary:hover {
            background: #E5E7EB;
        }
        
        /* Shift Section */
        .shift-section {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 24px;
        }
        
        .shift-select {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            color: #374151;
            font-family: 'Inter', sans-serif;
        }
        
        /* Table Styles */
        .table-container {
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            margin-bottom: 20px;
            background: white;
            overflow: hidden;
        }
        
        .table-header {
            background: #F9FAFB;
            padding: 10px 14px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            border-bottom: 1px solid #E5E7EB;
            font-weight: 600;
            font-size: 12px;
            color: #374151;
        }
        
        .table-row {
            padding: 12px 14px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            border-bottom: 1px solid #E5E7EB;
            font-size: 12px;
            color: #374151;
            background: white;
        }
        
        .table-row:last-child {
            border-bottom: none;
        }
        
        /* Footer */
        .footer {
            background: white;
            padding: 20px 32px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
        }
        
        .footer-left {
            font-size: 14px;
            color: #6B7280;
        }
        
        .footer-right {
            display: flex;
            gap: 24px;
            font-size: 14px;
            color: #6B7280;
        }
        
        .footer-link {
            color: #6B7280;
            text-decoration: none;
        }
        
        .footer-link:hover {
            color: #3B82F6;
        }
        
        /* Chart Widgets */
        .chart-widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .chart-widget-title {
            font-size: 16px;
            font-weight: 700;
            color: #1F2937;
        }
        
        .chart-options {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #6B7280;
            padding: 4px 8px;
        }
        
        .timeframe-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }
        
        /* Donut Chart */
        .donut-chart-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }
        
        .donut-chart {
            width: 180px;
            height: 180px;
        }
        
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-left: 24px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        .legend-color.blue { background: #60A5FA; }
        .legend-color.green { background: #34D399; }
        .legend-color.yellow { background: #FBBF24; }
        
        /* Line Chart */
        .line-chart-container {
            position: relative;
            height: 250px;
            margin: 20px 0;
        }
        
        .line-chart {
            width: 100%;
            height: 100%;
        }
        
        .chart-axis {
            font-size: 11px;
            fill: #6B7280;
        }
        
        .chart-grid {
            stroke: #E5E7EB;
            stroke-width: 1;
        }
        
        .chart-line {
            fill: none;
            stroke: #60A5FA;
            stroke-width: 2.5;
        }
        
        .chart-point {
            fill: #60A5FA;
            cursor: pointer;
        }
        
        .chart-point.highlight {
            fill: #3B82F6;
            r: 6;
        }
        
        .chart-tooltip {
            position: absolute;
            background: #1F2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 1000;
        }
        
        .chart-tooltip.show {
            opacity: 1;
        }
        
        .chart-tooltip-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .chart-tooltip-value {
            font-size: 11px;
            opacity: 0.9;
        }
        
        /* Stacked Bar Chart */
        .stacked-bar-chart-container {
            position: relative;
            width: 100%;
        }
        
        .stacked-bar-chart {
            width: 100%;
            height: 100%;
        }
        
        .stacked-bar {
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .stacked-bar:hover {
            opacity: 0.8;
        }

        /* Activity Snapshot tooltip */
        .activity-tooltip {
            position: absolute;
            min-width: 90px;
            background: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 10px 28px rgba(15, 23, 42, 0.18);
            padding: 4px 8px;
            font-size: 11px;
            color: #111827;
            pointer-events: none;
            opacity: 0;
            transform: translate(-50%, -100%);
            transition: opacity 0.15s ease;
            z-index: 10;
        }

        .activity-tooltip::after {
            content: "";
            position: absolute;
            left: 50%;
            bottom: -6px;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #FFFFFF;
            filter: drop-shadow(0 4px 4px rgba(15, 23, 42, 0.12));
        }

        .activity-tooltip-row {
            display: flex;
            align-items: center;
            gap: 6px;
            margin: 2px 0;
        }

        .activity-tooltip-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
        }
        
        /* Horizontal Bar Chart */
        .horizontal-bar-chart-container {
            position: relative;
            width: 100%;
        }
        
        .horizontal-bar-chart {
            width: 100%;
            height: 100%;
        }
        
        .horizontal-bar {
            cursor: pointer;
            transition: opacity 0.2s;
            rx: 4;
            ry: 4;
        }
        
        .horizontal-bar:hover {
            opacity: 0.8;
        }
        
        /* Activity Snapshot Legend */
        .activity-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 16px;
            font-size: 12px;
            color: #4B5563;
        }
        
        .activity-legend-item {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .activity-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 999px;
        }
        
        .activity-legend-value {
            font-weight: 600;
            color: #111827;
        }
        
        /* Task Page Wrapper */
        .task-page-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 64px);
            min-height: calc(100vh - 64px);
            background: #F5F7FA;
            overflow: hidden;
        }
        
        /* Task View Toggle Container */
        .task-view-toggle-container {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .task-view-toggle-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }
        
        .task-view-toggle-group {
            display: inline-flex;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            overflow: hidden;
            gap: 0;
        }
        
        .view-toggle-btn {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: #6B7280;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            background: white;
            border: none;
            border-right: 1px solid #E5E7EB;
        }
        
        .view-toggle-btn:last-child {
            border-right: none;
        }
        
        .view-toggle-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .view-toggle-btn:hover:not(.disabled) {
            background: #F9FAFB;
            color: #374151;
        }
        
        .view-toggle-btn.active {
            background: #9333EA;
            color: white;
        }
        
        .view-toggle-btn.active .view-toggle-icon {
            color: white;
        }
        
        .view-toggle-btn.active svg path,
        .view-toggle-btn.active svg rect,
        .view-toggle-btn.active svg circle {
            stroke: white;
            fill: white;
        }
        
        .view-toggle-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }
        
        .view-toggle-icon svg {
            width: 100%;
            height: 100%;
        }
        
        /* Task Main Content */
        .task-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Task Calendar Container */
        #taskCalendarContainer {
            flex: 1;
            overflow-y: auto;
            background: #FFFFFF;
            padding: 0;
        }
        
        #taskCalendarContainer .calendar-page-container {
            padding: 24px 32px;
            background: #FFFFFF;
            min-height: 100%;
        }
        
        /* Task List Container */
        #taskListContainer {
            flex: 1;
            overflow-y: auto;
            background: #FFFFFF;
            padding: 24px;
        }
        
        /* Task List Styles */
        .task-list-item {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .task-list-item:hover {
            border-color: #9333EA;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.1);
        }
        
        .task-list-item-left {
            flex: 1;
            min-width: 0;
        }
        
        .task-list-item-title {
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 8px;
        }
        
        .task-list-item-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }
        
        .task-list-item-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6B7280;
        }
        
        .task-list-item-tags {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .task-list-item-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .task-list-item-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            background: #E8D5F7;
            color: #9333EA;
        }
        
        .task-list-item-priority {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .task-list-item-priority.high {
            background: #FEE2E2;
            color: #DC2626;
        }
        
        .task-list-item-priority.medium {
            background: #FEF3C7;
            color: #D97706;
        }
        
        .task-list-item-priority.low {
            background: #D1FAE5;
            color: #059669;
        }
        
        .task-list-empty {
            text-align: center;
            padding: 60px 20px;
            color: #6B7280;
        }
        
        .task-list-empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .task-list-empty-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .task-list-empty-text {
            font-size: 14px;
            color: #6B7280;
        }
        
        /* Task Filter Bar */
        .task-filter-bar {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .task-filter-bar-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }
        
        .task-filter-left {
            flex: 1;
            min-width: 0;
        }
        
        .task-search-filter-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
            flex-wrap: nowrap;
        }
        
        .active-filters-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: nowrap;
        }
        
        .task-search-box {
            position: relative;
            display: flex;
            align-items: center;
            width: 300px;
        }
        
        .task-search-icon {
            position: absolute;
            left: 12px;
            color: #6B7280;
            pointer-events: none;
            z-index: 1;
            width: 16px;
            height: 16px;
        }
        
        .task-search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            background: white;
        }
        
        .task-search-input:focus {
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .task-search-input::placeholder {
            color: #9CA3AF;
        }
        
        .task-filter-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .task-filter-btn:hover {
            background: #F9FAFB;
        }
        
        .task-filter-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .task-add-btn {
            padding: 8px 16px;
            background: #9333EA;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .task-add-btn:hover {
            background: #7E22CE;
        }
        
        .active-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 0;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-tag {
            padding: 6px 12px;
            background: #9333EA;
            color: white;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .filter-tag-remove {
            cursor: pointer;
            font-weight: bold;
            color: white;
            margin-left: 4px;
            opacity: 0.9;
        }
        
        .filter-tag-remove:hover {
            opacity: 1;
        }
        
        .dropdown-filters {
            display: flex;
            gap: 12px;
        }
        
        .filter-dropdown {
            padding: 8px 12px;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            outline: none;
        }
        
        .filter-dropdown:focus {
            border-color: #2563EB;
        }
        
        .filter-dropdown-inline {
            padding: 8px 32px 8px 12px;
            font-size: 14px;
            min-width: 120px;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%236B7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }
        
        /* Kanban Board Styles */
        .kanban-container {
            padding: 32px;
            background: #F5F7FA;
            min-height: calc(100vh - 74px);
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .kanban-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .kanban-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #E5E7EB;
            flex-shrink: 0;
        }
        
        .kanban-header-left {
            flex: 1;
        }
        
        .kanban-title {
            font-size: 28px;
            font-weight: 700;
            color: #1F2937;
            margin: 0 0 8px 0;
        }
        
        .kanban-subtitle {
            font-size: 14px;
            color: #6B7280;
            margin: 0;
        }
        
        .kanban-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .kanban-search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .kanban-search-input {
            width: 250px;
            padding: 10px 16px 10px 40px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            color: #1F2937;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }
        
        .kanban-search-input::placeholder {
            color: #9CA3AF;
        }
        
        .kanban-search-input:focus {
            border-color: #2563EB;
            background: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .kanban-search-icon {
            position: absolute;
            left: 12px;
            color: #6B7280;
            pointer-events: none;
        }
        
        .kanban-add-btn {
            padding: 10px 20px;
            background: #2563EB;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .kanban-add-btn:hover {
            background: #1D4ED8;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px rgba(37, 99, 235, 0.25);
        }
        
        .kanban-board-container {
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            min-width: 0;
        }
        
        .kanban-board {
            display: flex;
            flex-direction: row;
            gap: 20px;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 20px;
            width: 100%;
            flex: 1;
            scroll-behavior: smooth;
            scrollbar-width: thin; /* Firefox */
            -ms-overflow-style: auto; /* IE and Edge */
            align-items: flex-start;
            flex-wrap: nowrap;
        }
        
        .kanban-board::-webkit-scrollbar {
            height: 8px; /* Chrome, Safari, Opera */
        }
        
        .kanban-board::-webkit-scrollbar-track {
            background: #F3F4F6;
        }
        
        .kanban-board::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 4px;
        }
        
        .kanban-board::-webkit-scrollbar-thumb:hover {
            background: #9CA3AF;
        }
        
        .kanban-column {
            flex: 0 0 320px;
            width: 320px;
            min-width: 320px;
            max-width: 320px;
            background: #FFFFFF;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
            max-height: calc(100vh - 200px);
            min-height: calc(100vh - 200px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #E5E7EB;
            margin-right: 0;
        }
        
        /* Unavailable column styling - visual only, not blocked */
        .kanban-column.column-unavailable {
            opacity: 1;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            position: relative;
        }
        
        .kanban-column.column-unavailable .kanban-column-header {
            opacity: 1;
        }
        
        .kanban-column.column-unavailable .kanban-column-title::after {
            content: '';
            display: none;
        }
        
        .kanban-column-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px;
            background: #F3E8FF;
            border-radius: 8px;
            flex-shrink: 0;
        }
        
        .kanban-column-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #1F2937;
        }
        
        .kanban-column-count {
            background: #9333EA;
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }
        
        .kanban-add-task-btn {
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            border-radius: 50%;
            color: #9333EA;
            font-size: 20px;
            font-weight: 300;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            line-height: 1;
        }
        
        .kanban-add-task-btn:hover {
            background: #E8D5F7;
            color: #7E22CE;
            transform: scale(1.1);
        }
        
        .kanban-add-task-btn:active {
            transform: scale(0.95);
        }
        
        .kanban-column-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 8px;
            min-height: 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .kanban-column-content::-webkit-scrollbar {
            display: none;
        }
        
        .kanban-task-card {
            background: #FFFFFF;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            margin-bottom: 12px;
        }
        
        .kanban-task-card:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .kanban-task-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(5deg);
        }
        
        .kanban-column-content.drag-over {
            background: rgba(37, 99, 235, 0.05);
            border: 2px dashed #2563EB;
            border-radius: 8px;
        }
        
        .kanban-task-title {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
            margin-bottom: 12px;
            line-height: 1.4;
        }
        
        .kanban-task-tags {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .task-tag {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .task-tag-status {
            background: white;
            color: #9333EA;
            border: 1px solid #E5E7EB;
        }
        
        .task-tag-project {
            background: #E8D5F7;
            color: #9333EA;
        }
        
        .kanban-task-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .kanban-task-priority {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            width: fit-content;
        }
        
        .kanban-task-priority.medium {
            background: #F59E0B;
            color: #FFFFFF;
        }
        
        .kanban-task-priority.high {
            background: #EF4444;
            color: #FFFFFF;
        }
        
        .kanban-task-priority.critical {
            background: #DC2626;
            color: #FFFFFF;
        }
        
        .kanban-task-priority.low {
            background: #10B981;
            color: #FFFFFF;
        }
        
        .kanban-task-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 0;
            border-top: none;
        }
        
        .kanban-task-date {
            font-size: 12px;
            color: #6B7280;
            display: flex;
            align-items: center;
        }
        
        .kanban-task-date svg {
            width: 14px;
            height: 14px;
            margin-right: 6px;
            flex-shrink: 0;
        }
        
        .kanban-task-assignees {
            display: flex;
            gap: -4px;
            align-items: center;
        }
        
        .kanban-assignee-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #2563EB;
            color: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            border: 2px solid #FFFFFF;
            margin-left: -4px;
        }
        
        .kanban-assignee-avatar:first-child {
            margin-left: 0;
        }
        
        .kanban-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9CA3AF;
            font-size: 14px;
        }
        
        .kanban-add-new-task-btn {
            display: none !important;
        }
        
        .kanban-add-new-task-btn::before {
            display: none;
        }
        
        .kanban-add-new-task-btn:hover {
            border-color: #9333EA;
            color: #9333EA;
            background: #FFFFFF;
        }
        
        /* Hidden Scrollbar for kanban columns */
        .kanban-column-content {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .kanban-column-content::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* Task Detail Modal Styles */
        .task-detail-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            overflow-y: auto;
        }
        
        .task-detail-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .task-detail-modal-content {
            background: #FFFFFF;
            border-radius: 12px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
        }
        
        .task-detail-header {
            padding: 24px 32px;
            border-bottom: 1px solid #E5E7EB;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #FFFFFF;
            border-radius: 12px 12px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .task-detail-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .task-detail-title {
            font-size: 24px;
            font-weight: 700;
            color: #1E40AF;
            margin: 0;
        }
        
        .task-detail-edit-icon {
            width: 20px;
            height: 20px;
            color: #9333EA;
            cursor: pointer;
        }
        
        .task-detail-close {
            font-size: 32px;
            font-weight: 300;
            color: #6B7280;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s;
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .task-detail-close:hover {
            color: #111827;
        }
        
        .task-detail-body {
            padding: 32px;
        }
        
        .task-detail-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .task-detail-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .task-detail-info-label {
            font-size: 12px;
            font-weight: 500;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .task-detail-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #1F2937;
        }
        
        .task-detail-section {
            margin-bottom: 32px;
        }
        
        .task-detail-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #1E40AF;
            margin-bottom: 16px;
        }
        
        .task-detail-assignees-table {
            width: 100%;
            border-collapse: collapse;
            background: #FFFFFF;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #E5E7EB;
        }
        
        .task-detail-assignees-table thead {
            background: #F9FAFB;
        }
        
        .task-detail-assignees-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .task-detail-assignees-table td {
            padding: 12px 16px;
            font-size: 14px;
            color: #1F2937;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .task-detail-assignees-table tr:last-child td {
            border-bottom: none;
        }
        
        .task-detail-assignee-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #2563EB;
            color: #FFFFFF;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .task-detail-footer {
            padding: 24px 32px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: #FFFFFF;
            border-radius: 0 0 12px 12px;
            position: sticky;
            bottom: 0;
        }
        
        .task-detail-btn-cancel {
            padding: 10px 24px;
            background: #F3F4F6;
            color: #6B7280;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .task-detail-btn-cancel:hover {
            background: #E5E7EB;
        }
        
        .task-detail-btn-save {
            padding: 10px 24px;
            background: #9333EA;
            color: #FFFFFF;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .task-detail-btn-save:hover {
            background: #7E22CE;
        }
        
        /* Calendar Page Styles */
        .calendar-page-container {
            padding: 12px 16px 0 16px;
            background: #FFFFFF;
            flex: 1 1 auto;
            min-height: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
        }
        
        .calendar-header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            flex-shrink: 0;
            padding: 0;
        }
        
        .calendar-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .calendar-today-btn {
            padding: 8px 16px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-today-btn:hover {
            background: #F9FAFB;
            border-color: #9333EA;
            color: #9333EA;
        }
        
        .calendar-nav-arrows {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .calendar-nav-arrow {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
        }
        
        .calendar-nav-arrow:hover {
            background: #F9FAFB;
            border-color: #9333EA;
            color: #9333EA;
        }
        
        .calendar-timezone {
            font-size: 12px;
            color: #6B7280;
            margin-top: 8px;
        }
        
        .calendar-view-toggle {
            display: flex;
            background: #F3F4F6;
            border-radius: 8px;
            padding: 4px;
            gap: 4px;
        }
        
        .calendar-view-btn {
            padding: 6px 16px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #6B7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-view-btn.active {
            background: #9333EA;
            color: #FFFFFF;
        }
        
        .calendar-week-view {
            display: flex;
            flex-direction: column;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            overflow: hidden;
            background: #FFFFFF;
            flex: 1 1 auto;
            min-height: 0;
            width: 100%;
            height: 100%;
        }
        
        .calendar-day-view {
            display: flex;
            flex-direction: column;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            overflow: hidden;
            background: #FFFFFF;
            flex: 1 1 auto;
            min-height: 0;
            width: 100%;
            height: 100%;
        }
        
        .calendar-month-view {
            display: flex;
            flex-direction: column;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            overflow: hidden;
            background: #FFFFFF;
            flex: 1 1 auto;
            min-height: 0;
            width: 100%;
            height: 100%;
        }
        
        .calendar-time-slots-container {
            flex: 1 1 auto;
            overflow: hidden;
            min-height: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .calendar-week-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            border-bottom: 1px solid #E5E7EB;
            background: #F9FAFB;
            flex-shrink: 0;
            min-height: 45px;
        }
        
        .calendar-time-column {
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 600;
            color: #6B7280;
            border-right: 1px solid #E5E7EB;
        }
        
        .calendar-day-header {
            padding: 8px 12px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            border-right: 1px solid #E5E7EB;
        }
        
        .calendar-day-header:last-child {
            border-right: none;
        }
        
        .calendar-day-header.highlighted {
            background: #E8D5F7;
            color: #9333EA;
        }
        
        .calendar-day-header-single {
            display: grid;
            grid-template-columns: 80px 1fr;
            border-bottom: 1px solid #E5E7EB;
            background: #F9FAFB;
            flex-shrink: 0;
        }
        
        .calendar-day-name {
            display: block;
            margin-bottom: 4px;
        }
        
        .calendar-day-date {
            display: block;
            font-size: 16px;
            font-weight: 700;
        }
        
        .calendar-time-slot {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            border-bottom: 1px solid #E5E7EB;
            min-height: 0;
            flex: 1 1 auto;
            position: relative;
        }
        
        .calendar-time-slot:last-child {
            border-bottom: none;
        }
        
        .calendar-time-label {
            padding: 4px 12px;
            font-size: 12px;
            color: #6B7280;
            border-right: 1px solid #E5E7EB;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
        }
        
        .calendar-day-cell {
            border-right: 1px solid #E5E7EB;
            padding: 0;
            position: relative;
            min-height: 0;
            height: 100%;
        }
        
        .calendar-day-cell:last-child {
            border-right: none;
        }
        
        .calendar-day-cell.highlighted {
            background: #F3E8FF;
        }
        
        .calendar-event {
            position: absolute;
            left: 0;
            right: 0;
            background: #F3F4F6;
            color: #1F2937;
            padding: 8px 12px;
            border-left: 4px solid #9333EA;
            border-radius: 0 4px 4px 0;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            z-index: 10;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .calendar-event:hover {
            background: #E5E7EB;
            z-index: 20;
        }
        
        .calendar-current-time-line {
            position: absolute;
            left: 80px;
            right: 0;
            height: 2px;
            background: #9333EA;
            z-index: 100;
            pointer-events: none;
        }
        
        .calendar-current-time-indicator {
            position: absolute;
            left: 60px;
            top: -8px;
            background: #9333EA;
            color: #FFFFFF;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            z-index: 101;
        }
        
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- Left Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-logo">Baap Company</div>
            <div class="sidebar-nav">
                <div class="nav-item active" onclick="switchPage('home', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 10L10 3L17 10M3 10V17H7V13H13V17H17V10M3 10L10 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="switchPage('inbox', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 5H17M3 5L10 11L17 5M3 5V15H17V5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span>Inbox</span>
                </div>
                <div class="nav-item" onclick="switchPage('projects', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 5H9L11 7H17V17H3V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span>Projects</span>
                </div>
                <div class="nav-item" onclick="switchPage('task-list', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 15L7 10L11 12L17 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="3" cy="15" r="1.5" fill="currentColor"/>
                            <circle cx="7" cy="10" r="1.5" fill="currentColor"/>
                            <circle cx="11" cy="12" r="1.5" fill="currentColor"/>
                            <circle cx="17" cy="6" r="1.5" fill="currentColor"/>
                        </svg>
                    </div>
                    <span>Tasks</span>
                </div>
                <div class="nav-item" onclick="switchPage('attendance', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="4" width="14" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M3 8H17M7 3V5M13 3V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="6" cy="11" r="1" fill="currentColor"/>
                            <circle cx="10" cy="11" r="1" fill="currentColor"/>
                            <circle cx="14" cy="11" r="1" fill="currentColor"/>
                            <circle cx="6" cy="14" r="1" fill="currentColor"/>
                            <circle cx="10" cy="14" r="1" fill="currentColor"/>
                            <circle cx="14" cy="14" r="1" fill="currentColor"/>
                        </svg>
                    </div>
                    <span>Attendance</span>
                </div>
                <div class="nav-item" onclick="switchPage('summary', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 17V13M7 17V9M11 17V11M15 17V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span>Summary</span>
                </div>
                <div class="nav-item" onclick="switchPage('meetings', event)">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M3 17V13M7 17V9M11 17V11M15 17V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <span>Meetings</span>
                </div>
                <div class="nav-item" onclick="switchPage('profile')">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="7" r="3" stroke="currentColor" stroke-width="2"/>
                            <path d="M5 17C5 14 7 12 10 12C13 12 15 14 15 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span>Profile</span>
                </div>
                <div class="nav-item" onclick="switchPage('settings')">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M10 2.5L10.5 4.5L12.5 4.5L13.5 6.5L15.5 6.5L16.5 10L15.5 13.5L13.5 13.5L12.5 15.5L10.5 15.5L10 17.5L9.5 15.5L7.5 15.5L6.5 13.5L4.5 13.5L3.5 10L4.5 6.5L6.5 6.5L7.5 4.5L9.5 4.5L10 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                            <circle cx="10" cy="10" r="2" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <span>Setting</span>
                </div>
                <div class="nav-item" onclick="switchPage('faq')">
                    <div class="nav-icon">
                        <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2"/>
                            <path d="M10 14V10M10 6H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                    </div>
                    <span>FAQ</span>
                </div>
            </div>
            <div class="sidebar-promo">
                <div class="sidebar-promo-title">Simplify Your Workflow</div>
                <ul class="sidebar-promo-list">
                    <li> Effective Management</li>
                    <li> Boost Your Productivity</li>
                    <li> Collaborate Anywhere</li>
                </ul>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Header -->
            <div class="top-header">
                <div class="header-left"></div>
                <div class="header-right">
                    <input type="text" class="search-box" placeholder="Search">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <div class="user-menu" onclick="showUserPayload()" style="position: relative;">
                            <img id="user-profile-image" src="https://i.pravatar.cc/80?img=12" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; box-shadow: 0 0 0 2px #ffffff; background: #E5E7EB;" onerror="this.onerror=null; this.src='https://i.pravatar.cc/80?img=12'; console.log('Profile image failed to load, using default');" crossorigin="anonymous">
                            <div id="user-online-status" style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: #10B981; border: 2px solid #ffffff; border-radius: 50%;"></div>
                        </div>
                        <div style="font-size: 14px; font-weight: 600; color: #1F2937;" id="current-time">09:42 AM</div>
                    </div>
                </div>
            </div>
            
            <div class="content">
                <!-- Home Page -->
                <div class="page active" id="page-home">
                    <!-- Top Row Buttons (Clock In / Clock Out / Break) -->
                    <div class="top-row">
                            <button class="btn btn-primary" id="btn-clock-in" onclick="clockIn()">
                                <span>Clock In</span>
                            <span class="btn-icon-circle">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="7" cy="7" r="5.5" stroke="white" stroke-width="1.5" fill="none"/>
                                    <line x1="7" y1="7" x2="7" y2="4" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                                    <line x1="7" y1="7" x2="9.5" y2="7" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </span>
                            </button>
                            <button class="btn btn-clock-out" id="btn-clock-out" onclick="clockOut()">
                                <span>Clock Out</span>
                            <span class="btn-icon-circle">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="2" y="2" width="8" height="8" stroke="white" stroke-width="1.5" fill="none" rx="1"/>
                                    <path d="M8 5L10 7L8 9" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                    <line x1="10" y1="7" x2="12" y2="7" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                                </svg>
                            </span>
                            </button>
                        <button class="btn btn-start-break" id="btn-start-break" onclick="startBreak()" style="margin-left: 24px;">
                                <span>Start Break</span>
                            <span class="btn-icon-circle dark">
                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M3 2L9 6L3 10V2Z" fill="#9333EA"/>
                                </svg>
                            </span>
                            </button>
                        <button class="btn btn-success" id="btn-end-break" onclick="endBreak()" style="display: none;">
                                <span>End Break</span>
                                <span class="btn-icon-circle"></span>
                            </button>
                    </div>
                    
                    <!-- Welcome Banner -->
                    <div class="welcome-banner">
                        <div class="welcome-content">
                            <div class="welcome-title" id="welcome-title">Good Morning, User</div>
                            <div class="welcome-subtitle">You have <span id="task-count" class="task-count-highlight">6</span> Task Today</div>
                            <button class="btn" onclick="switchPage('tasks')" style="background: white; color: #1E293B; border: none; font-weight: 500; padding: 10px 20px; border-radius: 8px; display: inline-flex; align-items: center; gap: 8px;">View Task <span style="font-size: 16px;"></span></button>
                        </div>
                        <div class="welcome-art">
                            <div class="welcome-art-circle c1"></div>
                            <div class="welcome-art-circle c2"></div>
                            <div class="welcome-art-circle c2b"></div>
                            <div class="welcome-art-circle c3"></div>
                            <div class="welcome-art-circle c3b"></div>
                        </div>
                    </div>
                    
                    <!-- Shift / Worked / Break Overview Cards -->
                    <div class="stats-grid">
                        <div class="stats-card">
                            <div class="stats-title" id="shift-name">General Shift</div>
                            <div class="stats-sub" id="shift-time">10:00 AM  07:00 PM</div>
                            <div class="stats-icon">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10" cy="7" r="3" stroke="currentColor" stroke-width="2"/>
                                    <path d="M5 17C5 14 7 12 10 12C13 12 15 14 15 17" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M13 6L14 7L16 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title" id="session-start-value">-</div>
                            <div class="stats-sub">Session Started At</div>
                            <div class="stats-icon">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="10" cy="10" r="7" stroke="currentColor" stroke-width="2"/>
                                    <path d="M10 6V10L13 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title-row">
                                <div class="stats-title" id="worked-today-value">00:00 hr</div>
                                <span class="stats-badge" id="worked-today-badge">0%</span>
                            </div>
                            <div class="stats-sub">Worked Today</div>
                            <div class="stats-icon">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 6H16V15H4V6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M7 6V4C7 3.44772 7.44772 3 8 3H12C12.5523 3 13 3.44772 13 4V6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    <path d="M10 9V12M8 10.5H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title-row">
                                <div class="stats-title" id="break-time-value">00:00 hr</div>
                                <span class="stats-badge" id="break-time-badge">0%</span>
                            </div>
                            <div class="stats-sub">Break Time</div>
                            <div class="stats-icon">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="4" y="6" width="12" height="8" rx="1" stroke="currentColor" stroke-width="2"/>
                                    <line x1="4" y1="10" x2="16" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Mouse Clicks and Keys Count -->
                    <div class="stats-grid" style="grid-template-columns: repeat(2, minmax(0, 1fr)); margin-bottom: 24px;">
                        <div class="stats-card">
                            <div class="stats-title" id="mouse-clicks-value">234</div>
                            <div class="stats-sub">Mouse Clicks</div>
                            <div class="stats-icon">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 5C5.44772 5 5 5.44772 5 6V12C5 12.5523 5.44772 13 6 13H14C14.5523 13 15 12.5523 15 12V6C15 5.44772 14.5523 5 14 5H6Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M5 6L10 4L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <line x1="10" y1="6" x2="10" y2="10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-title" id="keys-count-value">1241</div>
                            <div class="stats-sub">Keys Count</div>
                            <div class="stats-icon">
                                <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="3" y="5" width="14" height="10" rx="1.5" stroke="currentColor" stroke-width="2"/>
                                    <!-- Top Row: 10 equal keys -->
                                    <rect x="3.5" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="4.9" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="6.3" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="7.7" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="9.1" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="10.5" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="11.9" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="13.3" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="14.7" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="16.1" y="5.5" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <!-- Second Row: 1 wider + 8 equal keys -->
                                    <rect x="3.5" y="7.8" width="1.6" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="5.3" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="6.7" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="8.1" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="9.5" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="10.9" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="12.3" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="13.7" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="15.1" y="7.8" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <!-- Third Row: 1 wider + 7 equal keys -->
                                    <rect x="3.5" y="10.1" width="1.6" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="5.3" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="6.7" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="8.1" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="9.5" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="10.9" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="12.3" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="13.7" y="10.1" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <!-- Bottom Row: 1 wider + spacebar (wider) + 5 equal keys -->
                                    <rect x="3.5" y="12.4" width="1.6" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="5.3" y="12.4" width="3.5" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="9" y="12.4" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="10.4" y="12.4" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="11.8" y="12.4" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="13.2" y="12.4" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                    <rect x="14.6" y="12.4" width="1.2" height="1.8" rx="0.2" stroke="currentColor" stroke-width="1.5" fill="none"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Activity Snapshot (ERP-backed weekly hours chart) -->
                    <div class="widget-card" style="margin-bottom: 24px;">
                        <div class="chart-widget-header">
                            <div class="chart-widget-title">Activity Snapshot</div>
                            <div class="timeframe-selector" style="border-color: #DBEAFE; background: #EFF6FF; font-size: 13px; padding: 4px 10px; gap: 6px;">
                                <span>Daily</span>
                            </div>
                        </div>
                        <div class="stacked-bar-chart-container" style="height: 220px; margin-top: 8px;">
                            <svg class="stacked-bar-chart" id="stacked-bar-chart" viewBox="0 0 600 200">
                                <!-- Stacked bar chart will be rendered here -->
                            </svg>
                            <div class="activity-tooltip" id="activity-tooltip"></div>
                        </div>
                        <div class="activity-legend">
                            <div class="activity-legend-item">
                                <span class="activity-legend-dot" style="background:#A7F3D0;"></span>
                                <span>Active Time</span>
                                <span class="activity-legend-value" id="legend-active">0%</span>
                            </div>
                            <div class="activity-legend-item">
                                <span class="activity-legend-dot" style="background:#FECACA;"></span>
                                <span>Inactive Time</span>
                                <span class="activity-legend-value" id="legend-inactive">0%</span>
                            </div>
                            <div class="activity-legend-item">
                                <span class="activity-legend-dot" style="background:#FDE68A;"></span>
                                <span>Idle Time</span>
                                <span class="activity-legend-value" id="legend-idle">0%</span>
                            </div>
                            <div class="activity-legend-item">
                                <span class="activity-legend-dot" style="background:#93C5FD;"></span>
                                <span>On Break</span>
                                <span class="activity-legend-value" id="legend-break">0%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Application Usage Overview and Productivity Distribution -->
                    <div class="widget-grid">
                    <!-- Application Usage Overview -->
                    <div class="widget-card">
                        <div class="widget-title">Application Usage Overview</div>
                        <div id="app-usage-list" style="display: flex; flex-direction: column; gap: 12px;">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                        <!-- Productivity Distribution -->
                        <div class="widget-card">
                            <div class="widget-title">Productivity Distribution</div>
                            <div class="donut-chart-container">
                                <svg class="donut-chart" id="donut-chart" viewBox="0 0 200 200"></svg>
                                <div class="donut-legend" id="donut-legend" style="margin-left: 0; margin-top: 20px;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #E5E7EB;">
                                <div style="font-size: 12px; color: #6B7280; margin-bottom: 12px;">Top Websites</div>
                                <div id="top-websites-list" style="display: flex; flex-direction: column; gap: 8px;">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Today's Tasks -->
                    <div class="widget-card" style="margin-top: 24px;">
                        <div class="widget-title">Today's Tasks</div>
                        <div style="display: flex; gap: 12px; margin-bottom: 20px; border-bottom: 2px solid #F3F4F6;">
                            <button class="btn-small" style="border: none; background: none; padding: 10px 16px; color: #F59E0B; border-bottom: 2px solid #F59E0B; margin-bottom: -2px; cursor: pointer; font-weight: 600;">Upcoming</button>
                            <button class="btn-small" style="border: none; background: none; padding: 10px 16px; color: #6B7280; cursor: pointer; font-weight: 500;">In Progress</button>
                            <button class="btn-small" style="border: none; background: none; padding: 10px 16px; color: #6B7280; cursor: pointer; font-weight: 500;">Completed</button>
                        </div>
                        <div id="tasks-list" style="display: flex; flex-direction: column; gap: 16px;">
                            <div style="padding: 16px; border: 1px solid #E5E7EB; border-radius: 8px; display: flex; align-items: center; gap: 16px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">Redesign User Dashboard</div>
                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">UI Design   10  10</div>
                                    <span style="padding: 4px 12px; background: #FECACA; color: #DC2626; border-radius: 12px; font-size: 11px; font-weight: 600;">High</span>
                                </div>
                                <div style="font-size: 12px; color: #6B7280;">June 10, 2025</div>
                                <div style="display: flex; gap: -8px;">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%233B82F6'/%3E%3C/svg%3E" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;">
                                </div>
                            </div>
                            <div style="padding: 16px; border: 1px solid #E5E7EB; border-radius: 8px; display: flex; align-items: center; gap: 16px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">Update Mobile App Icons</div>
                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">Graphic Design   10  10</div>
                                    <span style="padding: 4px 12px; background: #FEF3C7; color: #D97706; border-radius: 12px; font-size: 11px; font-weight: 600;">Medium</span>
                                </div>
                                <div style="font-size: 12px; color: #6B7280;">June 10, 2025</div>
                                <div style="display: flex; gap: -8px;">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%2310B981'/%3E%3C/svg%3E" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;">
                                </div>
                            </div>
                            <div style="padding: 16px; border: 1px solid #E5E7EB; border-radius: 8px; display: flex; align-items: center; gap: 16px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">Create Promotional Email Template</div>
                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">Graphic Design   10  10</div>
                                    <span style="padding: 4px 12px; background: #D1FAE5; color: #059669; border-radius: 12px; font-size: 11px; font-weight: 600;">Low</span>
                                </div>
                                <div style="font-size: 12px; color: #6B7280;">June 10, 2025</div>
                                <div style="display: flex; gap: -8px;">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23F59E0B'/%3E%3C/svg%3E" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;">
                                </div>
                            </div>
                            <div style="padding: 16px; border: 1px solid #E5E7EB; border-radius: 8px; display: flex; align-items: center; gap: 16px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">Develop User Onboarding Flow</div>
                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">UI Design   10  10</div>
                                    <span style="padding: 4px 12px; background: #D1FAE5; color: #059669; border-radius: 12px; font-size: 11px; font-weight: 600;">Low</span>
                                </div>
                                <div style="font-size: 12px; color: #6B7280;">June 10, 2025</div>
                                <div style="display: flex; gap: -8px;">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%23EF4444'/%3E%3C/svg%3E" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;">
                                </div>
                            </div>
                            <div style="padding: 16px; border: 1px solid #E5E7EB; border-radius: 8px; display: flex; align-items: center; gap: 16px;">
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: #1F2937; margin-bottom: 4px;">Develop User Onboarding UI</div>
                                    <div style="font-size: 12px; color: #6B7280; margin-bottom: 8px;">UI Design   10  10</div>
                                    <span style="padding: 4px 12px; background: #D1FAE5; color: #059669; border-radius: 12px; font-size: 11px; font-weight: 600;">Low</span>
                                </div>
                                <div style="font-size: 12px; color: #6B7280;">June 10, 2025</div>
                                <div style="display: flex; gap: -8px;">
                                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32'%3E%3Ccircle cx='16' cy='16' r='16' fill='%239333EA'/%3E%3C/svg%3E" style="width: 32px; height: 32px; border-radius: 50%; border: 2px solid white;">
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 20px; margin-top: 24px; padding-top: 20px; border-top: 1px solid #E5E7EB;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #F59E0B;">08</div>
                                <div style="font-size: 12px; color: #6B7280;">Upcoming Tasks</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #3B82F6;">02</div>
                                <div style="font-size: 12px; color: #6B7280;">Tasks In Progress</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: #10B981;">05</div>
                                <div style="font-size: 12px; color: #6B7280;">Completed Tasks</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
        <!-- Attendance Page -->
        <div class="page" id="page-attendance">
                    <div class="widget-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div class="widget-title" style="margin: 0;">Attendance</div>
                            <div style="display: flex; gap: 10px;">
                        <button class="btn btn-small" onclick="showSummary()">Daily Summary</button>
                                <button class="btn btn-small" onclick="refreshAttendance()">Refresh</button>
                    </div>
                </div>
                
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 10px; font-weight: 500;">Work Periods (IST)</div>
                <div class="table-container">
                    <div class="table-header">
                        <div>Punch In (IST)</div>
                        <div>Punch Out (IST)</div>
                    </div>
                    <div id="work-periods"></div>
                </div>
                
                        <div style="font-size: 12px; color: #6B7280; margin-bottom: 10px; font-weight: 500; margin-top: 20px;">Breaks (IST)</div>
                <div class="table-container">
                    <div class="table-header">
                        <div>Break Start (IST)</div>
                        <div>Break End (IST)</div>
                    </div>
                    <div id="breaks"></div>
                </div>
            </div>
        </div>
        
                <!-- Other Pages -->
                <div class="page" id="page-inbox">
                    <div class="widget-card">
                        <div class="widget-title">Inbox</div>
                        <p style="color: #6B7280;">Inbox view coming soon...</p>
                    </div>
                </div>

                <div class="page" id="page-task-list">
                    <div style="padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div>
                                <h1 style="font-size: 28px; font-weight: 700; color: #1F2937; margin: 0 0 8px 0;">My Tasks</h1>
                                <p style="font-size: 14px; color: #6B7280; margin: 0;" id="taskCountSubtitle">Loading tasks...</p>
                            </div>
                            <button class="btn btn-small" onclick="refreshTasks()" style="padding: 10px 20px;"> Refresh</button>
                        </div>
                        <div id="tasks-list" style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; padding: 40px; color: #9CA3AF;">Loading tasks...</div>
                        </div>
                    </div>
                </div>
                
                <div class="page" id="page-tasks">
                    <div class="task-page-wrapper">
                        <!-- Main Content Area -->
                        <div class="task-main-content">
                            <!-- View Toggle and Search Bar at Top -->
                            <div class="task-view-toggle-container">
                                <div class="task-view-toggle-wrapper">
                                    <div class="task-view-toggle-group">
                                        <div class="view-toggle-btn active" onclick="switchTaskView('list')">
                                            <svg class="view-toggle-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
                                                <path d="M2 4h14M2 9h14M2 14h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            <span>List</span>
                                        </div>
                                        <div class="view-toggle-btn disabled" style="opacity: 0.5; cursor: not-allowed; pointer-events: none;" title="Calendar view is disabled">
                                            <svg class="view-toggle-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
                                                <rect x="2" y="3" width="14" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
                                                <path d="M2 7h14M5 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            <span>Calendar</span>
                                        </div>
                                        <div class="view-toggle-btn" onclick="switchTaskView('board')">
                                            <svg class="view-toggle-icon" width="18" height="18" viewBox="0 0 18 18" fill="none">
                                                <circle cx="9" cy="9" r="5" fill="currentColor"/>
                                            </svg>
                                            <span>Board</span>
                                        </div>
                                    </div>
                                    
                                    <div class="task-search-filter-row">
                                        <div class="task-search-box">
                                            <svg class="task-search-icon" width="16" height="16" viewBox="0 0 20 20" fill="none">
                                                <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18.5 18.5l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            </svg>
                                            <input type="text" placeholder="Search tasks by name, project, or assignee" class="task-search-input" id="taskSearchInput">
                                        </div>
                                        <button class="task-filter-btn" onclick="toggleFilterPanel()">
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none" style="margin-right: 6px;">
                                                <path d="M2 4h12M4 8h8M6 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                            </svg>
                                            <span>Filter</span>
                                        </button>
                                        <button class="task-add-btn" onclick="openAddTaskModal()">
                                            <span>Add Task</span>
                                            <span>+</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filter and Dropdowns Bar -->
                            <div class="task-filter-bar">
                                <div class="active-filters-row" id="activeFiltersRow">
                                    <div class="filter-tag">
                                        In Progress
                                        <span class="filter-tag-remove" onclick="removeFilter('status')"></span>
                                    </div>
                                    <select class="filter-dropdown filter-dropdown-inline" id="projectFilter" onchange="applyFilters()" onclick="loadProjectsIntoFilter()">
                                        <option value="">Project</option>
                                    </select>
                                    <select class="filter-dropdown filter-dropdown-inline" id="statusFilter" onchange="applyFilters()">
                                        <option value="">Status</option>
                                    </select>
                                    <select class="filter-dropdown filter-dropdown-inline" id="priorityFilter" onchange="applyFilters()">
                                        <option value="">Priority</option>
                                        <option value="low">Low</option>
                                        <option value="medium">Medium</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Task Calendar View (hidden by default) -->
                            <div id="taskCalendarContainer" style="display: none;">
                                <!-- Calendar will be rendered here -->
                            </div>
                            
                            <!-- Task List View (hidden by default) -->
                            <div id="taskListContainer" style="display: none;">
                                <div style="padding: 40px; text-align: center; color: #6B7280;">
                                    <div style="font-size: 16px; font-weight: 500; margin-bottom: 8px;">List View</div>
                                    <div style="font-size: 14px;">List view coming soon...</div>
                                </div>
                            </div>
                            
                            <!-- Kanban Board -->
                            <div class="kanban-board-container">
                                <div class="kanban-board" id="kanbanBoard">
                                <!-- New Column -->
                                <div class="kanban-column" data-status="new">
                                    <div class="kanban-column-header">
                                        <div class="kanban-column-title">
                                            <span>New</span>
                                            <span class="kanban-column-count" id="count-new">0</span>
                                        </div>
                                        <button class="kanban-add-task-btn" title="Add Task">+</button>
                                    </div>
                                    <div class="kanban-column-content" id="column-new">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                    <button class="kanban-add-new-task-btn" onclick="openAddTaskModal('new')">
                                        + Add New Task
                                    </button>
                                </div>
                                
                                <!-- In Progress Column -->
                                <div class="kanban-column" data-status="inprogress">
                                    <div class="kanban-column-header">
                                        <div class="kanban-column-title">
                                            <span>In Progress</span>
                                            <span class="kanban-column-count" id="count-inprogress">0</span>
                                        </div>
                                        <button class="kanban-add-task-btn" title="Add Task">+</button>
                                    </div>
                                    <div class="kanban-column-content" id="column-inprogress">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                    <button class="kanban-add-new-task-btn" onclick="openAddTaskModal('inprogress')">
                                        + Add New Task
                                    </button>
                                </div>
                                
                                <!-- Testing Column -->
                                <div class="kanban-column" data-status="testing">
                                    <div class="kanban-column-header">
                                        <div class="kanban-column-title">
                                            <span>Testing</span>
                                            <span class="kanban-column-count" id="count-testing">0</span>
                                        </div>
                                        <button class="kanban-add-task-btn" title="Add Task">+</button>
                                    </div>
                                    <div class="kanban-column-content" id="column-testing">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                    <button class="kanban-add-new-task-btn" onclick="openAddTaskModal('testing')">
                                        + Add New Task
                                    </button>
                                </div>
                                
                                <!-- Released to prod Column -->
                                <div class="kanban-column" data-status="releasedtoprod">
                                    <div class="kanban-column-header">
                                        <div class="kanban-column-title">
                                            <span>Released to prod</span>
                                            <span class="kanban-column-count" id="count-releasedtoprod">0</span>
                                        </div>
                                        <button class="kanban-add-task-btn" title="Add Task">+</button>
                                    </div>
                                    <div class="kanban-column-content" id="column-releasedtoprod">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                    <button class="kanban-add-new-task-btn" onclick="openAddTaskModal('releasedtoprod')">
                                        + Add New Task
                                    </button>
                                </div>
                                
                                <!-- Closed Column -->
                                <div class="kanban-column" data-status="closed">
                                    <div class="kanban-column-header">
                                        <div class="kanban-column-title">
                                            <span>Closed</span>
                                            <span class="kanban-column-count" id="count-closed">0</span>
                                        </div>
                                        <button class="kanban-add-task-btn" title="Add Task">+</button>
                                    </div>
                                    <div class="kanban-column-content" id="column-closed">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                    <button class="kanban-add-new-task-btn" onclick="openAddTaskModal('closed')">
                                        + Add New Task
                                    </button>
                                </div>
                                
                                <!-- Blocked Column -->
                                <div class="kanban-column" data-status="blocked">
                                    <div class="kanban-column-header">
                                        <div class="kanban-column-title">
                                            <span>Blocked</span>
                                            <span class="kanban-column-count" id="count-blocked">0</span>
                                        </div>
                                        <button class="kanban-add-task-btn" title="Add Task">+</button>
                                    </div>
                                    <div class="kanban-column-content" id="column-blocked">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                    <button class="kanban-add-new-task-btn" onclick="openAddTaskModal('blocked')">
                                        + Add New Task
                                    </button>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Page -->
                <div class="page" id="page-calendar">
                    <div class="calendar-page-container">
                        <div class="calendar-header-controls">
                            <div class="calendar-header-left">
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <button class="calendar-today-btn" onclick="goToToday()">Today</button>
                                        <div class="calendar-nav-arrows">
                                            <button class="calendar-nav-arrow" onclick="previousWeek()"></button>
                                            <button class="calendar-nav-arrow" onclick="nextWeek()"></button>
                                        </div>
                                    </div>
                                    <div class="calendar-timezone">GMT+7</div>
                                </div>
                            </div>
                            <div class="calendar-view-toggle">
                                <button class="calendar-view-btn" onclick="switchCalendarView('day')">Day</button>
                                <button class="calendar-view-btn active" onclick="switchCalendarView('week')">Week</button>
                                <button class="calendar-view-btn" onclick="switchCalendarView('month')">Month</button>
                            </div>
                        </div>
                        
                        <!-- Week View -->
                        <div class="calendar-week-view" id="calendarWeekView">
                            <div class="calendar-week-header">
                                <div class="calendar-time-column"></div>
                                <div class="calendar-day-header" id="day-0">
                                    <span class="calendar-day-name">Monday</span>
                                    <span class="calendar-day-date" id="date-0">2</span>
                                </div>
                                <div class="calendar-day-header" id="day-1">
                                    <span class="calendar-day-name">Tuesday</span>
                                    <span class="calendar-day-date" id="date-1">3</span>
                                </div>
                                <div class="calendar-day-header" id="day-2">
                                    <span class="calendar-day-name">Wednesday</span>
                                    <span class="calendar-day-date" id="date-2">4</span>
                                </div>
                                <div class="calendar-day-header" id="day-3">
                                    <span class="calendar-day-name">Thursday</span>
                                    <span class="calendar-day-date" id="date-3">5</span>
                                </div>
                                <div class="calendar-day-header" id="day-4">
                                    <span class="calendar-day-name">Friday</span>
                                    <span class="calendar-day-date" id="date-4">6</span>
                                </div>
                                <div class="calendar-day-header" id="day-5">
                                    <span class="calendar-day-name">Saturday</span>
                                    <span class="calendar-day-date" id="date-5">7</span>
                                </div>
                                <div class="calendar-day-header" id="day-6">
                                    <span class="calendar-day-name">Sunday</span>
                                    <span class="calendar-day-date" id="date-6">8</span>
                                </div>
                            </div>
                            <div class="calendar-time-slots-container" id="calendarTimeSlots">
                                <!-- Time slots will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Day View -->
                        <div class="calendar-day-view" id="calendarDayView" style="display: none;">
                            <div class="calendar-day-header-single" id="calendarDayHeader">
                                <div class="calendar-time-column"></div>
                                <div class="calendar-day-header" id="single-day-header">
                                    <span class="calendar-day-name" id="single-day-name">Monday</span>
                                    <span class="calendar-day-date" id="single-day-date">22</span>
                                </div>
                            </div>
                            <div class="calendar-time-slots-container" id="calendarDayTimeSlots">
                                <!-- Time slots will be generated here -->
                            </div>
                        </div>
                        
                        <!-- Month View -->
                        <div class="calendar-month-view" id="calendarMonthView" style="display: none;">
                            <div id="calendarMonthGrid">
                                <!-- Month grid will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="page" id="page-summary">
                    <div class="widget-card">
                        <div class="widget-title">Summary</div>
                        <p style="color: #6B7280;">Summary view coming soon...</p>
                    </div>
                </div>
                
                <div class="page" id="page-meetings">
                    <div class="widget-card">
                        <div class="widget-title">Meetings</div>
                        <div style="text-align: center; color: #6B7280; padding: 40px;">
                            Loading meetings...
                        </div>
                    </div>
                </div>
                
                <div class="page" id="page-messages">
                    <div class="widget-card">
                        <div class="widget-title">Messages</div>
                        <p style="color: #6B7280;">Messages view coming soon...</p>
                    </div>
                </div>
                
                <div class="page" id="page-profile">
                    <div class="widget-card">
                        <div class="widget-title">Profile</div>
                        <p style="color: #6B7280;">Profile settings coming soon...</p>
                    </div>
                </div>
                
                <div class="page" id="page-settings">
                    <div class="widget-card">
                        <div class="widget-title">Settings</div>
                        <p style="color: #6B7280;">Settings coming soon...</p>
                    </div>
                </div>
                
                <!-- Project Dashboard Page -->
                <div class="page" id="page-projects">
                    <div class="project-dashboard-container">
                        <div class="project-dashboard-header">
                            <div class="project-header-left">
                                <h1 class="project-dashboard-title">Project Dashboard</h1>
                                <p class="project-dashboard-subtitle">Manage and track all projects in your system.</p>
                            </div>
                            <div class="project-header-right">
                                <div class="project-search-box">
                                    <input type="text" placeholder="Search projects" class="project-search-input">
                                    <svg class="project-search-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                                        <path d="M9 17A8 8 0 1 0 9 1a8 8 0 0 0 0 16zM18.5 18.5l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <button class="project-new-btn" onclick="openNewProjectModal()">+ New</button>
                            </div>
                        </div>
                        
                        <div class="project-grid" id="projectGrid">
                            <!-- Projects will be dynamically loaded here -->
                        </div>
                    </div>
                </div>
                
                <div class="page" id="page-faq">
                    <div class="widget-card">
                        <div class="widget-title">FAQ</div>
                        <p style="color: #6B7280;">Frequently asked questions coming soon...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- New Project Modal -->
        <div class="modal" id="newProjectModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Create New Project</h2>
                    <span class="modal-close" onclick="closeNewProjectModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="newProjectForm" onsubmit="handleCreateProject(event)">
                        <div class="form-group">
                            <label for="projectName">Project Name *</label>
                            <input type="text" id="projectName" name="projectName" required placeholder="Enter project name">
                        </div>
                        
                        <div class="form-group">
                            <label for="projectDetails">Project Details</label>
                            <textarea id="projectDetails" name="projectDetails" rows="4" placeholder="Enter project details (optional)"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="projectType">Project Type *</label>
                            <select id="projectType" name="projectType" required>
                                <option value="software">Software</option>
                                <option value="hardware">Hardware</option>
                                <option value="consulting">Consulting</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="projectVisibility">Visibility *</label>
                            <select id="projectVisibility" name="projectVisibility" required>
                                <option value="private">Private</option>
                                <option value="public">Public</option>
                            </select>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" onclick="closeNewProjectModal()">Cancel</button>
                            <button type="submit" class="btn-primary">Create Project</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Right Sidebar -->
        <div class="right-sidebar">
            <!-- Messages (1st) -->
            <div class="sidebar-widget">
                <div class="sidebar-widget-title">Messages</div>
                <div id="messages-list">
                    <div class="list-item">
                        <div class="list-item-title">Olivia Johnson</div>
                        <div class="list-item-time">9:47 AM: I've updated the project briefs.</div>
                    </div>
                    <div class="list-item">
                        <div class="list-item-title">Mark Thompson</div>
                        <div class="list-item-time">9:10 AM: Hey, I just wanted to check in ab...</div>
                    </div>
                    <div class="list-item">
                        <div class="list-item-title">Ava Chen</div>
                        <div class="list-item-time">10:00 AM: Can you help me installation...</div>
                    </div>
                </div>
            </div>

            <!-- Announcement (2nd) -->
            <div class="sidebar-widget">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div class="sidebar-widget-title" style="margin: 0;">Announcements</div>
                    <button class="btn btn-small" onclick="refreshNotices()" style="padding: 4px 12px; font-size: 12px;">Refresh</button>
                </div>
                <div id="notices-list" style="min-height: 100px;">
                    <div style="text-align: center; color: #9CA3AF; padding: 20px;">No announcements</div>
                </div>
            </div>

            <!-- Schedule (3rd) with Calendar + events -->
            <div class="sidebar-widget schedule-widget">
                <div class="sidebar-widget-title">Schedule</div>
                <!-- Calendar -->
                <div class="calendar-header" style="margin-top: 8px;">
                    <button class="calendar-nav" onclick="prevMonth()"></button>
                    <div id="calendar-month">May 2025</div>
                    <button class="calendar-nav" onclick="nextMonth()"></button>
                </div>
                <div class="calendar-grid" id="calendar-grid" style="margin-top: 8px;">
                    <!-- Calendar will be generated by JavaScript -->
                </div>
                <!-- Events -->
                <div id="schedule-list" style="margin-top: 16px;">
                    <div style="text-align: center; color: #9CA3AF; padding: 20px;">Loading meetings...</div>
                </div>
            </div>

            <!-- Reminder (4th) -->
            <div class="sidebar-widget">
                <div class="sidebar-widget-title">Reminder</div>
                <div id="reminder-list">
                    <div class="list-item">
                        <div class="list-item-title">Prepare Presentation For Stakeholders' Meeting</div>
                        <div class="list-item-time">5 May</div>
                    </div>
                    <div class="list-item">
                        <div class="list-item-title">Review Software License</div>
                        <div class="list-item-time">13 May</div>
                    </div>
                    <div class="list-item">
                        <div class="list-item-title">Organize Team Building Event</div>
                        <div class="list-item-time">15 May</div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity (bottom) -->
            <div class="sidebar-widget">
                <div class="sidebar-widget-title">Recent Activity</div>
                <div id="activity-list">
                    <div class="list-item">
                        <div class="list-item-title">Admin added a new user, Sofia Patel, to the system.</div>
                        <div class="list-item-time">4:15 PM</div>
                    </div>
                    <div class="list-item">
                        <div class="list-item-title">Lucas Garcia updated the status of Project Phoenix to 'In Progress'</div>
                        <div class="list-item-time">9:00 AM</div>
                    </div>
                    <div class="list-item">
                        <div class="list-item-title">Noah Milan uploaded 'Q1 Financial Report.xlsx'</div>
                        <div class="list-item-time">9:00 AM</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Sidebar Toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('.main-content');
            const overlay = document.getElementById('sidebar-overlay');
            
            if (sidebar && mainContent) {
                sidebar.classList.toggle('hidden');
                mainContent.classList.toggle('sidebar-hidden');
                if (overlay) {
                    overlay.classList.toggle('show');
                }
            }
        }

        // --- User greeting state ---
        let currentUserFirstName = '';
        let currentUserLastName = '';

        function getGreetingForHour(hour) {
            if (hour >= 5 && hour < 12) return 'Good Morning';
            if (hour >= 12 && hour < 17) return 'Good Afternoon';
            if (hour >= 17 && hour < 21) return 'Good Evening';
            return 'Good Night';
        }

        function updateGreetingBanner() {
            try {
                const titleEl = document.getElementById('welcome-title');
                if (!titleEl) return;
                const now = new Date();
                const greeting = getGreetingForHour(now.getHours());
                const fullName = (currentUserFirstName + ' ' + currentUserLastName).trim() || 'User';
                titleEl.textContent = `${greeting}, ${fullName}`;
            } catch (e) {
                console.error('Error updating greeting banner:', e);
            }
        }
        
        // Page navigation
        let currentPage = 'home';
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        
        // Switch page function
        function switchPage(page, eventParam) {
            console.log(`[PAGE NAV] Switching to page: ${page}`);
            
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            // Show selected page
            const pageElement = document.getElementById(`page-${page}`);
            if (pageElement) {
                pageElement.classList.add('active');
                console.log(`[PAGE NAV] Page ${page} activated`);
            } else {
                console.error(`[PAGE NAV] Page element not found: page-${page}`);
            }
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Find and activate the clicked nav item
            const event = eventParam || window.event;
            let clickedNavItem = null;
            
            if (event) {
                clickedNavItem = event.target?.closest('.nav-item');
            }
            
            if (clickedNavItem) {
                clickedNavItem.classList.add('active');
            } else {
                // Fallback: find nav item by page name
                const navItems = document.querySelectorAll('.nav-item');
                navItems.forEach(item => {
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'${page}'`)) {
                        item.classList.add('active');
                    }
                });
            }
            
            currentPage = page;
            
            // Special handling for specific pages
            if (page === 'attendance') {
                try {
                    if (pywebview && pywebview.api && pywebview.api.refresh_attendance) {
                        pywebview.api.refresh_attendance();
                    }
                } catch (e) {
                    console.error('Error refreshing attendance:', e);
                }
            }
            
            // Load appointments when switching to meetings page
            if (page === 'meetings') {
                loadAppointmentsForMeetingsPage();
            }
            
            // Refresh appointments in schedule widget when switching to home page
            if (page === 'home') {
                setTimeout(() => {
                    renderAppointmentsInSchedule().catch(err => {
                        console.error('[APPOINTMENTS] Error refreshing appointments on home:', err);
                    });
                }, 500);
            }
            
            // Initialize calendar if switching to calendar page
            if (page === 'calendar') {
                console.log('[PAGE NAV] Initializing calendar...');
                setTimeout(() => {
                    try {
                        if (typeof initCalendar === 'function') {
                            initCalendar();
                            console.log('[PAGE NAV] Calendar initialized successfully');
                        } else {
                            console.error('[PAGE NAV] initCalendar function not found');
                            // Try to initialize manually
                            if (typeof initCalendarWeek === 'function' && 
                                typeof updateCalendarHeaders === 'function' && 
                                typeof renderCalendarTimeSlots === 'function') {
                                console.log('[PAGE NAV] Initializing calendar manually...');
                                initCalendarWeek();
                                updateCalendarHeaders();
                                renderCalendarTimeSlots();
                            }
                        }
                    } catch (error) {
                        console.error('[PAGE NAV] Error initializing calendar:', error);
                    }
                }, 200);
            }
        }
        
        // Make switchPage available globally
        window.switchPage = switchPage;
        
        // Appointments functions
        let allAppointments = [];
        
        // Format appointment date and time for display
        function formatAppointmentDateTime(dateTimeStr) {
            if (!dateTimeStr) return '';
            try {
                const date = new Date(dateTimeStr);
                if (isNaN(date.getTime())) return dateTimeStr;
                
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const month = months[date.getMonth()];
                const day = date.getDate();
                
                let hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12;
                hours = hours ? hours : 12; // the hour '0' should be '12'
                const minutesStr = minutes < 10 ? '0' + minutes : minutes;
                
                return `${day} ${month}, ${hours}:${minutesStr} ${ampm}`;
            } catch (e) {
                return dateTimeStr;
            }
        }
        
        // Load appointments from API
        async function loadAppointments(page = 1, limit = 10) {
            try {
                console.log('[APPOINTMENTS] Loading appointments...');
                const result = await pywebview.api.fetch_appointments(page, limit);
                console.log('[APPOINTMENTS] API Response:', result);
                
                if (result && result.success && result.appointments) {
                    allAppointments = result.appointments;
                    console.log(`[APPOINTMENTS] Successfully loaded ${allAppointments.length} appointments`);
                    return allAppointments;
                } else {
                    console.warn('[APPOINTMENTS] No appointments found or API call failed:', result);
                    allAppointments = [];
                    return [];
                }
            } catch (error) {
                console.error('[APPOINTMENTS] Error loading appointments:', error);
                allAppointments = [];
                return [];
            }
        }
        
        // Render appointments in the Schedule widget (sidebar)
        async function renderAppointmentsInSchedule() {
            const scheduleList = document.getElementById('schedule-list');
            if (!scheduleList) {
                console.warn('[APPOINTMENTS] Schedule list element not found');
                return;
            }
            
            // Show loading state
            scheduleList.innerHTML = `
                <div style="text-align: center; color: #9CA3AF; padding: 20px;">
                    Loading meetings...
                </div>
            `;
            
            // Always load fresh appointments
            try {
                await loadAppointments(1, 10);
            } catch (error) {
                console.error('[APPOINTMENTS] Error loading appointments:', error);
                scheduleList.innerHTML = `
                    <div style="text-align: center; color: #9CA3AF; padding: 20px;">
                        No upcoming meetings
                    </div>
                `;
                return;
            }
            
            if (allAppointments.length === 0) {
                scheduleList.innerHTML = `
                    <div style="text-align: center; color: #9CA3AF; padding: 20px;">
                        No upcoming meetings
                    </div>
                `;
                return;
            }
            
            // Sort appointments by date/time (upcoming first)
            const sortedAppointments = [...allAppointments].sort((a, b) => {
                const dateA = new Date(a.appointment_date || a.date || a.start_time || a.startTime || 0);
                const dateB = new Date(b.appointment_date || b.date || b.start_time || b.startTime || 0);
                return dateA - dateB;
            });
            
            // Show only upcoming appointments (limit to 5 for sidebar)
            const upcomingAppointments = sortedAppointments
                .filter(apt => {
                    const aptDate = new Date(apt.appointment_date || apt.date || apt.start_time || apt.startTime || 0);
                    return aptDate >= new Date();
                })
                .slice(0, 5);
            
            if (upcomingAppointments.length === 0) {
                scheduleList.innerHTML = `
                    <div style="text-align: center; color: #9CA3AF; padding: 20px;">
                        No upcoming meetings
                    </div>
                `;
                return;
            }
            
            // Render appointments
            scheduleList.innerHTML = upcomingAppointments.map(apt => {
                const title = apt.appointment_title || apt.title || apt.meeting_title || apt.name || 'Meeting';
                const dateTime = apt.appointment_date || apt.date || apt.start_time || apt.startTime || apt.appointment_time || '';
                const formattedDateTime = formatAppointmentDateTime(dateTime);
                
                return `
                    <div class="list-item">
                        <div class="list-item-title">${title}</div>
                        <div class="list-item-time">${formattedDateTime}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Make renderAppointmentsInSchedule globally accessible
        window.renderAppointmentsInSchedule = renderAppointmentsInSchedule;
        window.loadAppointments = loadAppointments;
        
        // Load and render appointments in Meetings page
        async function loadAppointmentsForMeetingsPage() {
            const meetingsPage = document.getElementById('page-meetings');
            if (!meetingsPage) {
                console.warn('[APPOINTMENTS] Meetings page element not found');
                return;
            }
            
            // Show loading state
            meetingsPage.innerHTML = `
                <div class="widget-card">
                    <div class="widget-title">Meetings</div>
                    <div style="text-align: center; color: #6B7280; padding: 40px;">
                        Loading meetings...
                    </div>
                </div>
            `;
            
            try {
                const appointments = await loadAppointments(1, 50);
                
                if (appointments.length === 0) {
                    meetingsPage.innerHTML = `
                        <div class="widget-card">
                            <div class="widget-title">Meetings</div>
                            <div style="text-align: center; color: #6B7280; padding: 40px;">
                                No meetings scheduled
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Sort appointments by date/time
                const sortedAppointments = [...appointments].sort((a, b) => {
                    const dateA = new Date(a.appointment_date || a.date || a.start_time || a.startTime || 0);
                    const dateB = new Date(b.appointment_date || b.date || b.start_time || b.startTime || 0);
                    return dateA - dateB;
                });
                
                // Group appointments by date
                const groupedByDate = {};
                sortedAppointments.forEach(apt => {
                    const dateTime = apt.appointment_date || apt.date || apt.start_time || apt.startTime || apt.appointment_time || '';
                    const date = new Date(dateTime);
                    const dateKey = date.toDateString();
                    
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(apt);
                });
                
                // Render grouped appointments
                const meetingsHTML = Object.keys(groupedByDate).map(dateKey => {
                    const appointmentsForDate = groupedByDate[dateKey];
                    const date = new Date(dateKey);
                    const formattedDate = date.toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                    
                    const appointmentsList = appointmentsForDate.map(apt => {
                        const title = apt.appointment_title || apt.title || apt.meeting_title || apt.name || 'Meeting';
                        const dateTime = apt.appointment_date || apt.date || apt.start_time || apt.startTime || apt.appointment_time || '';
                        const formattedDateTime = formatAppointmentDateTime(dateTime);
                        const description = apt.description || apt.appointment_description || apt.notes || '';
                        
                        return `
                            <div class="list-item" style="padding: 16px; border-bottom: 1px solid #E5E7EB;">
                                <div class="list-item-title">${title}</div>
                                <div class="list-item-time">${formattedDateTime}</div>
                                ${description ? `<div style="font-size: 12px; color: #6B7280; margin-top: 4px;">${description}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div style="margin-bottom: 32px;">
                            <div style="font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 12px;">
                                ${formattedDate}
                            </div>
                            ${appointmentsList}
                        </div>
                    `;
                }).join('');
                
                meetingsPage.innerHTML = `
                    <div class="widget-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <div class="widget-title">Meetings</div>
                            <button class="btn btn-small" onclick="loadAppointmentsForMeetingsPage()">Refresh</button>
                        </div>
                        <div>
                            ${meetingsHTML}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('[APPOINTMENTS] Error loading meetings page:', error);
                meetingsPage.innerHTML = `
                    <div class="widget-card">
                        <div class="widget-title">Meetings</div>
                        <div style="text-align: center; color: #EF4444; padding: 40px;">
                            Error loading meetings. Please try again.
                        </div>
                    </div>
                `;
            }
        }
        
        // Load and display projects
        let allProjects = [];
        
        async function loadProjects(searchQuery = '') {
            const projectGrid = document.getElementById('projectGrid');
            if (!projectGrid) return;
            
            // Show loading state
            projectGrid.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6B7280;">
                    <div style="font-size: 16px; font-weight: 500;">Loading projects...</div>
                </div>
            `;
            
            try {
                // Fetch projects from API
                const result = await pywebview.api.fetch_projects();
                console.log('API Response:', result);
                
                // Check if we got a successful response
                if (result && result.success) {
                    let projects = [];
                    
                    // Try different response structures
                    // Check result.data.data first (API wraps response in data)
                    if (result.data && result.data.data && Array.isArray(result.data.data)) {
                        projects = result.data.data;
                        console.log('Projects from result.data.data (array)');
                    } else if (result.data && result.data.data && result.data.data.projects) {
                        projects = result.data.data.projects;
                        console.log('Projects from result.data.data.projects');
                    } else if (result.data && Array.isArray(result.data)) {
                        projects = result.data;
                        console.log('Projects from result.data (array)');
                    } else if (result.data && result.data.projects) {
                        projects = result.data.projects;
                        console.log('Projects from result.data.projects');
                    } else if (result.projects) {
                        projects = result.projects;
                        console.log('Projects from result.projects');
                    }
                    
                    console.log('Extracted projects:', projects);
                    
                    if (projects && projects.length > 0) {
                        allProjects = projects.map(p => ({
                            id: p.project_id || p.id,
                            name: p.project_name || p.name || 'Unnamed Project',
                            tasks: p.task_count || p.tasks || 0,
                            details: p.project_details || p.details || '',
                            type: p.project_type || p.type || 'software',
                            visibility: p.visibility || 'private'
                        }));
                        console.log('Processed projects:', allProjects);
                    } else {
                        console.warn('No projects found in response');
                        allProjects = [];
                    }
                } else {
                    console.error('API call failed:', result);
                    allProjects = [];
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                allProjects = [];
            }
            
            // Filter projects based on search query
            const filteredProjects = allProjects.filter(project => 
                project.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
            
            if (filteredProjects.length === 0) {
                const message = searchQuery 
                    ? 'No projects found matching your search' 
                    : allProjects.length === 0 
                        ? 'No projects yet. Click "+ New" to create your first project.' 
                        : 'No projects found';
                        
                projectGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 40px;">
                        <div style="color: #6B7280; font-size: 16px; margin-bottom: 16px; font-weight: 500;">
                            ${message}
                        </div>
                        ${allProjects.length === 0 ? `
                            <button class="project-new-btn" onclick="openNewProjectModal()" style="margin-top: 16px;">
                                + Create First Project
                            </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            projectGrid.innerHTML = filteredProjects.map(project => `
                <div class="project-card" onclick="openProjectTasks('${project.id}', '${project.name.replace(/'/g, "\\'")}')">
                    <div class="project-card-header">
                        <h3 class="project-name">${project.name}</h3>
                        <button class="project-menu-btn" onclick="event.stopPropagation()"></button>
                    </div>
                    <div class="project-tasks">
                        <span class="project-task-count">${project.tasks}</span>
                        <span class="project-task-label">Tasks</span>
                    </div>
                </div>
            `).join('');
        }
        
        // Setup project search
        function setupProjectSearch() {
            const searchInput = document.querySelector('.project-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    loadProjects(e.target.value);
                });
            }
        }
        
        // Load task statuses into dropdown
        async function loadTaskStatuses() {
            const statusFilter = document.getElementById('statusFilter');
            if (!statusFilter) {
                console.warn('[STATUS FILTER] Status filter dropdown not found');
                return;
            }
            
            console.log('[STATUS FILTER] Loading task statuses into dropdown...');
            
            try {
                // Fetch statuses from API
                const result = await pywebview.api.fetch_task_statuses(1, 10);
                console.log('[STATUS FILTER] API Response:', result);
                
                if (result && result.success && result.statuses && result.statuses.length > 0) {
                    // Clear existing options except the first "Status" option
                    statusFilter.innerHTML = '<option value="">Status</option>';
                    
                    // Add statuses from API
                    result.statuses.forEach(status => {
                        // Try multiple ways to extract status name and value
                        const statusName = status.status_name || 
                                         status.name || 
                                         status.task_status_name ||
                                         status.status ||
                                         'Unknown Status';
                        
                        const statusId = status.status_id || 
                                        status.id || 
                                        status.task_status_id ||
                                        statusName.toLowerCase().replace(/\s+/g, '');
                        
                        // Create option element
                        const option = document.createElement('option');
                        option.value = statusId;
                        option.textContent = statusName;
                        statusFilter.appendChild(option);
                        
                        console.log(`[STATUS FILTER] Added status: ${statusName} (value: ${statusId})`);
                    });
                    
                    console.log(`[STATUS FILTER] SUCCESS: Loaded ${result.statuses.length} task statuses`);
                } else {
                    console.warn('[STATUS FILTER] No statuses found in response or API call failed');
                    console.warn('[STATUS FILTER] Response:', result);
                    // Keep default hardcoded options as fallback
                }
            } catch (error) {
                console.error('[STATUS FILTER] Error loading task statuses:', error);
                // Keep default hardcoded options as fallback
            }
        }
        
        // Load projects into filter dropdown
        async function loadProjectsIntoFilter() {
            const projectFilter = document.getElementById('projectFilter');
            if (!projectFilter) {
                console.warn('[PROJECT FILTER] Project filter dropdown not found');
                return;
            }
            
            console.log('[PROJECT FILTER] Loading projects into filter dropdown...');
            
            // If projects are already loaded, use them
            if (allProjects && allProjects.length > 0) {
                console.log('[PROJECT FILTER] Using cached projects:', allProjects.length);
                populateProjectFilter(projectFilter, allProjects);
                return;
            }
            
            // Otherwise, fetch from API
            try {
                console.log('[PROJECT FILTER] Fetching projects from API...');
                const result = await pywebview.api.fetch_projects();
                console.log('[PROJECT FILTER] API Response:', result);
                
                if (result && result.success) {
                    let projects = [];
                    
                    // Try different response structures
                    if (result.data && result.data.data && Array.isArray(result.data.data)) {
                        projects = result.data.data;
                        console.log('[PROJECT FILTER] Projects from result.data.data (array)');
                    } else if (result.data && result.data.data && result.data.data.projects) {
                        projects = result.data.data.projects;
                        console.log('[PROJECT FILTER] Projects from result.data.data.projects');
                    } else if (result.data && Array.isArray(result.data)) {
                        projects = result.data;
                        console.log('[PROJECT FILTER] Projects from result.data (array)');
                    } else if (result.data && result.data.projects) {
                        projects = result.data.projects;
                        console.log('[PROJECT FILTER] Projects from result.data.projects');
                    } else if (result.projects) {
                        projects = result.projects;
                        console.log('[PROJECT FILTER] Projects from result.projects');
                    }
                    
                    if (projects && projects.length > 0) {
                        // Store in allProjects for future use
                        allProjects = projects.map(p => ({
                            id: p.project_id || p.id,
                            name: p.project_name || p.name || 'Unnamed Project',
                            tasks: p.task_count || p.tasks || 0,
                            details: p.project_details || p.details || '',
                            type: p.project_type || p.type || 'software',
                            visibility: p.visibility || 'private'
                        }));
                        
                        console.log('[PROJECT FILTER] Processed projects:', allProjects.length);
                        populateProjectFilter(projectFilter, allProjects);
                    } else {
                        console.warn('[PROJECT FILTER] No projects found in response');
                        // Keep default "Project" option
                    }
                } else {
                    console.error('[PROJECT FILTER] API call failed:', result);
                    // Keep default "Project" option
                }
            } catch (error) {
                console.error('[PROJECT FILTER] Error loading projects:', error);
                // Keep default "Project" option
            }
        }
        
        // Populate project filter dropdown with projects
        function populateProjectFilter(projectFilter, projects) {
            // Clear existing options except the first "Project" option
            projectFilter.innerHTML = '<option value="">Project</option>';
            
            // Add projects to dropdown
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                projectFilter.appendChild(option);
                console.log(`[PROJECT FILTER] Added project: ${project.name} (ID: ${project.id})`);
            });
            
            console.log(`[PROJECT FILTER] SUCCESS: Populated ${projects.length} projects in dropdown`);
        }
        
        // Load task statuses into dropdown
        async function loadTaskStatuses() {
            const statusFilter = document.getElementById('statusFilter');
            if (!statusFilter) {
                console.warn('[STATUS FILTER] Status filter dropdown not found');
                return;
            }
            
            console.log('[STATUS FILTER] Loading task statuses into dropdown...');
            
            // Default statuses (6 columns) - these will always be shown
            const defaultStatuses = [
                { name: 'New', value: 'new', id: 'new' },
                { name: 'In Progress', value: 'inprogress', id: 'inprogress' },
                { name: 'Testing', value: 'testing', id: 'testing' },
                { name: 'Released to prod', value: 'releasedtoprod', id: 'releasedtoprod' },
                { name: 'Closed', value: 'closed', id: 'closed' },
                { name: 'Blocked', value: 'blocked', id: 'blocked' }
            ];
            
            try {
                // Fetch statuses from API
                const result = await pywebview.api.fetch_task_statuses(1, 10);
                console.log('[STATUS FILTER] API Response:', result);
                
                // Clear existing options
                statusFilter.innerHTML = '<option value="">Status</option>';
                
                // Map API statuses to our 6 columns
                const statusMap = {};
                if (result && result.success && result.statuses && result.statuses.length > 0) {
                    result.statuses.forEach(status => {
                        const statusName = status.status_name || 
                                         status.name || 
                                         status.task_status_name ||
                                         status.status ||
                                         '';
                        const statusId = status.status_id || 
                                      status.id || 
                                      status.task_status_id ||
                                      '';
                        
                        if (statusName && statusId) {
                            // Map status name to column using getStatusColumn
                            const column = getStatusColumn(statusName);
                            if (!statusMap[column]) {
                                statusMap[column] = {
                                    name: statusName,
                                    id: statusId,
                                    value: statusId
                                };
                            }
                        }
                    });
                }
                
                // Add statuses in order: New, In Progress, Testing, Released to prod, Closed, Blocked
                defaultStatuses.forEach(defaultStatus => {
                    const apiStatus = statusMap[defaultStatus.value];
                    const option = document.createElement('option');
                    
                    if (apiStatus) {
                        // Use API status ID if available, but keep the default name for display
                        option.value = apiStatus.id; // Use API status ID for filtering
                        option.textContent = defaultStatus.name; // Use standard name for display
                        console.log(`[STATUS FILTER] Added: ${defaultStatus.name} (API ID: ${apiStatus.id})`);
                    } else {
                        // Use default status
                        option.value = defaultStatus.value;
                        option.textContent = defaultStatus.name;
                        console.log(`[STATUS FILTER] Added default: ${defaultStatus.name} (value: ${defaultStatus.value})`);
                    }
                    
                    statusFilter.appendChild(option);
                });
                
                console.log(`[STATUS FILTER] SUCCESS: Loaded ${defaultStatuses.length} statuses in dropdown`);
            } catch (error) {
                console.error('[STATUS FILTER] Error loading task statuses:', error);
                // Use default statuses on error
                statusFilter.innerHTML = '<option value="">Status</option>';
                defaultStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.value;
                    option.textContent = status.name;
                    statusFilter.appendChild(option);
                });
                console.log('[STATUS FILTER] Using default statuses due to error');
            }
        }
        
        // Map task status to column ID (6 columns: new, inprogress, testing, releasedtoprod, closed, blocked)
        function getStatusColumn(status) {
            if (!status) return 'new';
            
            // Handle object status (with name property)
            let statusStr = status;
            if (typeof status === 'object' && status.name) {
                statusStr = status.name;
            }
            
            const statusLower = String(statusStr).toLowerCase().trim().replace(/\s+/g, '');
            
            // Map status to columns (6 columns)
            if (statusLower === 'new' || statusLower === 'pending' || statusLower === 'todo' || statusLower === 'todo') return 'new';
            if (statusLower === 'inprogress' || statusLower === 'inprogress' || statusLower === 'in_progress' || statusLower === 'working' || statusLower === 'active' || statusLower === 'in-progress') return 'inprogress';
            if (statusLower === 'testing' || statusLower === 'test' || statusLower === 'qa' || statusLower === 'qualityassurance' || statusLower === 'review') return 'testing';
            if (statusLower === 'releasedtoprod' || statusLower === 'releasedtoproduction' || statusLower === 'released' || statusLower === 'production' || statusLower === 'prod' || statusLower === 'releasedtoprod') return 'releasedtoprod';
            if (statusLower === 'closed' || statusLower === 'done' || statusLower === 'completed' || statusLower === 'complete' || statusLower === 'finished') return 'closed';
            if (statusLower === 'blocked' || statusLower === 'onhold' || statusLower === 'onhold' || statusLower === 'paused' || statusLower === 'waiting' || statusLower === 'hold') return 'blocked';
            
            // Default to new for unknown statuses
            return 'new';
        }
        
        // Format date for display
        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (e) {
                return dateStr;
            }
        }
        
        // Get initials from name
        function getInitials(name) {
            if (!name) return '?';
            const parts = String(name).trim().split(/\s+/);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }
        
        // Render a task card (optimized - removed excessive logging for performance)
        function renderTaskCard(task) {
            const taskTitle = task.task_name || task.name || task.title || 'Untitled Task';
            const taskId = task.id || task.task_id || task._id || '';
            const priority = task.priority || task.task_priority || 'medium';
            const dueDate = task.due_date || task.dueDate || task.due_date_time || '';
            const assignees = task.assignees || task.assigned_to || task.task_assignees || [];
            const assigneeList = Array.isArray(assignees) ? assignees : (assignees ? [assignees] : []);
            const taskStatusId = task.taskstatus_id || task.status_id || '';
            const taskStatus = task.status || task.task_status || 'new';
            const statusName = (typeof taskStatus === 'object' ? taskStatus.name : taskStatus) || 'new';
            
            // Get project/tag name
            const projectName = task.project_name || (task.project && task.project.name) || 'Mobile App';
            
            // Get assignee names or use initials
            const assigneeAvatars = assigneeList.slice(0, 3).map(assignee => {
                const name = assignee.name || assignee.user_name || assignee.first_name || assignee || '';
                return getInitials(name);
            });
            
            // Store full task data in JSON format (escaped for HTML attribute)
            const taskDataJson = JSON.stringify(task).replace(/"/g, '&quot;');
            
            // Format date
            let formattedDate = '';
            if (dueDate) {
                try {
                    const date = new Date(dueDate);
                    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                    formattedDate = `${date.getDate()} ${months[date.getMonth()]}, ${date.getFullYear()}`;
                } catch (e) {
                    formattedDate = formatDate(dueDate);
                }
            } else {
                // Default date for display
                formattedDate = '22 June, 2026';
            }
            
            const cardHtml = `
                <div class="kanban-task-card" 
                     draggable="true" 
                     data-task-id="${taskId}"
                     data-task-status-id="${taskStatusId}"
                     data-task-data="${taskDataJson}"
                     ondragstart="handleDragStart(event)" 
                     ondragend="handleDragEnd(event)"
                     onclick="handleTaskCardClick(event, '${taskId}')"
                     style="cursor: pointer;">
                    <div class="kanban-task-title">${taskTitle}</div>
                    <div class="kanban-task-tags">
                        <span class="task-tag task-tag-status">${statusName}</span>
                        <span class="task-tag task-tag-project">${projectName}</span>
                    </div>
                    <div class="kanban-task-footer">
                        ${formattedDate ? `
                            <span class="kanban-task-date">
                                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="margin-right: 4px;">
                                    <path d="M11.0833 2.33333H10.5V1.75C10.5 1.475 10.275 1.25 10 1.25C9.725 1.25 9.5 1.475 9.5 1.75V2.33333H4.5V1.75C4.5 1.475 4.275 1.25 4 1.25C3.725 1.25 3.5 1.475 3.5 1.75V2.33333H2.91667C2.225 2.33333 1.66667 2.89167 1.66667 3.58333V11.0833C1.66667 11.775 2.225 12.3333 2.91667 12.3333H11.0833C11.775 12.3333 12.3333 11.775 12.3333 11.0833V3.58333C12.3333 2.89167 11.775 2.33333 11.0833 2.33333ZM11.0833 11.0833H2.91667V5.83333H11.0833V11.0833Z" fill="#6B7280"/>
                                </svg>
                                ${formattedDate}
                            </span>
                        ` : '<span></span>'}
                        ${assigneeAvatars.length > 0 ? `
                            <div class="kanban-task-assignees">
                                ${assigneeAvatars.map(initials => `<div class="kanban-assignee-avatar">${initials}</div>`).join('')}
                            </div>
                        ` : '<span></span>'}
                    </div>
                </div>
            `;
            
            return cardHtml;
        }
        
        // Load and display tasks in Kanban board
        // Store current project filter
        let currentProjectId = null;
        let currentProjectName = null;
        
        // Fetch all available task statuses from API
        async function fetchTaskStatuses() {
            try {
                // Try to fetch task statuses - this will populate statusIdMapping
                const response = await pywebview.api.fetch_task_statuses();
                if (response && response.success && Array.isArray(response.statuses)) {
                    const incomingMapping = { ...statusIdMapping };
                    response.statuses.forEach(status => {
                        const rawName = status.status_name ||
                                       status.name ||
                                       status.task_status_name ||
                                       status.status ||
                                       status.title ||
                                       '';
                        const statusId = status.status_id ||
                                         status.id ||
                                         status.task_status_id ||
                                         status.taskstatus_id ||
                                         status.taskStatusId ||
                                         null;
                        if (!statusId) {
                            return;
                        }
                        
                        const normalizedName = String(rawName || '')
                            .toLowerCase()
                            .replace(/\s+/g, '');
                        
                        if (normalizedName) {
                            incomingMapping[normalizedName] = statusId;
                        }
                        
                        // Also map by column (new, inprogress, testing, releasedtoprod, closed, blocked)
                        const column = getStatusColumn(rawName || normalizedName);
                        if (column && !incomingMapping[column]) {
                            incomingMapping[column] = statusId;
                        }
                    });
                    statusIdMapping = incomingMapping;
                    return true;
                }
            } catch (error) {
                // Silent fail - don't spam console
            }
            return false;
        }
        
        async function loadTasks(projectId = null, projectName = null, statusFilter = null) {
            const taskCountSubtitle = document.getElementById('taskCountSubtitle');
            const kanbanTitle = document.getElementById('kanbanTitle');
            const kanbanBoard = document.getElementById('kanbanBoard');
            const backButton = document.getElementById('backToAllTasks');
            
            // Load projects into filter dropdown
            await loadProjectsIntoFilter();
            
            // Load task statuses into dropdown
            await loadTaskStatuses();
            
            // Try to fetch task statuses for mapping if mapping is empty
            if (Object.keys(statusIdMapping).length === 0) {
                await fetchTaskStatuses();
            }
            
            if (!kanbanBoard) return;
            
            // Store filter
            currentProjectId = projectId;
            currentProjectName = projectName;
            
            // Update title and back button if project filter is active
            if (kanbanTitle) {
                if (projectName) {
                    kanbanTitle.textContent = `${projectName} - Tasks`;
                } else {
                    kanbanTitle.textContent = 'Task Management';
                }
            }
            
            // Show/hide back button
            if (backButton) {
                backButton.style.display = projectId ? 'block' : 'none';
            }
            
            // Show loading state
            if (taskCountSubtitle) {
                taskCountSubtitle.textContent = 'Loading tasks...';
            }
            
            // Clear all columns (6 columns: new, inprogress, testing, releasedtoprod, closed, blocked)
            const columns = ['new', 'inprogress', 'testing', 'releasedtoprod', 'closed', 'blocked'];
            columns.forEach(col => {
                const columnContent = document.getElementById(`column-${col}`);
                const columnCount = document.getElementById(`count-${col}`);
                if (columnContent) {
                    columnContent.innerHTML = '<div class="kanban-empty-state">Loading...</div>';
                }
                if (columnCount) {
                    columnCount.textContent = '0';
                }
            });
            
            try {
                // Fetch tasks from API with optional project filter
                console.log(' [TASK DEBUG] Starting to fetch tasks...');
                console.log(' [TASK DEBUG] Project ID:', projectId);
                const result = await pywebview.api.fetch_tasks(projectId);
                console.log(' [TASK DEBUG] Tasks API Response:', result);
                console.log(' [TASK DEBUG] Response success:', result?.success);
                console.log(' [TASK DEBUG] Response error:', result?.error);
                if (projectId) {
                    console.log(' [TASK DEBUG] Filtered by project:', projectId);
                }
                
                // Check if we got a successful response
                let tasks = [];
                if (result && result.success) {
                    tasks = result.tasks || [];
                    console.log(' [TASK DEBUG] Tasks fetched successfully:', tasks.length);
                    console.log(' [TASK DEBUG] Tasks data:', JSON.stringify(tasks, null, 2));
                    
                    // Store tasks globally for list view
                    allTasksList = tasks;
                } else {
                    // If API is not available, show empty state gracefully
                    const errorMsg = result?.error || '';
                    const is404Error = errorMsg.includes('404') || errorMsg.includes('not found') || errorMsg.includes('endpoint');
                    
                    console.error(' [TASK DEBUG] API call failed:', result);
                    console.error(' [TASK DEBUG] Error message:', errorMsg);
                    console.error(' [TASK DEBUG] Is 404 error:', is404Error);
                    
                    if (!is404Error && errorMsg) {
                        console.error(' [TASK DEBUG] API call failed:', result);
                    }
                }
                
                console.log(' [TASK DEBUG] Total tasks received from API:', tasks.length);
                if (tasks.length > 0) {
                    console.log(' [TASK DEBUG] First task sample:', tasks[0]);
                }
                
                // Note: Server should already filter by project_id, but we keep client-side filter as backup
                if (projectId) {
                    // Backup filter in case server doesn't filter
                    const beforeFilter = tasks.length;
                    console.log(`[FILTER] Filtering tasks by project ID: ${projectId}`);
                    console.log(`[FILTER] Total tasks before filter: ${beforeFilter}`);
                    
                    tasks = tasks.filter(task => {
                        // Try multiple ways to get project ID from task
                        const taskProjectId = task.project_id || 
                                            task.project_id || 
                                            (task.project && (task.project.id || task.project.project_id)) ||
                                            task.projectId ||
                                            null;
                        
                        // Convert both to strings for comparison
                        const taskProjectIdStr = String(taskProjectId || '').trim();
                        const filterProjectIdStr = String(projectId || '').trim();
                        
                        const matches = taskProjectIdStr === filterProjectIdStr;
                        
                        if (!matches && taskProjectId) {
                            console.log(`[FILTER] Task project ID mismatch: task has "${taskProjectIdStr}", filter is "${filterProjectIdStr}"`);
                        }
                        
                        return matches;
                    });
                    
                    if (beforeFilter !== tasks.length) {
                        console.log(`[FILTER]  Client-side project filter: ${beforeFilter}  ${tasks.length} tasks for project "${projectName}"`);
                    } else {
                        console.log(`[FILTER]  Server already filtered ${tasks.length} tasks for project "${projectName}"`);
                    }
                    
                    // Log sample task project IDs for debugging
                    if (tasks.length > 0) {
                        console.log(`[FILTER] Sample task project IDs:`, tasks.slice(0, 3).map(t => ({
                            id: t.id || t.task_id,
                            project_id: t.project_id || (t.project && t.project.id) || 'N/A'
                        })));
                    } else if (beforeFilter > 0) {
                        console.warn(`[FILTER]  No tasks matched project filter! All ${beforeFilter} tasks were filtered out.`);
                        console.warn(`[FILTER] Sample task project IDs from all tasks:`, 
                            (result.tasks || []).slice(0, 3).map(t => ({
                                id: t.id || t.task_id,
                                project_id: t.project_id || (t.project && t.project.id) || 'N/A'
                            })));
                    }
                }
                
                // Filter by status if status filter is applied
                if (statusFilter) {
                    const beforeStatusFilter = tasks.length;
                    console.log(`[FILTER] Filtering tasks by status: ${statusFilter}`);
                    
                    // Normalize statusFilter (remove spaces, lowercase)
                    const normalizedFilter = statusFilter.toLowerCase().replace(/\s+/g, '');
                    
                    // statusFilter could be a status ID or column name (new, inprogress, testing, etc.)
                    tasks = tasks.filter(task => {
                        const taskStatusId = task.taskstatus_id || task.status_id;
                        const taskStatus = task.status || task.task_status || 'new';
                        const taskStatusName = typeof taskStatus === 'object' ? taskStatus.name : taskStatus;
                        const taskStatusColumn = getStatusColumn(taskStatusName);
                        
                        // Check if statusFilter matches status ID (exact match)
                        if (taskStatusId && String(taskStatusId) === String(statusFilter)) {
                            console.log(`[FILTER] Task matched by status ID: ${taskStatusId}`);
                            return true;
                        }
                        
                        // Check if statusFilter matches column name (new, inprogress, etc.)
                        if (taskStatusColumn === normalizedFilter) {
                            console.log(`[FILTER] Task matched by column: ${taskStatusColumn} === ${normalizedFilter}`);
                            return true;
                        }
                        
                        // Check if statusFilter matches status name (normalized)
                        const normalizedTaskStatus = taskStatusName.toLowerCase().replace(/\s+/g, '');
                        if (normalizedTaskStatus === normalizedFilter) {
                            console.log(`[FILTER] Task matched by status name: ${normalizedTaskStatus} === ${normalizedFilter}`);
                            return true;
                        }
                        
                        return false;
                    });
                    
                    if (beforeStatusFilter !== tasks.length) {
                        console.log(`[FILTER]  Status filter applied: ${beforeStatusFilter}  ${tasks.length} tasks`);
                    } else {
                        console.log(`[FILTER]  No tasks matched status filter: ${statusFilter}`);
                    }
                }
                
                // Update subtitle with count
                const taskCount = tasks.length;
                if (taskCountSubtitle) {
                    if (taskCount > 0) {
                        taskCountSubtitle.textContent = `Manage all your tasks efficiently. Track progress, deadlines, and assignments.`;
                    } else {
                        taskCountSubtitle.textContent = 'No tasks assigned to you yet. Tasks will appear here when assigned.';
                    }
                }
                
                // Group tasks by status (6 columns)
                const tasksByStatus = {
                    'new': [],
                    'inprogress': [],
                    'testing': [],
                    'releasedtoprod': [],
                    'closed': [],
                    'blocked': []
                };
                
                console.log(' [TASK DEBUG] Grouping tasks by status...');
                console.log(' [TASK DEBUG] Total tasks to group:', tasks.length);
                
                // Build status ID mapping from task data while keeping API-fetched mappings intact
                const mergedStatusMapping = { ...statusIdMapping };
                tasks.forEach((task) => {
                    const status = task.status || task.task_status || 'new';
                    const column = getStatusColumn(status);
                    tasksByStatus[column].push(task);
                    
                    // Extract status ID for mapping (reduced logging for performance)
                    if (status && typeof status === 'object' && status.id && status.name) {
                        const statusName = status.name.toLowerCase().replace(/\s+/g, '');
                        mergedStatusMapping[statusName] = status.id;
                    }
                    // Also store taskstatus_id by column name
                    if (task.taskstatus_id) {
                        const col = getStatusColumn(status);
                        if (!mergedStatusMapping[col]) {
                            mergedStatusMapping[col] = task.taskstatus_id;
                        }
                    }
                });
                statusIdMapping = mergedStatusMapping;
                
                // Add visual feedback - mark unavailable columns
                document.querySelectorAll('.kanban-column').forEach(column => {
                    const columnStatus = column.dataset.status;
                    if (!statusIdMapping[columnStatus]) {
                        column.classList.add('column-unavailable');
                        column.title = `This column is unavailable. Create a task with "${columnStatus}" status first.`;
                    } else {
                        column.classList.remove('column-unavailable');
                        column.title = '';
                    }
                });
                
                // Render tasks in each column (reduced logging for performance)
                columns.forEach(col => {
                    const columnContent = document.getElementById(`column-${col}`);
                    const columnCount = document.getElementById(`count-${col}`);
                    const columnTasks = tasksByStatus[col] || [];
                    
                    if (columnCount) {
                        columnCount.textContent = columnTasks.length.toString();
                    }
                    
                    if (columnContent) {
                        if (columnTasks.length === 0) {
                            columnContent.innerHTML = '<div class="kanban-empty-state">No tasks</div>';
                        } else {
                            const renderedCards = columnTasks.map(task => renderTaskCard(task));
                            columnContent.innerHTML = renderedCards.join('');
                        }
                    }
                });
                
                // Setup drag and drop after tasks are rendered
                setupDragAndDrop();
                
            } catch (error) {
                console.error('Error loading tasks:', error);
                if (taskCountSubtitle) {
                    taskCountSubtitle.textContent = 'Error loading tasks. Please try again.';
                }
                
                // Show error in all columns
                columns.forEach(col => {
                    const columnContent = document.getElementById(`column-${col}`);
                    if (columnContent) {
                        columnContent.innerHTML = '<div class="kanban-empty-state">Error loading tasks</div>';
                    }
                });
            }
        }
        
        // Refresh tasks
        function refreshTasks() {
            // Maintain current project filter when refreshing
            loadTasks(currentProjectId, currentProjectName);
        }
        
        // Drag & Drop functionality
        let draggedTask = null;
        let draggedTaskData = null;
        let statusIdMapping = {}; // Store status name -> status ID mapping

        // Ensure we have a status ID for a given kanban column.
        // Tries current map, refetches from API if missing, then falls back to any available status.
        async function ensureStatusIdForColumn(column) {
            if (statusIdMapping[column]) {
                return statusIdMapping[column];
            }
            // Try refreshing from API
            try {
                await fetchTaskStatuses();
            } catch (e) {
                console.warn(' Could not refresh task statuses:', e);
            }
            if (statusIdMapping[column]) {
                return statusIdMapping[column];
            }
            // Fallback: any available status ID
            const availableStatuses = Object.values(statusIdMapping);
            if (availableStatuses.length > 0) {
                console.warn(`Using fallback status for column "${column}"`);
                return availableStatuses[0];
            }
            return null;
        }
        
        function handleDragStart(event) {
            const taskCard = event.target.closest('.kanban-task-card');
            if (!taskCard) return;
            
            draggedTask = taskCard;
            draggedTaskData = JSON.parse(taskCard.getAttribute('data-task-data').replace(/&quot;/g, '"'));
            
            taskCard.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', taskCard.innerHTML);
            
            console.log('Drag started:', draggedTaskData.title || draggedTaskData.task_name);
        }
        
        function handleDragEnd(event) {
            const taskCard = event.target.closest('.kanban-task-card');
            if (taskCard) {
                taskCard.classList.remove('dragging');
            }
            
            // Remove drag-over class from all columns
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            
            const column = event.target.closest('.kanban-column-content');
            if (column) {
                column.classList.add('drag-over');
            }
        }
        
        function handleDragLeave(event) {
            const column = event.target.closest('.kanban-column-content');
            if (column && !column.contains(event.relatedTarget)) {
                column.classList.remove('drag-over');
            }
        }
        
        async function handleDrop(event) {
            event.preventDefault();
            
            const columnContent = event.target.closest('.kanban-column-content');
            if (!columnContent || !draggedTask || !draggedTaskData) return;
            
            const column = columnContent.closest('.kanban-column');
            const newStatus = column.getAttribute('data-status');
            
            console.log('Dropped task:', draggedTaskData.title || draggedTaskData.task_name);
            console.log('New status column:', newStatus);
            console.log('Available status mappings:', statusIdMapping);
            
            // Get the correct status ID for the new column
            let newStatusId = statusIdMapping[newStatus];
            
            // Try alternate status name formats
            if (!newStatusId) {
                const alternateNames = {
                    'new': ['new', 'pending', 'todo'],
                    'inprogress': ['inprogress', 'in progress', 'active', 'working', 'in-progress'],
                    'testing': ['testing', 'qa', 'review', 'test', 'qualityassurance'],
                    'releasedtoprod': ['releasedtoprod', 'releasedtoproduction', 'released', 'production', 'prod', 'released to prod'],
                    'closed': ['closed', 'done', 'completed', 'complete', 'finished'],
                    'blocked': ['blocked', 'onhold', 'on hold', 'paused', 'waiting', 'hold']
                };
                
                const possibleNames = alternateNames[newStatus] || [newStatus];
                for (const name of possibleNames) {
                    if (statusIdMapping[name] || statusIdMapping[name.replace(/\s+/g, '')]) {
                        newStatusId = statusIdMapping[name] || statusIdMapping[name.replace(/\s+/g, '')];
                        break;
                    }
                }
            }
            
            // If still missing, try to fetch and fall back automatically
            if (!newStatusId) {
                console.warn(' No status ID mapping for column:', newStatus);
                newStatusId = await ensureStatusIdForColumn(newStatus);
                if (!newStatusId) {
                    alert(' Error: No task statuses available. Please restart the app.');
                    draggedTask = null;
                    draggedTaskData = null;
                    document.querySelectorAll('.kanban-column-content').forEach(col => {
                        col.classList.remove('drag-over');
                    });
                    return;
                }
            }
            
            console.log(' Using status ID:', newStatusId, 'for column:', newStatus);
            
            // Prepare task update data
            const taskId = draggedTaskData.id || draggedTaskData.task_id;
            const updateData = {
                title: draggedTaskData.title || draggedTaskData.task_name || draggedTaskData.name,
                task_details: draggedTaskData.task_details || draggedTaskData.details || '',
                priority: draggedTaskData.priority || 'medium',
                taskstatus_id: newStatusId,
                tasktype_id: draggedTaskData.tasktype_id || null,
                client_id: draggedTaskData.client_id,
                assigned_by: draggedTaskData.assigned_by || draggedTaskData.created_by,
                due_date: draggedTaskData.due_date || null,
                start_date: draggedTaskData.start_date || null,
                tags: draggedTaskData.tags || [],
                custom_field: draggedTaskData.custom_field || {},
                project_id: draggedTaskData.project_id || null,
                task_assignees: draggedTaskData.task_assignees || []
            };
            
            console.log('Updating task with data:', updateData);
            
            try {
                // Call update API
                const result = await pywebview.api.update_task(taskId, updateData);
                
                if (result && result.success) {
                    console.log(' Task updated successfully');
                    
                    // Refresh tasks to show updated state
                    await loadTasks(currentProjectId, currentProjectName);
                } else {
                    console.error(' Failed to update task:', result.error || result.message);
                    alert('Failed to update task: ' + (result.error || result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error(' Error updating task:', error);
                alert('Error updating task: ' + error.message);
            }
            
            columnContent.classList.remove('drag-over');
            draggedTask = null;
            draggedTaskData = null;
        }
        
        // Add drop event listeners to columns after they're rendered
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column-content');
            columns.forEach(column => {
                column.addEventListener('dragover', handleDragOver);
                column.addEventListener('dragleave', handleDragLeave);
                column.addEventListener('drop', handleDrop);
            });
            console.log('Drag & drop setup complete for', columns.length, 'columns');
        }
        
        // Open new project modal
        function openNewProjectModal() {
            const modal = document.getElementById('newProjectModal');
            if (modal) {
                modal.classList.add('show');
                // Reset form
                document.getElementById('newProjectForm').reset();
            }
        }
        
        // Close new project modal
        function closeNewProjectModal() {
            const modal = document.getElementById('newProjectModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        // Handle create project form submission
        async function handleCreateProject(event) {
            event.preventDefault();
            
            const projectName = document.getElementById('projectName').value;
            const projectDetails = document.getElementById('projectDetails').value;
            const projectType = document.getElementById('projectType').value;
            const projectVisibility = document.getElementById('projectVisibility').value;
            
            // Prepare project data
            const projectData = {
                project_name: projectName,
                project_details: projectDetails,
                project_type: projectType,
                visibility: projectVisibility,
                assignees: []
            };
            
            try {
                // Show loading state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Creating...';
                submitBtn.disabled = true;
                
                // Call API to create project
                const result = await pywebview.api.create_project(projectData);
                
                if (result && result.success) {
                    // Success! Close modal and reload projects
                    closeNewProjectModal();
                    loadProjects();
                    
                    // Show success message (optional)
                    console.log('Project created successfully!');
                } else {
                    // Show error message
                    alert('Failed to create project: ' + (result.error || result.message || 'Unknown error'));
                }
                
                // Restore button state
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('Error creating project:', error);
                alert('Error creating project: ' + error.message);
                
                // Restore button state
                const submitBtn = event.target.querySelector('button[type="submit"]');
                submitBtn.textContent = 'Create Project';
                submitBtn.disabled = false;
            }
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('newProjectModal');
            if (event.target === modal) {
                closeNewProjectModal();
            }
        });
        
        // Open project tasks - navigate to tasks page and filter by project
        async function openProjectTasks(projectId, projectName) {
            console.log(`\n${'='*80}`);
            console.log(` [PROJECT DEBUG] ========== OPEN PROJECT TASKS START ==========`);
            console.log(` [PROJECT DEBUG] Project Name: ${projectName}`);
            console.log(` [PROJECT DEBUG] Project ID: ${projectId}`);
            console.log(`${'='*80}\n`);
            
            // Switch to tasks page first
            console.log(` [PROJECT DEBUG] Switching to task-list page...`);
            switchPage('task-list');
            
            // Small delay to ensure page switch completes
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Fetch project details from API
            try {
                console.log(` [PROJECT DEBUG] Calling pywebview.api.fetch_project(${projectId})...`);
                
                if (typeof pywebview === 'undefined' || !pywebview.api) {
                    console.error(` [PROJECT DEBUG] pywebview.api is not available!`);
                    await loadTasks(projectId, projectName);
                    return;
                }
                
                if (!pywebview.api.fetch_project) {
                    console.error(` [PROJECT DEBUG] pywebview.api.fetch_project method not found!`);
                    console.log(` [PROJECT DEBUG] Available methods:`, Object.keys(pywebview.api));
                    await loadTasks(projectId, projectName);
                    return;
                }
                
                const projectResult = await pywebview.api.fetch_project(projectId);
                console.log(` [PROJECT DEBUG] API Response received:`, projectResult);
                console.log(` [PROJECT DEBUG] Response success:`, projectResult?.success);
                console.log(` [PROJECT DEBUG] Response error:`, projectResult?.error);
                console.log(` [PROJECT DEBUG] Response data:`, projectResult?.data);
                console.log(` [PROJECT DEBUG] Response project:`, projectResult?.project);
                
                if (projectResult && projectResult.success) {
                    const projectData = projectResult.project || projectResult.data;
                    console.log(` [PROJECT DEBUG] Project fetched successfully:`, projectData);
                    
                    // Use project name from API if available, otherwise use passed name
                    const finalProjectName = projectData?.project_name || projectData?.name || projectName;
                    const finalProjectId = projectData?.id || projectData?.project_id || projectId;
                    
                    console.log(` [PROJECT DEBUG] Final Project Name: ${finalProjectName}`);
                    console.log(` [PROJECT DEBUG] Final Project ID: ${finalProjectId}`);
                    
                    // Load tasks filtered by project
                    console.log(` [PROJECT DEBUG] Loading tasks for project...`);
                    await loadTasks(finalProjectId, finalProjectName);
                } else {
                    const errorMsg = projectResult?.error || 'Unknown error';
                    console.warn(` [PROJECT DEBUG] Failed to fetch project details:`, errorMsg);
                    console.warn(` [PROJECT DEBUG] Full response:`, projectResult);
                    // Still try to load tasks with the provided project ID and name
                    console.log(` [PROJECT DEBUG] Falling back to load tasks with provided project info...`);
                    await loadTasks(projectId, projectName);
                }
            } catch (error) {
                console.error(` [PROJECT DEBUG] Exception in openProjectTasks:`, error);
                console.error(` [PROJECT DEBUG] Error stack:`, error.stack);
                // Fallback: load tasks with provided project ID and name
                console.log(` [PROJECT DEBUG] Exception fallback: Loading tasks with provided project info...`);
                await loadTasks(projectId, projectName);
            }
            
            console.log(` [PROJECT DEBUG] ========== OPEN PROJECT TASKS END ==========`);
            console.log(`${'='*80}\n`);
        }
        
        // Clear project filter and show all tasks
        function clearProjectFilter() {
            loadTasks(null, null);
        }
        
        // Switch task view (List, Calendar, Board)
        function switchTaskView(view) {
            document.querySelectorAll('.view-toggle-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.view-toggle-item').classList.add('active');
            
            // For now, only Board view is implemented
            if (view === 'list' || view === 'calendar') {
                alert(`${view.charAt(0).toUpperCase() + view.slice(1)} view coming soon!`);
            }
        }
        
        // Toggle filter panel
        function toggleFilterPanel() {
            // Filter panel functionality can be added here
            console.log('Filter panel toggled');
        }
        
        // Apply filters
        async function applyFilters() {
            const projectFilterSelect = document.getElementById('projectFilter');
            const projectFilter = projectFilterSelect ? projectFilterSelect.value : '';
            const statusFilter = document.getElementById('statusFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            // Get project name from selected option
            let projectName = null;
            if (projectFilter && projectFilterSelect) {
                const selectedOption = projectFilterSelect.options[projectFilterSelect.selectedIndex];
                projectName = selectedOption ? selectedOption.textContent : null;
                console.log(`[FILTER] Selected project: ${projectName} (ID: ${projectFilter})`);
            }
            
            // Update active filters display
            const activeFiltersDiv = document.getElementById('activeFilters');
            let activeFiltersHTML = '';
            
            if (statusFilter) {
                activeFiltersHTML += `
                    <div class="filter-tag">
                        ${statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1)}
                        <span class="filter-tag-remove" onclick="removeFilter('status')"></span>
                    </div>
                `;
            }
            
            if (projectFilter && projectName) {
                activeFiltersHTML += `
                    <div class="filter-tag">
                        ${projectName}
                        <span class="filter-tag-remove" onclick="removeFilter('project')"></span>
                    </div>
                `;
            }
            
            if (priorityFilter) {
                activeFiltersHTML += `
                    <div class="filter-tag">
                        ${priorityFilter.charAt(0).toUpperCase() + priorityFilter.slice(1)}
                        <span class="filter-tag-remove" onclick="removeFilter('priority')"></span>
                    </div>
                `;
            }
            
            if (activeFiltersDiv) {
                activeFiltersDiv.innerHTML = activeFiltersHTML;
            }
            
            // Reload tasks with filters
            console.log(`[FILTER] Loading tasks - Project: ${projectName || 'All'} (ID: ${projectFilter || 'None'}), Status: ${statusFilter || 'All'}`);
            await loadTasks(projectFilter || null, projectName || null, statusFilter || null);
        }
        
        // Remove filter
        function removeFilter(filterType) {
            if (filterType === 'status') {
                document.getElementById('statusFilter').value = '';
            } else if (filterType === 'project') {
                document.getElementById('projectFilter').value = '';
            } else if (filterType === 'priority') {
                document.getElementById('priorityFilter').value = '';
            }
            applyFilters();
        }
        
        // Open add task modal
        function openAddTaskModal(status) {
            // Add task modal functionality can be added here
            console.log('Add task modal opened for status:', status);
            alert('Add Task functionality coming soon!');
        }
        
        function switchPage(page) {
            // Map 'task-list' to 'tasks' for page ID
            const pageId = page === 'task-list' ? 'tasks' : page;
            
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
            });
            
            const pageElement = document.getElementById(`page-${pageId}`);
            if (pageElement) {
                pageElement.classList.add('active');
            }
            
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.nav-sub-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                const navSubItem = event.target.closest('.nav-sub-item');
                if (navItem) {
                    navItem.classList.add('active');
                }
                if (navSubItem) {
                    navSubItem.classList.add('active');
                }
            }
            
            currentPage = page;
            
            if (page === 'attendance') {
                try {
                    pywebview.api.refresh_attendance();
                } catch (e) {
                    console.error('Error refreshing attendance:', e);
                }
            }
            
            if (page === 'task-list' || page === 'tasks') {
                try {
                    loadTasks();
                } catch (e) {
                    console.error('Error loading tasks:', e);
                }
            }
            
            if (page === 'projects') {
                loadProjects();
                setupProjectSearch();
            }
        }
        
        // Chart Functions
        function renderDonutChart() {
            const svg = document.getElementById('donut-chart');
            if (!svg) return;
            
            const centerX = 100;
            const centerY = 100;
            const radius = 70;
            const innerRadius = 50;
            
            // Clear previous content
            svg.innerHTML = '';
            
            // Data: 35% Productive (green), 40% Unproductive (red), 25% Neutral (yellow)
            const data = [
                { value: 35, color: '#10B981', label: 'Productive' },
                { value: 40, color: '#EF4444', label: 'Unproductive' },
                { value: 25, color: '#F59E0B', label: 'Neutral' }
            ];
            
            let currentAngle = -90; // Start from top
            
            data.forEach((item, index) => {
                const angle = (item.value / 100) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;
                
                const startAngleRad = (startAngle * Math.PI) / 180;
                const endAngleRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startAngleRad);
                const y1 = centerY + radius * Math.sin(startAngleRad);
                const x2 = centerX + radius * Math.cos(endAngleRad);
                const y2 = centerY + radius * Math.sin(endAngleRad);
                
                const x3 = centerX + innerRadius * Math.cos(endAngleRad);
                const y3 = centerY + innerRadius * Math.sin(endAngleRad);
                const x4 = centerX + innerRadius * Math.cos(startAngleRad);
                const y4 = centerY + innerRadius * Math.sin(startAngleRad);
                
                const largeArcFlag = angle > 180 ? 1 : 0;
                
                const pathData = [
                    `M ${x1} ${y1}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
                    `L ${x3} ${y3}`,
                    `A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4}`,
                    'Z'
                ].join(' ');
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                path.setAttribute('stroke', 'white');
                path.setAttribute('stroke-width', '2');
                svg.appendChild(path);
                
                currentAngle += angle;
            });
        }
        
        function renderLineChart() {
            const svg = document.getElementById('line-chart');
            if (!svg) return;
            
            // Clear previous content
            svg.innerHTML = '';
            
            // Sample data for weekly task activity
            const data = [
                { day: 'Mon', tasks: 35 },
                { day: 'Tue', tasks: 42 },
                { day: 'Wed', tasks: 38 },
                { day: 'Thu', tasks: 49 },
                { day: 'Fri', tasks: 45 },
                { day: 'Sat', tasks: 30 },
                { day: 'Sun', tasks: 25 }
            ];
            
            const width = 600;
            const height = 250;
            const padding = { top: 20, right: 40, bottom: 40, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            const maxValue = 100;
            const minValue = 0;
            const valueRange = maxValue - minValue;
            
            // Draw grid lines
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                const value = maxValue - (valueRange / 4) * i;
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', padding.left);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - padding.right);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'chart-grid');
                svg.appendChild(line);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', padding.left - 10);
                text.setAttribute('y', y + 4);
                text.setAttribute('class', 'chart-axis');
                text.setAttribute('text-anchor', 'end');
                text.textContent = value;
                svg.appendChild(text);
            }
            
            // Draw X-axis labels
            const dayWidth = chartWidth / data.length;
            data.forEach((item, index) => {
                const x = padding.left + (index + 0.5) * dayWidth;
                const y = height - padding.bottom + 20;
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', y);
                text.setAttribute('class', 'chart-axis');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = item.day;
                svg.appendChild(text);
            });
            
            // Draw line
            const pathData = data.map((item, index) => {
                const x = padding.left + (index + 0.5) * dayWidth;
                const y = padding.top + chartHeight - ((item.tasks - minValue) / valueRange) * chartHeight;
                return `${index === 0 ? 'M' : 'L'} ${x} ${y}`;
            }).join(' ');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', pathData);
            path.setAttribute('class', 'chart-line');
            svg.appendChild(path);
            
            // Draw points
            data.forEach((item, index) => {
                const x = padding.left + (index + 0.5) * dayWidth;
                const y = padding.top + chartHeight - ((item.tasks - minValue) / valueRange) * chartHeight;
                
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', 4);
                circle.setAttribute('class', 'chart-point');
                circle.setAttribute('data-day', item.day);
                circle.setAttribute('data-tasks', item.tasks);
                
                // Add hover events
                circle.addEventListener('mouseenter', function(e) {
                    const tooltip = document.getElementById('chart-tooltip');
                    const tooltipTitle = document.getElementById('tooltip-title');
                    const tooltipValue = document.getElementById('tooltip-value');
                    const chartContainer = document.querySelector('.line-chart-container');
                    
                    tooltipTitle.textContent = item.day;
                    tooltipValue.textContent = `${item.tasks} Tasks`;
                    
                    const rect = chartContainer.getBoundingClientRect();
                    tooltip.style.left = (x - 50) + 'px';
                    tooltip.style.top = (y - 60) + 'px';
                    tooltip.classList.add('show');
                    
                    // Highlight point
                    circle.setAttribute('class', 'chart-point highlight');
                    circle.setAttribute('r', 6);
                });
                
                circle.addEventListener('mouseleave', function() {
                    const tooltip = document.getElementById('chart-tooltip');
                    tooltip.classList.remove('show');
                    
                    circle.setAttribute('class', 'chart-point');
                    circle.setAttribute('r', 4);
                });
                
                svg.appendChild(circle);
            });
        }
        
        function toggleTimeframe() {
            const timeframeText = document.getElementById('timeframe-text');
            const timeframes = ['Weekly', 'Monthly', 'Yearly'];
            const currentIndex = timeframes.indexOf(timeframeText.textContent);
            const nextIndex = (currentIndex + 1) % timeframes.length;
            timeframeText.textContent = timeframes[nextIndex];
            renderLineChart(); // Re-render with new timeframe
        }
        
        // Calendar functions
        function generateCalendar() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('calendar-month').textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            let html = '';
            
            weekdays.forEach(day => {
                html += `<div class="calendar-day weekday">${day}</div>`;
            });
            
            for (let i = 0; i < firstDay - 1; i++) {
                html += '<div class="calendar-day"></div>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                let classes = 'calendar-day date';
                if ([2, 9, 16, 23, 30].includes(day)) {
                    classes += ' highlight';
                } else if ([21, 28].includes(day)) {
                    classes += ' red';
                }
                html += `<div class="${classes}">${day}</div>`;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
        }
        
        function prevMonth() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            generateCalendar();
        }
        
        function nextMonth() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            generateCalendar();
        }
        
        // Update clock
        function updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = (hours % 12 || 12).toString().padStart(2, '0');
            
            // Update current time display in header (without seconds)
            const currentTimeEl = document.getElementById('current-time');
            if (currentTimeEl) {
                currentTimeEl.textContent = `${displayHours}:${minutes} ${ampm}`;
            }
            
            // Update clock element if it exists
            const clockEl = document.getElementById('clock');
            if (clockEl) {
                clockEl.textContent = `${displayHours}:${minutes}:${seconds} ${ampm}`;
            }
        }
        setInterval(updateClock, 1000);
        updateClock();
        generateCalendar();
        
        // Render charts on page load
        renderDonutChart();
        renderLineChart();
        
        // Hours Spent Chart Function - Real Data (With Overtime)
        function updateHoursSpentChart(data) {
            const svg = document.getElementById('stacked-bar-chart');
            if (!svg || !data) return;
            
            svg.innerHTML = '';
            
            const width = 600;
            const height = 200;
            const padding = { top: 20, right: 40, bottom: 40, left: 60 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            const days = data.days || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const workHours = data.work_hours || [0, 0, 0, 0, 0, 0, 0];
            const breakTime = data.break_time || [0, 0, 0, 0, 0, 0, 0];
            const overtime = data.overtime || [0, 0, 0, 0, 0, 0, 0];

            const tooltipEl = document.getElementById('activity-tooltip');
            const containerEl = svg.parentElement;
            
            // Update legend percentages (weekly totals)
            const totalWorkHours = data.total_work_hours || 0;
            const totalBreakTime = data.total_break_time || 0;
            const totalOvertime = data.total_overtime || 0;
            const totalAll = totalWorkHours + totalBreakTime + totalOvertime;
            if (totalAll > 0) {
                const pctActiveNum = (totalWorkHours / totalAll) * 100;
                const pctBreakNum = (totalBreakTime / totalAll) * 100;
                const pctIdleNum = (totalOvertime / totalAll) * 100;
                const pctInactiveNum = Math.max(0, 100 - (pctActiveNum + pctBreakNum + pctIdleNum));

                const pctActive = pctActiveNum.toFixed(1) + '%';
                const pctBreak = pctBreakNum.toFixed(1) + '%';
                const pctIdle = pctIdleNum.toFixed(1) + '%';
                const pctInactive = pctInactiveNum.toFixed(1) + '%';

                const activeEl = document.getElementById('legend-active');
                const inactiveEl = document.getElementById('legend-inactive');
                const idleEl = document.getElementById('legend-idle');
                const breakEl = document.getElementById('legend-break');
                if (activeEl) activeEl.textContent = pctActive;
                if (inactiveEl) inactiveEl.textContent = pctInactive;
                if (idleEl) idleEl.textContent = pctIdle;
                if (breakEl) breakEl.textContent = pctBreak;
            }
            
            // Convert to TOTAL hours per day (single blue bar like design)
            const totalPerDay = workHours.map((w, i) => (w || 0) + (breakTime[i] || 0) + (overtime[i] || 0));
            
            // Find max value for scaling (at least 8h for nicer look)
            const maxValue = Math.max(...totalPerDay, 8);
            const scale = chartHeight / maxValue;
            
            const barWidth = chartWidth / days.length;
            const barSpacing = barWidth * 0.2;
            const actualBarWidth = barWidth - barSpacing;
            
            // Draw Y-axis grid lines and labels (0h, 2h, 4h...)
            for (let i = 0; i <= 4; i++) {
                const y = padding.top + (chartHeight / 4) * i;
                const value = maxValue - (maxValue / 4) * i;
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', padding.left);
                line.setAttribute('y1', y);
                line.setAttribute('x2', width - padding.right);
                line.setAttribute('y2', y);
                line.setAttribute('class', 'chart-grid');
                svg.appendChild(line);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', padding.left - 10);
                text.setAttribute('y', y + 4);
                text.setAttribute('class', 'chart-axis');
                text.setAttribute('text-anchor', 'end');
                text.textContent = Math.round(value) + 'h';
                svg.appendChild(text);
            }
            
            // Draw single solid bars per day (total time)  match simple UI
            // Helper to format decimal hours -> "HH:MM hrs"
            function formatHours(h) {
                const totalMinutes = Math.round((h || 0) * 60);
                const hh = Math.floor(totalMinutes / 60).toString().padStart(2, '0');
                const mm = (totalMinutes % 60).toString().padStart(2, '0');
                return `${hh}:${mm} hrs`;
            }

            days.forEach((day, index) => {
                const x = padding.left + index * barWidth + barSpacing / 2;
                const total = totalPerDay[index] || 0;
                const barHeight = total * scale;
                const y = padding.top + chartHeight - barHeight;
                
                if (barHeight > 0) {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', actualBarWidth);
                    rect.setAttribute('height', barHeight);
                    rect.setAttribute('fill', '#B08CFF'); // soft purple to match XD
                    rect.setAttribute('class', 'stacked-bar');
                    rect.setAttribute('rx', '4');
                    rect.setAttribute('ry', '4');

                    // Tooltip events
                    if (tooltipEl && containerEl) {
                        rect.addEventListener('mouseenter', (evt) => {
                            const activeH = workHours[index] || 0;
                            const breakH = breakTime[index] || 0;
                            const idleH = overtime[index] || 0;
                            const inactiveH = Math.max(0, total - (activeH + breakH + idleH));

                            tooltipEl.innerHTML = `
                                <div class="activity-tooltip-row">
                                    <span class="activity-tooltip-dot" style="background:#A7F3D0;"></span>
                                    <span>${formatHours(activeH)}</span>
                                </div>
                                <div class="activity-tooltip-row">
                                    <span class="activity-tooltip-dot" style="background:#FECACA;"></span>
                                    <span>${formatHours(inactiveH)}</span>
                                </div>
                                <div class="activity-tooltip-row">
                                    <span class="activity-tooltip-dot" style="background:#FDE68A;"></span>
                                    <span>${formatHours(idleH)}</span>
                                </div>
                                <div class="activity-tooltip-row">
                                    <span class="activity-tooltip-dot" style="background:#93C5FD;"></span>
                                    <span>${formatHours(breakH)}</span>
                                </div>
                            `;

                            const containerRect = containerEl.getBoundingClientRect();
                            const svgRect = svg.getBoundingClientRect();

                            // Convert SVG viewBox coords to actual rendered pixels
                            const scaleX = svgRect.width / width;
                            const scaleY = svgRect.height / height;

                            // X: exact center of this bar in pixels
                            const barCenterX = svgRect.left + (x + actualBarWidth / 2) * scaleX;
                            const relativeX = barCenterX - containerRect.left;

                            // Y: just above the bar top in pixels
                            const barTopY = svgRect.top + y * scaleY;
                            const relativeY = barTopY - containerRect.top;

                            tooltipEl.style.left = `${relativeX}px`;
                            tooltipEl.style.top = `${relativeY}px`;
                            tooltipEl.style.opacity = '1';
                        });

                        rect.addEventListener('mouseleave', () => {
                            tooltipEl.style.opacity = '0';
                        });
                    }

                    svg.appendChild(rect);
                }
                
                // Day label
                const dayText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                dayText.setAttribute('x', x + actualBarWidth / 2);
                dayText.setAttribute('y', height - padding.bottom + 20);
                dayText.setAttribute('class', 'chart-axis');
                dayText.setAttribute('text-anchor', 'middle');
                dayText.textContent = day;
                svg.appendChild(dayText);
            });
        }
        
        // Load real weekly data for hours spent chart
        function loadHoursSpentData() {
            try {
                if (pywebview && pywebview.api && pywebview.api.get_hours_spent_data) {
                    const hoursData = pywebview.api.get_hours_spent_data();
                    if (hoursData) {
                        updateHoursSpentChart(hoursData);
                    }
                }
            } catch (e) {
                console.error('Error loading hours spent data:', e);
            }
        }
        
        // Load chart data on initialization
        setTimeout(loadHoursSpentData, 1000);
        setInterval(loadHoursSpentData, 30000); // Refresh every 30 seconds
        
        // Task Category Chart Functions
        function updateTaskCategoryChart(data) {
            const svg = document.getElementById('horizontal-bar-chart');
            if (!svg || !data) return;
            
            svg.innerHTML = '';
            
            const width = 600;
            const height = 120;
            const padding = { top: 10, right: 40, bottom: 30, left: 100 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            
            const categories = data.categories || ['Mobile App', 'Website', 'Dashboard'];
            const counts = data.counts || [0, 0, 0];
            
            // Update legend
            document.getElementById('category-mobile').textContent = `Mobile App: ${counts[0] || 0}`;
            document.getElementById('category-website').textContent = `Website: ${counts[1] || 0}`;
            document.getElementById('category-dashboard').textContent = `Dashboard: ${counts[2] || 0}`;
            
            const maxValue = Math.max(...counts, 250);
            const scale = chartWidth / maxValue;
            
            const barHeight = chartHeight / categories.length;
            const barSpacing = barHeight * 0.3;
            const actualBarHeight = barHeight - barSpacing;
            
            // Draw grid lines
            for (let i = 0; i <= 5; i++) {
                const x = padding.left + (chartWidth / 5) * i;
                const value = (maxValue / 5) * i;
                
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x);
                line.setAttribute('y1', padding.top);
                line.setAttribute('x2', x);
                line.setAttribute('y2', height - padding.bottom);
                line.setAttribute('class', 'chart-grid');
                svg.appendChild(line);
                
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', x);
                text.setAttribute('y', height - padding.bottom + 20);
                text.setAttribute('class', 'chart-axis');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = value;
                svg.appendChild(text);
            }
            
            // Draw bars
            const colors = ['#3B82F6', '#10B981', '#FBBF24'];
            categories.forEach((category, index) => {
                const y = padding.top + index * barHeight + barSpacing / 2;
                const barWidth = counts[index] * scale;
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', padding.left);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth);
                rect.setAttribute('height', actualBarHeight);
                rect.setAttribute('fill', colors[index] || '#3B82F6');
                rect.setAttribute('class', 'horizontal-bar');
                svg.appendChild(rect);
                
                // Category label
                const labelText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                labelText.setAttribute('x', padding.left - 10);
                labelText.setAttribute('y', y + actualBarHeight / 2 + 4);
                labelText.setAttribute('class', 'chart-axis');
                labelText.setAttribute('text-anchor', 'end');
                labelText.textContent = category;
                svg.appendChild(labelText);
            });
        }
        
        // Load chart data on initialization
        setTimeout(loadHoursSpentData, 1000);
        setInterval(loadHoursSpentData, 30000); // Refresh every 30 seconds
        
        // API functions
        function startBreak() {
            const btn = document.getElementById('btn-start-break');
            if (btn && !btn.disabled) {
            pywebview.api.start_break();
            }
        }
        
        function endBreak() {
            const btn = document.getElementById('btn-end-break');
            if (btn && !btn.disabled) {
            pywebview.api.end_break();
            }
        }
        
        function logout() {
            pywebview.api.logout();
        }
        
        function clockIn() {
            const btn = document.getElementById('btn-clock-in');
            if (btn && !btn.disabled) {
            pywebview.api.clock_in();
            }
        }
        
        function clockOut() {
            const btn = document.getElementById('btn-clock-out');
            if (btn && !btn.disabled) {
            pywebview.api.clock_out();
            }
        }
        
        function refreshShifts() {
            pywebview.api.refresh_shifts();
        }
        
        function showSummary() {
            pywebview.api.show_summary();
        }
        
        function refreshAttendance() {
            pywebview.api.refresh_attendance();
        }
        
        function refreshNotices() {
            try {
                pywebview.api.refresh_notices();
            } catch (e) {
                console.error('Error refreshing notices:', e);
            }
        }
        
        function onShiftChange() {
            const select = document.getElementById('shift-select');
            pywebview.api.set_shift(select.value);
        }
        
        // Update User Profile Picture
        window.updateUserProfile = function(profileData) {
            try {
                const profileImg = document.getElementById('user-profile-image');
                const onlineStatus = document.getElementById('user-online-status');
                
                if (profileData && profileImg) {
                    // Check all possible field names for profile image
                    const imageUrl = profileData.profile_image || 
                                   profileData.profile_picture || 
                                   profileData.avatar || 
                                   profileData.image_url ||
                                   profileData.photo;
                    
                    if (imageUrl && imageUrl.trim() !== '') {
                        console.log('Updating profile image with URL:', imageUrl);
                        
                        // Create a new image to test if it loads
                        const testImg = new Image();
                        testImg.crossOrigin = 'anonymous';
                        
                        testImg.onload = function() {
                            // Image loaded successfully
                            profileImg.src = imageUrl;
                            profileImg.style.display = 'block';
                            console.log('Profile image loaded successfully');
                        };
                        
                        testImg.onerror = function() {
                            // Image failed to load, try with CORS proxy or use default
                            console.warn('Profile image failed to load, trying alternative methods');
                            
                            // Try loading with timestamp to bypass cache
                            const urlWithTimestamp = imageUrl + (imageUrl.includes('?') ? '&' : '?') + 't=' + Date.now();
                            profileImg.src = urlWithTimestamp;
                            
                            // If still fails, onerror handler on img tag will use default
                        };
                        
                        // Start loading the test image
                        testImg.src = imageUrl;
                    } else {
                        console.log('No profile image URL found in profile data');
                    }
                    
                    // Update online status
                    if (onlineStatus) {
                        const isOnline = profileData.is_online !== false && profileData.status !== 'inactive';
                        onlineStatus.style.display = isOnline ? 'block' : 'none';
                        onlineStatus.style.background = isOnline ? '#10B981' : '#6B7280';
                    }
                }
            } catch (e) {
                console.error('Error updating user profile:', e);
            }
        };
        
        // Show user payload when clicking on profile
        function showUserPayload() {
            try {
                if (window.pywebview && pywebview.api && pywebview.api.get_user_profile) {
                    const result = pywebview.api.get_user_profile();
                    const handle = (payload) => {
                        try {
                            console.log('User payload:', payload);
                            // Update profile picture if available
                            if (payload && (payload.profile_image || payload.profile_picture || payload.avatar || payload.image_url)) {
                                window.updateUserProfile(payload);
                            }
                            alert(JSON.stringify(payload, null, 2));
                        } catch (e) {
                            alert('Error displaying payload. See console for details.');
                            console.error('Error displaying payload:', e, payload);
                        }
                    };
                    if (result && typeof result.then === 'function') {
                        result.then(handle).catch(err => {
                            console.error('get_user_profile error:', err);
                            alert('Failed to load user payload');
                        });
                    } else {
                        handle(result);
                    }
                } else {
                    // Try to fetch user profile from API
                    if (window.pywebview && pywebview.api && pywebview.api.fetch_user_profile) {
                        const result = pywebview.api.fetch_user_profile();
                        if (result && typeof result.then === 'function') {
                            result.then(data => {
                                if (data && data.success && data.data) {
                                    window.updateUserProfile(data.data);
                                    alert(JSON.stringify(data.data, null, 2));
                                }
                            }).catch(err => {
                                console.error('fetch_user_profile error:', err);
                                alert('Failed to load user profile');
                            });
                        }
                    } else {
                        alert('User profile API not available');
                    }
                }
            } catch (e) {
                console.error('Error in showUserPayload:', e);
                alert('Unexpected error while loading user payload');
            }
        }
        
        // Update UI from Python
        window.updateStatus = function(status) {
            const statusEl = document.getElementById('status');
            if (statusEl) {
                statusEl.textContent = status;
                if (status.includes('CLOCKED IN')) {
                    statusEl.style.background = '#D1FAE5';
                    statusEl.style.color = '#10B981';
                } else if (status.includes('ON BREAK')) {
                    statusEl.style.background = '#FEF3C7';
                    statusEl.style.color = '#F59E0B';
                } else {
                    statusEl.style.background = '#EFF6FF';
                    statusEl.style.color = '#2563EB';
                }
            }
        };
        
        window.updateBreakTime = function(time) {
            const breakTimeEl = document.getElementById('break-time-value');
            if (breakTimeEl && typeof time === 'string') {
                // Expecting HH:MM:SS, convert to HH:MM hr for the card
                const parts = time.split(':');
                if (parts.length >= 2) {
                    const hh = parts[0].padStart(2, '0');
                    const mm = parts[1].padStart(2, '0');
                    breakTimeEl.textContent = `${hh}:${mm} hr`;
                } else {
                    breakTimeEl.textContent = `${time} hr`;
                }
            }
        };
        
        window.updateActivityCounts = function(counts) {
            if (!counts || typeof counts !== 'object') return;
            try {
                const mouseClicksEl = document.getElementById('mouse-clicks-value');
                const keysCountEl = document.getElementById('keys-count-value');
                
                if (mouseClicksEl) {
                    mouseClicksEl.textContent = counts.mouse_clicks || 0;
                }
                if (keysCountEl) {
                    keysCountEl.textContent = counts.keys_count || 0;
                }
            } catch (e) {
                console.error('Error updating activity counts:', e);
            }
        };
        
        // Get app icon based on app name
        function getAppIcon(appName) {
            const name = (appName || '').toLowerCase();
            
            // Cursor
            if (name.includes('cursor')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#1E293B"/>
                    <path d="M8 8L24 24M24 8L8 24" stroke="#9333EA" stroke-width="2.5" stroke-linecap="round"/>
                    <circle cx="16" cy="16" r="4" fill="#9333EA" fill-opacity="0.2"/>
                </svg>`;
            }
            
            // Microsoft Teams
            if (name.includes('teams') || name.includes('ms-teams') || name.includes('msteams')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#6264A7"/>
                    <path d="M12 10C10.8954 10 10 10.8954 10 12V20C10 21.1046 10.8954 22 12 22H20C21.1046 22 22 21.1046 22 20V12C22 10.8954 21.1046 10 20 10H12Z" fill="white" fill-opacity="0.2"/>
                    <circle cx="16" cy="16" r="5" fill="white" fill-opacity="0.3"/>
                    <path d="M14 16L15.5 17.5L18 15" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
            }
            
            // Lock App / Screen Lock
            if (name.includes('lock') || name.includes('lockapp') || name.includes('screen')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#4B5563"/>
                    <rect x="10" y="14" width="12" height="10" rx="2" fill="white" fill-opacity="0.2"/>
                    <path d="M13 14V10C13 8.34315 14.3431 7 16 7C17.6569 7 19 8.34315 19 10V14" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="16" cy="19" r="2" fill="white"/>
                </svg>`;
            }
            
            // Python
            if (name.includes('python') || name.includes('python3')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#3776AB"/>
                    <path d="M14 8C12.8954 8 12 8.89543 12 10V12C12 13.1046 12.8954 14 14 14H18C19.1046 14 20 13.1046 20 12V10C20 8.89543 19.1046 8 18 8H14Z" fill="white" fill-opacity="0.3"/>
                    <path d="M14 18C12.8954 18 12 18.8954 12 20V22C12 23.1046 12.8954 24 14 24H18C19.1046 24 20 23.1046 20 22V20C20 18.8954 19.1046 18 18 18H14Z" fill="#FFD43B"/>
                    <circle cx="15" cy="11" r="1" fill="white"/>
                    <circle cx="17" cy="21" r="1" fill="#3776AB"/>
                </svg>`;
            }
            
            // Chrome / Browser
            if (name.includes('chrome') || name.includes('browser') || name.includes('edge') || name.includes('firefox')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#4285F4"/>
                    <circle cx="16" cy="16" r="8" fill="white" fill-opacity="0.2"/>
                    <path d="M16 8L22 20H10L16 8Z" fill="white" fill-opacity="0.3"/>
                    <circle cx="16" cy="16" r="3" fill="white"/>
                </svg>`;
            }
            
            // VS Code / Code Editor
            if (name.includes('code') || name.includes('vscode') || name.includes('visual studio')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#007ACC"/>
                    <path d="M10 10L22 16L10 22V10Z" fill="white" fill-opacity="0.8"/>
                </svg>`;
            }
            
            // Figma
            if (name.includes('figma')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#0ACF83"/>
                    <rect x="8" y="8" width="8" height="8" rx="2" fill="#A259FF"/>
                    <rect x="16" y="8" width="8" height="8" rx="2" fill="#F24E1E"/>
                    <rect x="8" y="16" width="8" height="8" rx="2" fill="#FF7262"/>
                    <rect x="16" y="16" width="8" height="8" rx="2" fill="#1ABCFE"/>
                </svg>`;
            }
            
            // Excel / Google Sheets
            if (name.includes('excel') || name.includes('sheets') || name.includes('spreadsheet')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#217346"/>
                    <path d="M8 8H24V24H8V8Z" fill="white" fill-opacity="0.1"/>
                    <path d="M10 10H22M10 13H22M10 16H22M10 19H22" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="13" y1="10" x2="13" y2="22" stroke="white" stroke-width="1.5"/>
                </svg>`;
            }
            
            // Google Meet
            if (name.includes('meet') || name.includes('google meet')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#00832D"/>
                    <circle cx="16" cy="16" r="8" fill="white" fill-opacity="0.15"/>
                    <path d="M16 10L19 13L16 16L13 13L16 10Z" fill="#00832D"/>
                    <path d="M19 13L22 16L19 19L16 16L19 13Z" fill="#1BA37E"/>
                    <path d="M16 16L19 19L16 22L13 19L16 16Z" fill="#FCC934"/>
                    <path d="M13 13L16 16L13 19L10 16L13 13Z" fill="#EA4335"/>
                    <circle cx="16" cy="16" r="3" fill="white"/>
                </svg>`;
            }
            
            // WhatsApp
            if (name.includes('whatsapp') || name.includes('watsapp')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#25D366"/>
                    <path d="M16 8C11.6 8 8 11.6 8 16C8 17.8 8.6 19.4 9.4 20.8L8 24L11.4 22.6C12.8 23.4 14.4 24 16 24C20.4 24 24 20.4 24 16C24 11.6 20.4 8 16 8Z" fill="white" fill-opacity="0.2"/>
                    <path d="M16 10C12.7 10 10 12.7 10 16C10 17.3 10.4 18.5 11.1 19.5L10 22L12.6 20.9C13.6 21.6 14.8 22 16 22C19.3 22 22 19.3 22 16C22 12.7 19.3 10 16 10Z" fill="white"/>
                    <circle cx="13.5" cy="15.5" r="1" fill="#25D366"/>
                    <circle cx="18.5" cy="15.5" r="1" fill="#25D366"/>
                </svg>`;
            }
            
            // BookMyShow
            if (name.includes('bookmyshow') || name.includes('book my show')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#E50914"/>
                    <path d="M10 12H22V20H10V12Z" fill="white" fill-opacity="0.2"/>
                    <path d="M12 14H20M12 16H20M12 18H18" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                </svg>`;
            }
            
            // Windows / System Apps
            if (name.includes('picker') || name.includes('handler') || name.includes('host') || name.includes('crs')) {
                return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="32" height="32" rx="6" fill="#4B5563"/>
                    <rect x="8" y="8" width="16" height="16" rx="2" fill="white" fill-opacity="0.2"/>
                    <rect x="10" y="10" width="4" height="4" rx="1" fill="white" fill-opacity="0.4"/>
                    <rect x="16" y="10" width="4" height="4" rx="1" fill="white" fill-opacity="0.4"/>
                    <rect x="22" y="10" width="4" height="4" rx="1" fill="white" fill-opacity="0.4"/>
                    <rect x="10" y="16" width="4" height="4" rx="1" fill="white" fill-opacity="0.4"/>
                    <rect x="16" y="16" width="4" height="4" rx="1" fill="white" fill-opacity="0.4"/>
                    <rect x="22" y="16" width="4" height="4" rx="1" fill="white" fill-opacity="0.4"/>
                </svg>`;
            }
            
            // Default icon - dark grey square
            return `<svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="32" height="32" rx="6" fill="#4B5563"/>
                <rect x="8" y="8" width="16" height="16" rx="2" fill="white" fill-opacity="0.2"/>
            </svg>`;
        }
        
        // Get background color based on category/productivity
        function getAppBackgroundColor(name, category) {
            const nameLower = (name || '').toLowerCase();
            const catLower = (category || '').toLowerCase();
            
            // Productive apps - light green
            if (nameLower.includes('figma') || nameLower.includes('excel') || nameLower.includes('sheets') || 
                catLower.includes('productive') || catLower.includes('work')) {
                return '#D1FAE5';
            }
            
            // Unproductive apps - light red (social media, entertainment, etc.)
            const unproductiveKeywords = [
                'whatsapp', 'watsapp', 'instagram', 'insta', 'ig', 'facebook', 'twitter', 'x.com',
                'bookmyshow', 'book my show', 'youtube', 'netflix', 'spotify', 'snapchat',
                'tiktok', 'pinterest', 'reddit', 'telegram', 'discord', 'messenger', 'linkedin'
            ];
            
            if (unproductiveKeywords.some(keyword => nameLower.includes(keyword)) ||
                catLower.includes('unproductive') || catLower.includes('social')) {
                return '#FECACA';
            }
            
            // Neutral - light gray
            return '#F3F4F6';
        }
        
        // Get actual app icon from system
        async function getActualAppIcon(appName, processName) {
            try {
                if (window.pywebview && pywebview.api && pywebview.api.get_app_icon) {
                    const result = await pywebview.api.get_app_icon(appName, processName);
                    if (result && result.success && result.icon) {
                        return result.icon; // Base64 encoded icon
                    }
                }
            } catch (e) {
                console.error('Error getting app icon:', e);
            }
            return null;
        }
        
        // Update Application Usage Overview
        window.updateAppUsage = async function(items) {
            const container = document.getElementById('app-usage-list');
            if (!container) return;
            container.innerHTML = '';
            if (!items || !items.length) {
                container.innerHTML = '<div style="text-align:center; color:#9CA3AF; padding: 12px;">No usage data</div>';
                return;
            }
            
            // Process items and get icons (with rate limiting to prevent hanging)
            for (let idx = 0; idx < items.length; idx++) {
                const item = items[idx];
                const bg = getAppBackgroundColor(item.name, item.category);
                const name = item.name || 'App';
                const category = item.category || 'Application';
                const duration = item.duration || item.time || '00:00:00';
                
                // Use fallback icon by default (faster, prevents hanging)
                let iconHtml = getAppIcon(item.name);
                const processName = item.process_name || item.exe_name;
                
                // Only fetch actual icon for first 5 apps to prevent hanging
                // Rest will use fallback icons
                if (processName && idx < 5) {
                    try {
                        // Add delay between icon fetches to prevent blocking
                        if (idx > 0) {
                            await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
                        }
                        
                        // Set timeout for icon fetch (max 2 seconds)
                        const iconPromise = getActualAppIcon(name, processName);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), 2000)
                        );
                        
                        const actualIcon = await Promise.race([iconPromise, timeoutPromise]);
                        if (actualIcon) {
                            iconHtml = `<img src="${actualIcon}" style="width:32px; height:32px; border-radius:6px; object-fit:cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div style="display:none;">${iconHtml}</div>`;
                        }
                    } catch (e) {
                        // Silently fail and use fallback icon
                        console.debug('Using fallback icon for', name);
                    }
                }
                
                const row = document.createElement('div');
                row.style.cssText = `display:flex; align-items:center; gap:12px; padding:12px; background:${bg}; border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);`;
                row.innerHTML = `
                    <div style="width:32px; height:32px; flex-shrink:0; display:flex; align-items:center; justify-content:center; border-radius:6px; overflow:hidden; background:#4B5563;">
                        ${iconHtml}
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div style="font-size:14px; font-weight:600; color:#1F2937; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${name}</div>
                        <div style="font-size:12px; color:#6B7280;">${category}</div>
                    </div>
                    <div style="font-size:13px; font-weight:600; color:#1F2937; white-space:nowrap; flex-shrink:0;">${duration}</div>
                `;
                container.appendChild(row);
            }
            
            // Update productivity distribution based on app usage
            updateProductivityDistribution(items);
        };
        
        // Calculate and update productivity distribution
        function updateProductivityDistribution(appItems) {
            if (!appItems || !appItems.length) {
                // Default values
                renderDonutChart(35, 40, 25);
                updateTopWebsites([]);
                return;
            }
            
            // Calculate total time in seconds
            let totalSeconds = 0;
            let productiveSeconds = 0;
            let unproductiveSeconds = 0;
            let neutralSeconds = 0;
            
            const productiveApps = ['figma', 'excel', 'word', 'powerpoint', 'code', 'cursor', 'python', 'visual studio', 'notepad++', 'slack', 'teams', 'outlook'];
            // Social media and unproductive apps
            const unproductiveApps = [
                // Social Media
                'whatsapp', 'watsapp', 'facebook', 'instagram', 'insta', 'ig', 'twitter', 'x.com', 'linkedin', 
                'snapchat', 'tiktok', 'pinterest', 'reddit', 'telegram', 'discord', 'messenger',
                'wechat', 'viber', 'line', 'skype', 'zoom', 'meet', 'google meet',
                // Entertainment
                'youtube', 'netflix', 'spotify', 'bookmyshow', 'prime video', 'hotstar', 'zee5',
                'sony liv', 'voot', 'mx player', 'jio cinema', 'disney', 'hulu',
                // Gaming
                'steam', 'epic games', 'battlenet', 'origin', 'uplay', 'gog', 'twitch',
                // Shopping/Other distractions
                'amazon', 'flipkart', 'myntra', 'swiggy', 'zomato', 'uber', 'ola'
            ];
            
            const websiteData = {};
            
            appItems.forEach(item => {
                const seconds = item.seconds || parseDurationToSeconds(item.duration || item.time || '00:00:00');
                totalSeconds += seconds;
                
                const nameLower = (item.name || '').toLowerCase();
                const isWebsite = nameLower.includes('.com') || nameLower.includes('.net') || nameLower.includes('web.');
                
                if (isWebsite) {
                    // Extract domain name
                    let domain = nameLower;
                    if (domain.includes('www.')) domain = domain.replace('www.', '');
                    if (domain.includes('web.')) domain = domain.replace('web.', '');
                    const domainParts = domain.split('.');
                    if (domainParts.length >= 2) {
                        domain = domainParts.slice(-2).join('.');
                    }
                    if (!websiteData[domain]) {
                        websiteData[domain] = 0;
                    }
                    websiteData[domain] += seconds;
                }
                
                // Categorize productivity
                let isProductive = false;
                let isUnproductive = false;
                
                for (const prodApp of productiveApps) {
                    if (nameLower.includes(prodApp)) {
                        isProductive = true;
                        break;
                    }
                }
                
                if (!isProductive) {
                    for (const unprodApp of unproductiveApps) {
                        if (nameLower.includes(unprodApp)) {
                            isUnproductive = true;
                            break;
                        }
                    }
                }
                
                if (isProductive) {
                    productiveSeconds += seconds;
                } else if (isUnproductive) {
                    unproductiveSeconds += seconds;
                } else {
                    neutralSeconds += seconds;
                }
            });
            
            // Calculate percentages
            let productivePct = 0;
            let unproductivePct = 0;
            let neutralPct = 0;
            
            if (totalSeconds > 0) {
                productivePct = Math.round((productiveSeconds / totalSeconds) * 100);
                unproductivePct = Math.round((unproductiveSeconds / totalSeconds) * 100);
                neutralPct = Math.round((neutralSeconds / totalSeconds) * 100);
            } else {
                // Default values if no data
                productivePct = 35;
                unproductivePct = 40;
                neutralPct = 25;
            }
            
            // Render donut chart
            renderDonutChart(productivePct, unproductivePct, neutralPct);
            
            // Update top websites
            const topWebsites = Object.entries(websiteData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([domain, seconds]) => ({
                    domain: domain,
                    percentage: totalSeconds > 0 ? Math.round((seconds / totalSeconds) * 100) : 0
                }));
            
            updateTopWebsites(topWebsites);
        }
        
        // Parse duration string (HH:MM:SS) to seconds
        function parseDurationToSeconds(duration) {
            if (!duration) return 0;
            const parts = duration.split(':');
            if (parts.length === 3) {
                return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
            } else if (parts.length === 2) {
                return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            }
            return 0;
        }
        
        // Render donut chart
        function renderDonutChart(productivePct, unproductivePct, neutralPct) {
            const svg = document.getElementById('donut-chart');
            const legend = document.getElementById('donut-legend');
            if (!svg || !legend) return;
            
            // Clear previous content
            svg.innerHTML = '';
            legend.innerHTML = '';
            
            const centerX = 100;
            const centerY = 100;
            const radius = 70;
            const innerRadius = 50;
            
            const data = [
                { value: productivePct, color: '#10B981', label: 'Productive' },
                { value: unproductivePct, color: '#EF4444', label: 'Unproductive' },
                { value: neutralPct, color: '#F59E0B', label: 'Neutral' }
            ];
            
            let currentAngle = -90; // Start from top
            
            data.forEach((item, index) => {
                if (item.value <= 0) return;
                
                const angle = (item.value / 100) * 360;
                const startAngle = currentAngle;
                const endAngle = currentAngle + angle;
                
                const startAngleRad = (startAngle * Math.PI) / 180;
                const endAngleRad = (endAngle * Math.PI) / 180;
                
                const x1 = centerX + radius * Math.cos(startAngleRad);
                const y1 = centerY + radius * Math.sin(startAngleRad);
                const x2 = centerX + radius * Math.cos(endAngleRad);
                const y2 = centerY + radius * Math.sin(endAngleRad);
                
                const x3 = centerX + innerRadius * Math.cos(endAngleRad);
                const y3 = centerY + innerRadius * Math.sin(endAngleRad);
                const x4 = centerX + innerRadius * Math.cos(startAngleRad);
                const y4 = centerY + innerRadius * Math.sin(startAngleRad);
                
                const largeArcFlag = angle > 180 ? 1 : 0;
                
                const pathData = `M ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} L ${x3} ${y3} A ${innerRadius} ${innerRadius} 0 ${largeArcFlag} 0 ${x4} ${y4} Z`;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                svg.appendChild(path);
                
                // Add legend item
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <span class="legend-color" style="background: ${item.color};"></span>
                    <span>${item.value}% ${item.label}</span>
                `;
                legend.appendChild(legendItem);
                
                currentAngle = endAngle;
            });
        }
        
        // Update top websites list
        function updateTopWebsites(websites) {
            const container = document.getElementById('top-websites-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!websites || !websites.length) {
                container.innerHTML = '<div style="text-align:center; color:#9CA3AF; padding: 12px; font-size: 12px;">No website data</div>';
                return;
            }
            
            // Color mapping for websites
            const colorMap = {
                'whatsapp.com': '#10B981',
                'watsapp.com': '#EF4444',
                'bookmyshow.com': '#F59E0B',
                'figma.com': '#6B7280',
                'insightful.com': '#3B82F6',
                'app.insightfulo': '#3B82F6'
            };
            
            websites.forEach(website => {
                const domain = website.domain;
                const percentage = website.percentage;
                const width = Math.min(percentage, 100);
                
                // Get color for this domain
                let color = '#6B7280'; // Default gray
                for (const [key, value] of Object.entries(colorMap)) {
                    if (domain.includes(key)) {
                        color = value;
                        break;
                    }
                }
                
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; align-items: center; gap: 8px;';
                item.innerHTML = `
                    <div style="width: ${width}%; height: 24px; background: ${color}; border-radius: 4px; display: flex; align-items: center; padding: 0 10px; color: white; font-size: 11px; font-weight: 600;">
                        <span style="flex: 1;">${domain}</span>
                        <span>${percentage}%</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        window.updateActiveApps = function(apps) {
            const activeAppsEl = document.getElementById('active-apps');
            if (activeAppsEl) {
                activeAppsEl.textContent = `Active Apps: ${apps}`;
            }
        };
        
        window.updateIdleWarning = function(warning) {
            const idleEl = document.getElementById('idle-warning');
            if (idleEl) {
                idleEl.textContent = `Idle Warning: ${warning}`;
            }
        };

        // Update Shift / Session / Worked / Break overview cards
        window.updateShiftOverview = function(data) {
            if (!data || typeof data !== 'object') return;
            try {
                const shiftNameEl = document.getElementById('shift-name');
                const shiftTimeEl = document.getElementById('shift-time');
                const sessionStartEl = document.getElementById('session-start-value');
                const workedTodayValEl = document.getElementById('worked-today-value');
                const workedTodayBadgeEl = document.getElementById('worked-today-badge');
                const breakTimeValEl = document.getElementById('break-time-value');
                const breakTimeBadgeEl = document.getElementById('break-time-badge');

                if (shiftNameEl) {
                    shiftNameEl.textContent = data.shift_label || 'General Shift';
                }
                if (shiftTimeEl) {
                    shiftTimeEl.textContent = data.shift_time || '';
                }
                if (sessionStartEl) {
                    sessionStartEl.textContent = data.session_start || '-';
                }
                if (workedTodayValEl) {
                    workedTodayValEl.textContent = data.worked_today || '00:00 hr';
                }
                if (workedTodayBadgeEl && data.worked_pct) {
                    workedTodayBadgeEl.textContent = data.worked_pct;
                }
                if (breakTimeValEl && data.break_time_hr) {
                    // Card-friendly "00:00 hr" text
                    breakTimeValEl.textContent = data.break_time_hr;
                }
                if (breakTimeBadgeEl && data.break_pct) {
                    breakTimeBadgeEl.textContent = data.break_pct;
                }
            } catch (e) {
                console.error('Error updating shift overview:', e);
            }
        };
        
        window.updateShifts = function(shifts, selected) {
            const select = document.getElementById('shift-select');
            if (!select) return;
            select.innerHTML = '';
            if (shifts.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Loading...';
                select.appendChild(option);
            } else {
                shifts.forEach(shift => {
                    const option = document.createElement('option');
                    option.value = shift.id;
                    option.textContent = shift.name;
                    if (shift.id === selected) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            }
        };
        
        window.updateWorkPeriods = function(periods) {
            const container = document.getElementById('work-periods');
            if (!container) return;
            container.innerHTML = '';
            if (periods.length === 0) {
                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = '<div style="color: #9CA3AF;"></div><div style="color: #9CA3AF;"></div>';
                container.appendChild(row);
            } else {
                periods.forEach(period => {
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.innerHTML = `<div>${period.in || ''}</div><div>${period.out || ''}</div>`;
                    container.appendChild(row);
                });
            }
        };
        
        window.updateBreaks = function(breaks) {
            const container = document.getElementById('breaks');
            if (!container) return;
            container.innerHTML = '';
            if (breaks.length === 0) {
                const row = document.createElement('div');
                row.className = 'table-row';
                row.innerHTML = '<div style="color: #9CA3AF;"></div><div style="color: #9CA3AF;"></div>';
                container.appendChild(row);
            } else {
                breaks.forEach(br => {
                    const row = document.createElement('div');
                    row.className = 'table-row';
                    row.innerHTML = `<div>${br.start || ''}</div><div>${br.end || ''}</div>`;
                    container.appendChild(row);
                });
            }
        };
        
        window.updateNotices = function(notices) {
            const container = document.getElementById('notices-list');
            if (!container) return;
            container.innerHTML = '';
            if (!notices || notices.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9CA3AF; padding: 20px;">No announcements</div>';
                return;
            }
            notices.forEach(n => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 12px 0; border-bottom: 1px solid #E5E7EB;';
                const title = document.createElement('div');
                title.style.cssText = 'font-weight: 600; color: #1F2937; margin-bottom: 4px;';
                title.textContent = n.title || 'Announcement';
                const msg = document.createElement('div');
                msg.style.cssText = 'font-size: 14px; color: #4B5563; margin-bottom: 4px;';
                msg.textContent = n.message || '';
                const meta = document.createElement('div');
                meta.style.cssText = 'font-size: 12px; color: #6B7280;';
                meta.textContent = n.valid_till ? `Valid till: ${n.valid_till}` : (n.status ? `Status: ${n.status}` : '');
                item.appendChild(title);
                item.appendChild(msg);
                item.appendChild(meta);
                container.appendChild(item);
            });
        };
        
        // Update Messages (Teams notifications)
        window.updateMessages = function(messages) {
            const container = document.getElementById('messages-list');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!messages || !messages.length) {
                container.innerHTML = '<div style="text-align:center; color:#9CA3AF; padding: 20px;">No messages</div>';
                return;
            }
            
            messages.forEach(msg => {
                const item = document.createElement('div');
                item.className = 'list-item';
                
                // Highlight new messages
                const isNew = msg.is_new || false;
                const bgColor = isNew ? '#EFF6FF' : 'transparent';
                const borderLeft = isNew ? '3px solid #3B82F6' : 'none';
                
                item.style.cssText = `padding: 12px 0; padding-left: ${isNew ? '12px' : '0'}; border-bottom: 1px solid #E5E7EB; border-left: ${borderLeft}; cursor: pointer; transition: background-color 0.2s; background-color: ${bgColor};`;
                item.onmouseover = function() { this.style.backgroundColor = '#F9FAFB'; };
                item.onmouseout = function() { this.style.backgroundColor = bgColor; };
                
                // Add click handler to open Teams chat
                item.onclick = function() {
                    try {
                        const chatId = msg.chat_id || '';
                        const chatIdentifier = msg.chat_identifier || msg.sender || '';
                        pywebview.api.open_teams_chat(chatIdentifier, chatId);
                    } catch (e) {
                        console.error('Error opening Teams chat:', e);
                    }
                };
                
                const title = document.createElement('div');
                title.className = 'list-item-title';
                title.style.cssText = 'font-weight: 600; color: #1F2937; margin-bottom: 4px; font-size: 14px; display: flex; align-items: center; gap: 8px;';
                
                // Add new message indicator
                if (msg.is_new) {
                    const newBadge = document.createElement('span');
                    newBadge.style.cssText = 'width: 8px; height: 8px; background: #3B82F6; border-radius: 50%; display: inline-block;';
                    newBadge.title = 'New message';
                    title.appendChild(newBadge);
                }
                
                const senderText = document.createElement('span');
                senderText.textContent = msg.sender || 'Unknown';
                title.appendChild(senderText);
                
                const time = document.createElement('div');
                time.className = 'list-item-time';
                time.style.cssText = 'font-size: 13px; color: #6B7280; line-height: 1.4;';
                
                // Format: "Time: Message content"
                const timeStr = msg.time || '';
                const messageStr = msg.message || 'New message';
                const fullMessage = msg.full_message || messageStr;
                
                // Show time and message separately for better readability
                if (timeStr) {
                    time.innerHTML = `<span style="color: #9CA3AF; font-size: 12px;">${timeStr}</span>: ${messageStr}`;
                } else {
                    time.textContent = messageStr;
                }
                
                // Add tooltip with full message
                if (fullMessage && fullMessage !== messageStr) {
                    item.title = fullMessage;
                }
                
                item.appendChild(title);
                item.appendChild(time);
                container.appendChild(item);
            });
        };
        
        // Update user name in the welcome banner and avatar
        window.updateUserName = function(firstName, lastName) {
            try {
                const fn = (firstName || '').toString().trim();
                const ln = (lastName || '').toString().trim();
                currentUserFirstName = fn;
                currentUserLastName = ln;
                const fullName = (fn + ' ' + ln).trim() || 'User';
                
                const avatarEl = document.querySelector('.user-menu');
                if (avatarEl && fullName) {
                    avatarEl.textContent = fullName.charAt(0).toUpperCase();
                }
                
                // Update greeting text based on current time + new name
                updateGreetingBanner();
            } catch (e) {
                console.error('Error updating user name:', e);
            }
        };
        
        function applyUserNameFromProfile(profile) {
            if (!profile || typeof profile !== 'object') return;
            const first = profile.first_name || profile.firstName || '';
            const last = profile.last_name || profile.lastName || '';
            updateUserName(first, last);
        }
        
        // Fetch profile (first_name, last_name) from Python via pywebview
        function loadUserNameFromPython() {
            try {
                if (!window.pywebview || !pywebview.api || !pywebview.api.get_user_profile) {
                    return;
                }
                const result = pywebview.api.get_user_profile();
                // Handle both sync and Promise-style APIs
                if (result && typeof result.then === 'function') {
                    result.then(applyUserNameFromProfile).catch(err => console.error('get_user_profile error:', err));
                } else {
                    applyUserNameFromProfile(result);
                }
            } catch (e) {
                console.error('Error loading user name from Python:', e);
            }
        }
        
        // Show full user payload when clicking on user avatar
        function showUserPayload() {
            try {
                if (!window.pywebview || !pywebview.api || !pywebview.api.get_user_profile) {
                    alert('User profile API not available');
                    return;
                }
                const result = pywebview.api.get_user_profile();
                const handle = (payload) => {
                    try {
                        console.log('User payload:', payload);
                        alert(JSON.stringify(payload, null, 2));
                    } catch (e) {
                        alert('Error displaying payload. See console for details.');
                        console.error('Error displaying payload:', e, payload);
                    }
                };
                if (result && typeof result.then === 'function') {
                    result.then(handle).catch(err => {
                        console.error('get_user_profile error:', err);
                        alert('Failed to load user payload');
                    });
                } else {
                    handle(result);
                }
            } catch (e) {
                console.error('Error in showUserPayload:', e);
                alert('Unexpected error while loading user payload');
            }
        }
        
        window.updateButtonStates = function(states) {
            const btnClockIn = document.getElementById('btn-clock-in');
            const btnClockOut = document.getElementById('btn-clock-out');
            const btnStartBreak = document.getElementById('btn-start-break');
            const btnEndBreak = document.getElementById('btn-end-break');
            
            if (!btnClockIn || !btnClockOut || !btnStartBreak || !btnEndBreak) return;
            
            btnClockIn.disabled = !states.clockIn;
            btnClockOut.disabled = !states.clockOut;
            btnStartBreak.disabled = !states.startBreak;
            btnEndBreak.disabled = !states.endBreak;
            
            btnClockIn.className = states.clockIn ? 'btn btn-primary' : 'btn';
            btnClockOut.className = states.clockOut ? 'btn btn-clock-out' : 'btn';
            btnStartBreak.className = states.startBreak ? 'btn btn-primary' : 'btn';
            btnEndBreak.className = states.endBreak ? 'btn btn-success' : 'btn';
        };
        
        // Auto-refresh
        let buttonRefreshInterval = null;
        let attendanceRefreshInterval = null;
        let noticesRefreshInterval = null;
        
        function startAutoRefresh() {
            if (buttonRefreshInterval) clearInterval(buttonRefreshInterval);
            buttonRefreshInterval = setInterval(() => {
                try {
                    pywebview.api.refresh_button_states();
                } catch (e) {
                    console.error('Button refresh error:', e);
                }
            }, 500);
            
            if (attendanceRefreshInterval) clearInterval(attendanceRefreshInterval);
            attendanceRefreshInterval = setInterval(() => {
                try {
                    pywebview.api.refresh_attendance();
                } catch (e) {
                    console.error('Auto-refresh error:', e);
                }
            }, 30000);

            if (noticesRefreshInterval) clearInterval(noticesRefreshInterval);
            noticesRefreshInterval = setInterval(() => {
                try {
                    pywebview.api.refresh_notices();
                } catch (e) {
                    console.error('Notices refresh error:', e);
                }
            }, 60000); // refresh announcements every 60s
        }
        
        function initializeApp() {
            try {
                if (pywebview && pywebview.api) {
                    pywebview.api.initialize();
                    startAutoRefresh();
                    setTimeout(() => {
                        try {
                            pywebview.api.refresh_button_states();
                        } catch (e) {
                            console.error('Error refreshing button states on init:', e);
                        }
                    }, 500);
                    // Also load the user name and notices for the welcome banner/right rail
                    setTimeout(loadUserNameFromPython, 700);
                    setTimeout(() => {
                        try {
                            pywebview.api.refresh_notices();
                        } catch (e) {
                            console.error('Error refreshing notices on init:', e);
                        }
                    }, 900);
                } else {
                    setTimeout(initializeApp, 100);
                }
            } catch (e) {
                console.error('Error initializing app:', e);
                setTimeout(initializeApp, 100);
            }
        }
        
        // Maximize window on button click
        function maximizeWindowOnClick() {
            try {
                if (typeof pywebview !== 'undefined' && pywebview.api && pywebview.api.maximize_window) {
                    pywebview.api.maximize_window();
                }
            } catch (e) {
                console.error('Error maximizing window:', e);
            }
        }
        
        // Add click event listener to all buttons
        function setupButtonMaximize() {
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(setupButtonMaximize, 100);
                });
                return;
            }
            
            // Add click listener to all buttons
            const buttons = document.querySelectorAll('button, .btn, .nav-item, .kanban-add-btn, .kanban-add-task-btn, .project-new-btn, .project-menu-btn, .modal-close, .btn-primary, .btn-secondary');
            buttons.forEach(button => {
                // Remove existing listener if any to avoid duplicates
                button.removeEventListener('click', maximizeWindowOnClick);
                // Add new listener
                button.addEventListener('click', maximizeWindowOnClick, true); // Use capture phase
            });
            
            // Also listen for dynamically added buttons
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            if (node.tagName === 'BUTTON' || node.classList.contains('btn') || node.classList.contains('nav-item')) {
                                node.addEventListener('click', maximizeWindowOnClick, true);
                            }
                            // Check for buttons inside added nodes
                            const buttons = node.querySelectorAll && node.querySelectorAll('button, .btn, .nav-item');
                            if (buttons) {
                                buttons.forEach(btn => {
                                    btn.addEventListener('click', maximizeWindowOnClick, true);
                                });
                            }
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        
        // Setup button maximize after a short delay to ensure DOM is ready
        setTimeout(setupButtonMaximize, 500);
        
        window.addEventListener('beforeunload', () => {
            if (buttonRefreshInterval) clearInterval(buttonRefreshInterval);
            if (attendanceRefreshInterval) clearInterval(attendanceRefreshInterval);
            if (noticesRefreshInterval) clearInterval(noticesRefreshInterval);
        });
        
        // Calendar Functions
        let currentWeekStart = new Date();
        let calendarEvents = [];
        
        // Initialize calendar week start (Monday of current week)
        function initCalendarWeek() {
            const today = new Date();
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            currentWeekStart = new Date(today.setDate(diff));
            currentWeekStart.setHours(0, 0, 0, 0);
        }
        
        // Render calendar time slots
        function renderCalendarTimeSlots() {
            const timeSlotsContainer = document.getElementById('calendarTimeSlots');
            if (!timeSlotsContainer) return;
            
            const hours = [];
            for (let h = 9; h <= 16; h++) {
                hours.push(h);
            }
            
            timeSlotsContainer.innerHTML = hours.map(hour => {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                return `
                    <div class="calendar-time-slot" data-hour="${hour}">
                        <div class="calendar-time-label">${timeStr}</div>
                        ${[0, 1, 2, 3, 4, 5, 6].map(dayIndex => {
                            const dayDate = new Date(currentWeekStart);
                            dayDate.setDate(currentWeekStart.getDate() + dayIndex);
                            const isToday = isSameDay(dayDate, new Date());
                            return `<div class="calendar-day-cell ${isToday ? 'highlighted' : ''}" data-day="${dayIndex}" data-date="${dayDate.toISOString()}"></div>`;
                        }).join('')}
                    </div>
                `;
            }).join('');
            
            // Render events
            renderCalendarEvents();
            
            // Update current time indicator
            updateCurrentTimeIndicator();
        }
        
        // Update calendar day headers
        function updateCalendarHeaders() {
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(currentWeekStart);
                dayDate.setDate(currentWeekStart.getDate() + i);
                
                const dayHeader = document.getElementById(`day-${i}`);
                const dateElement = document.getElementById(`date-${i}`);
                
                if (dayHeader && dateElement) {
                    const dayName = dayHeader.querySelector('.calendar-day-name');
                    if (dayName) dayName.textContent = dayNames[i];
                    dateElement.textContent = dayDate.getDate();
                    
                    // Highlight today
                    if (isSameDay(dayDate, today)) {
                        dayHeader.classList.add('highlighted');
                    } else {
                        dayHeader.classList.remove('highlighted');
                    }
                }
            }
        }
        
        // Check if two dates are the same day
        function isSameDay(date1, date2) {
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }
        
        // Render calendar events from tasks
        async function renderCalendarEvents() {
            // Clear existing events first
            document.querySelectorAll('.calendar-event').forEach(el => el.remove());
            
            try {
                // Fetch tasks from API
                let tasks = [];
                if (window.pywebview && window.pywebview.api && window.pywebview.api.fetch_tasks) {
                    console.log('[CALENDAR] Fetching tasks for calendar...');
                    const result = await window.pywebview.api.fetch_tasks();
                    console.log('[CALENDAR] Tasks fetch result:', result);
                    
                    if (result && result.success && result.tasks && Array.isArray(result.tasks)) {
                        tasks = result.tasks;
                        console.log(`[CALENDAR] Loaded ${tasks.length} tasks`);
                    } else {
                        console.warn('[CALENDAR] No tasks found or API error:', result);
                    }
                } else {
                    console.warn('[CALENDAR] pywebview API not available');
                }
                
                // Convert tasks to calendar events
                calendarEvents = [];
                
                tasks.forEach(task => {
                    // Get task due date or start date
                    let taskDate = null;
                    
                    if (task.due_date) {
                        taskDate = new Date(task.due_date);
                    } else if (task.start_date) {
                        taskDate = new Date(task.start_date);
                    } else if (task.created_at) {
                        taskDate = new Date(task.created_at);
                    }
                    
                    if (!taskDate || isNaN(taskDate.getTime())) {
                        console.log(`[CALENDAR] Task ${task.id || task.title} has no valid date, skipping`);
                        return;
                    }
                    
                    // Check if task date falls within current week
                    const weekStart = new Date(currentWeekStart);
                    weekStart.setHours(0, 0, 0, 0);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 7);
                    
                    if (taskDate < weekStart || taskDate >= weekEnd) {
                        return; // Task is not in current week
                    }
                    
                    // Calculate which day of the week (0 = Monday, 6 = Sunday)
                    const dayDiff = Math.floor((taskDate - weekStart) / (1000 * 60 * 60 * 24));
                    const day = dayDiff;
                    
                    if (day < 0 || day > 6) {
                        return; // Invalid day
                    }
                    
                    // Get time from task date or use default (10:00 AM)
                    let startHour = 10;
                    let startMin = 0;
                    let endHour = 11;
                    let endMin = 0;
                    
                    if (taskDate.getHours() >= 9 && taskDate.getHours() <= 16) {
                        startHour = taskDate.getHours();
                        startMin = taskDate.getMinutes();
                        endHour = startHour + 1;
                        endMin = startMin;
                    }
                    
                    // Get task title
                    const title = task.title || task.name || 'Untitled Task';
                    
                    calendarEvents.push({
                        title: title,
                        day: day,
                        startHour: startHour,
                        startMin: startMin,
                        endHour: endHour,
                        endMin: endMin,
                        task: task
                    });
                });
                
                console.log(`[CALENDAR] Rendering ${calendarEvents.length} events`);
                
                // Render events
                calendarEvents.forEach(event => {
                    // Find the starting time slot
                    const startSlot = document.querySelector(`.calendar-time-slot[data-hour="${event.startHour}"]`);
                    if (!startSlot) return;
                    
                    const startDayCell = startSlot.querySelector(`.calendar-day-cell[data-day="${event.day}"]`);
                    if (!startDayCell) return;
                    
                    // Calculate position and height
                    const slotHeight = 60; // Each time slot is 60px
                    const startMinutes = event.startHour * 60 + event.startMin;
                    const endMinutes = event.endHour * 60 + event.endMin;
                    const duration = endMinutes - startMinutes;
                    
                    // Calculate top position within the starting hour (as percentage)
                    const topPercent = (event.startMin / 60) * 100;
                    
                    // Calculate total height in pixels
                    const totalHeightPx = (duration / 60) * slotHeight;
                    
                    // Create event element
                    const eventElement = document.createElement('div');
                    eventElement.className = 'calendar-event';
                    eventElement.style.top = `${topPercent}%`;
                    eventElement.style.height = `${totalHeightPx}px`;
                    eventElement.textContent = event.title;
                    eventElement.title = event.title;
                    
                    // Add click handler to open task details
                    if (event.task && event.task.id) {
                        eventElement.style.cursor = 'pointer';
                        eventElement.onclick = () => {
                            if (window.openTaskDetailModal) {
                                window.openTaskDetailModal(event.task);
                            }
                        };
                    }
                    
                    // Make sure the day cell is positioned relatively
                    if (getComputedStyle(startDayCell).position === 'static') {
                        startDayCell.style.position = 'relative';
                    }
                    
                    startDayCell.appendChild(eventElement);
                });
                
            } catch (error) {
                console.error('[CALENDAR] Error rendering calendar events:', error);
            }
        }
        
        // Update current time indicator
        function updateCurrentTimeIndicator() {
            const now = new Date();
            const currentHour = now.getHours();
            const currentMin = now.getMinutes();
            
            // Remove existing indicator
            document.querySelectorAll('.calendar-current-time-line, .calendar-current-time-indicator').forEach(el => el.remove());
            
            // Only show if current hour is in visible range (9-16)
            if (currentHour >= 9 && currentHour <= 16) {
                const timeSlot = document.querySelector(`.calendar-time-slot[data-hour="${currentHour}"]`);
                if (timeSlot) {
                    const slotHeight = 60; // Each slot is 60px
                    const topPx = (currentMin / 60) * slotHeight;
                    
                    // Create time line - spans across all day columns
                    const timeLine = document.createElement('div');
                    timeLine.className = 'calendar-current-time-line';
                    timeLine.style.top = `${topPx}px`;
                    timeSlot.appendChild(timeLine);
                    
                    // Create time indicator on the left
                    const timeIndicator = document.createElement('div');
                    timeIndicator.className = 'calendar-current-time-indicator';
                    timeIndicator.textContent = `${String(currentHour).padStart(2, '0')}:${String(currentMin).padStart(2, '0')}`;
                    timeIndicator.style.top = `${topPx - 10}px`;
                    const timeLabel = timeSlot.querySelector('.calendar-time-label');
                    if (timeLabel) {
                        timeLabel.style.position = 'relative';
                        timeLabel.appendChild(timeIndicator);
                    }
                }
            }
        }
        
        // Calendar navigation functions
        function goToToday() {
            const today = new Date();
            currentWeekStart = new Date(today);
            const day = today.getDay();
            const diff = today.getDate() - day + (day === 0 ? -6 : 1); // Adjust to Monday
            currentWeekStart.setDate(diff);
            currentWeekStart.setHours(0, 0, 0, 0);
            
            currentCalendarDay = new Date(today);
            currentCalendarMonth = new Date(today);
            
            // Update based on current view
            if (currentCalendarView === 'week') {
                updateCalendarHeaders();
                renderCalendarTimeSlots();
            } else if (currentCalendarView === 'day') {
                renderCalendarDayView();
            } else if (currentCalendarView === 'month') {
                renderCalendarMonthView();
            }
        }
        
        function previousWeek() {
            if (currentCalendarView === 'week') {
                currentWeekStart.setDate(currentWeekStart.getDate() - 7);
                updateCalendarHeaders();
                renderCalendarTimeSlots();
            } else if (currentCalendarView === 'day') {
                currentCalendarDay.setDate(currentCalendarDay.getDate() - 1);
                renderCalendarDayView();
            } else if (currentCalendarView === 'month') {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() - 1);
                renderCalendarMonthView();
            }
        }
        
        function nextWeek() {
            if (currentCalendarView === 'week') {
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                updateCalendarHeaders();
                renderCalendarTimeSlots();
            } else if (currentCalendarView === 'day') {
                currentCalendarDay.setDate(currentCalendarDay.getDate() + 1);
                renderCalendarDayView();
            } else if (currentCalendarView === 'month') {
                currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + 1);
                renderCalendarMonthView();
            }
        }
        
        // Current calendar view state
        let currentCalendarView = 'week';
        let currentCalendarDay = new Date();
        let currentCalendarMonth = new Date();
        
        function switchCalendarView(view) {
            console.log(`[CALENDAR VIEW] Switching to ${view} view`);
            currentCalendarView = view;
            
            // Update active button
            document.querySelectorAll('.calendar-view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const clickedBtn = event?.target?.closest('.calendar-view-btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            } else {
                // Fallback: find button by view
                const buttons = document.querySelectorAll('.calendar-view-btn');
                buttons.forEach(btn => {
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'${view}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Hide all views
            const weekView = document.getElementById('calendarWeekView');
            const dayView = document.getElementById('calendarDayView');
            const monthView = document.getElementById('calendarMonthView');
            
            if (weekView) weekView.style.display = 'none';
            if (dayView) dayView.style.display = 'none';
            if (monthView) monthView.style.display = 'none';
            
            // Show selected view
            if (view === 'week') {
                if (weekView) {
                    weekView.style.display = 'flex';
                    renderCalendarTimeSlots();
                }
            } else if (view === 'day') {
                if (dayView) {
                    dayView.style.display = 'flex';
                    renderCalendarDayView();
                }
            } else if (view === 'month') {
                if (monthView) {
                    monthView.style.display = 'flex';
                    renderCalendarMonthView();
                }
            }
        }
        
        // Render day view
        function renderCalendarDayView() {
            const dayTimeSlots = document.getElementById('calendarDayTimeSlots');
            const dayHeader = document.getElementById('single-day-header');
            const dayName = document.getElementById('single-day-name');
            const dayDate = document.getElementById('single-day-date');
            
            if (!dayTimeSlots || !dayHeader || !dayName || !dayDate) return;
            
            // Update day header
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const today = currentCalendarDay || new Date();
            dayName.textContent = dayNames[today.getDay()];
            dayDate.textContent = today.getDate();
            
            // Highlight if today
            if (isSameDay(today, new Date())) {
                dayHeader.classList.add('highlighted');
            } else {
                dayHeader.classList.remove('highlighted');
            }
            
            // Render time slots for single day
            const hours = [];
            for (let h = 9; h <= 16; h++) {
                hours.push(h);
            }
            
            dayTimeSlots.innerHTML = hours.map(hour => {
                const timeStr = `${String(hour).padStart(2, '0')}:00`;
                const isToday = isSameDay(currentCalendarDay || new Date(), new Date());
                return `
                    <div class="calendar-time-slot" data-hour="${hour}">
                        <div class="calendar-time-label">${timeStr}</div>
                        <div class="calendar-day-cell ${isToday ? 'highlighted' : ''}" data-day="0" data-date="${(currentCalendarDay || new Date()).toISOString()}"></div>
                    </div>
                `;
            }).join('');
            
            // Render events for this day
            renderCalendarDayEvents();
            
            // Update current time indicator
            updateCurrentTimeIndicator();
        }
        
        // Render events for day view
        function renderCalendarDayEvents() {
            const dayCell = document.querySelector('#calendarDayTimeSlots .calendar-day-cell');
            if (!dayCell) return;
            
            // Clear existing events
            dayCell.querySelectorAll('.calendar-event').forEach(el => el.remove());
            
            // Filter events for current day
            const today = currentCalendarDay || new Date();
            const dayOfWeek = today.getDay();
            const dayIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert Sunday=0 to Monday=0
            
            calendarEvents.filter(event => event.day === dayIndex).forEach(event => {
                const startSlot = document.querySelector(`#calendarDayTimeSlots .calendar-time-slot[data-hour="${event.startHour}"]`);
                if (!startSlot) return;
                
                const slotHeight = 60;
                const startMinutes = event.startHour * 60 + event.startMin;
                const endMinutes = event.endHour * 60 + event.endMin;
                const duration = endMinutes - startMinutes;
                const topPercent = (event.startMin / 60) * 100;
                const totalHeightPx = (duration / 60) * slotHeight;
                
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event';
                eventElement.style.top = `${topPercent}%`;
                eventElement.style.height = `${totalHeightPx}px`;
                eventElement.textContent = event.title;
                eventElement.title = event.title;
                
                if (getComputedStyle(dayCell).position === 'static') {
                    dayCell.style.position = 'relative';
                }
                
                dayCell.appendChild(eventElement);
            });
        }
        
        // Render month view
        function renderCalendarMonthView() {
            const monthGrid = document.getElementById('calendarMonthGrid');
            if (!monthGrid) return;
            
            const today = currentCalendarMonth || new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // Day names
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            
            let html = `
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); border-bottom: 1px solid #E5E7EB; background: #F9FAFB;">
            `;
            
            // Day headers
            dayNames.forEach(dayName => {
                html += `<div style="padding: 12px; text-align: center; font-size: 12px; font-weight: 600; color: #374151; border-right: 1px solid #E5E7EB;">${dayName}</div>`;
            });
            html += `</div>`;
            
            // Calendar grid
            html += `<div style="display: grid; grid-template-columns: repeat(7, 1fr);">`;
            
            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += `<div style="min-height: 100px; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB; background: #F9FAFB;"></div>`;
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isToday = isSameDay(date, new Date());
                
                // Get events for this day (simplified - would need proper date matching)
                const dayEvents = [];
                
                html += `
                    <div style="min-height: 100px; border-right: 1px solid #E5E7EB; border-bottom: 1px solid #E5E7EB; padding: 8px; ${isToday ? 'background: #F3E8FF;' : 'background: #FFFFFF;'}">
                        <div style="font-size: 14px; font-weight: ${isToday ? '700' : '600'}; color: ${isToday ? '#9333EA' : '#374151'}; margin-bottom: 4px;">${day}</div>
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                            ${dayEvents.slice(0, 3).map(event => `
                                <div style="background: #F3F4F6; border-left: 3px solid #9333EA; padding: 2px 6px; border-radius: 2px; font-size: 10px; color: #1F2937; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${event.title}</div>
                            `).join('')}
                            ${dayEvents.length > 3 ? `<div style="font-size: 10px; color: #6B7280; padding: 2px 6px;">+${dayEvents.length - 3} more</div>` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            monthGrid.innerHTML = html;
        }
        
        // Initialize calendar when page loads
        function initCalendar() {
            console.log('[CALENDAR] Initializing calendar...');
            try {
                if (typeof initCalendarWeek === 'function') {
                    initCalendarWeek();
                } else {
                    console.error('[CALENDAR] initCalendarWeek not found');
                }
                
                if (typeof updateCalendarHeaders === 'function') {
                    updateCalendarHeaders();
                } else {
                    console.error('[CALENDAR] updateCalendarHeaders not found');
                }
                
                if (typeof renderCalendarTimeSlots === 'function') {
                    renderCalendarTimeSlots();
                } else {
                    console.error('[CALENDAR] renderCalendarTimeSlots not found');
                }
                
                // Update current time indicator immediately and then every minute
                if (typeof updateCurrentTimeIndicator === 'function') {
                    updateCurrentTimeIndicator();
                    setInterval(updateCurrentTimeIndicator, 60000);
                }
                
                console.log('[CALENDAR] Calendar initialized successfully');
            } catch (error) {
                console.error('[CALENDAR] Error initializing calendar:', error);
            }
        }
        
        // Store all tasks globally for list view
        let allTasksList = [];
        
        // Render tasks in list view
        async function renderTaskListView() {
            console.log('[TASK LIST] Rendering task list view...');
            
            const taskListContainer = document.getElementById('taskListContainer');
            if (!taskListContainer) {
                console.error('[TASK LIST] Task list container not found');
                return;
            }
            
            // Show loading state
            taskListContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7280;">Loading tasks...</div>';
            
            // If tasks are not loaded, fetch them
            if (allTasksList.length === 0) {
                console.log('[TASK LIST] No tasks in cache, fetching from API...');
                try {
                    const result = await pywebview.api.fetch_tasks();
                    if (result && result.success && result.tasks) {
                        allTasksList = result.tasks;
                        console.log(`[TASK LIST] Loaded ${allTasksList.length} tasks from API`);
                    } else {
                        console.warn('[TASK LIST] Failed to fetch tasks');
                        allTasksList = [];
                    }
                } catch (error) {
                    console.error('[TASK LIST] Error fetching tasks:', error);
                    allTasksList = [];
                }
            }
            
            // Render tasks
            if (allTasksList.length === 0) {
                taskListContainer.innerHTML = `
                    <div class="task-list-empty">
                        <div class="task-list-empty-icon"></div>
                        <div class="task-list-empty-title">No tasks found</div>
                        <div class="task-list-empty-text">You don't have any tasks yet. Create a new task to get started.</div>
                    </div>
                `;
                return;
            }
            
            // Render task list
            taskListContainer.innerHTML = allTasksList.map(task => {
                const taskId = task.id || task.task_id || '';
                const taskTitle = task.task_name || task.name || task.title || 'Untitled Task';
                const taskKey = task.task_key || task.key || taskId.substring(0, 8).toUpperCase() || 'N/A';
                const priority = task.priority || task.task_priority || 'medium';
                const priorityLower = String(priority).toLowerCase();
                const dueDate = task.due_date || task.dueDate || task.due_date_time || '';
                const assignees = task.assignees || task.assigned_to || task.task_assignees || [];
                const assigneeList = Array.isArray(assignees) ? assignees : (assignees ? [assignees] : []);
                const taskStatus = task.status || task.task_status || 'new';
                const statusName = (typeof taskStatus === 'object' ? taskStatus.name : taskStatus) || 'new';
                const projectName = task.project_name || (task.project && task.project.name) || 'N/A';
                
                // Format date
                let formattedDate = '';
                if (dueDate) {
                    try {
                        const date = new Date(dueDate);
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        formattedDate = `${date.getDate()} ${months[date.getMonth()]}, ${date.getFullYear()}`;
                    } catch (e) {
                        formattedDate = formatDate(dueDate);
                    }
                }
                
                // Get assignee names
                const assigneeNames = assigneeList.slice(0, 3).map(assignee => {
                    return assignee.name || assignee.user_name || (assignee.first_name && assignee.last_name ? `${assignee.first_name} ${assignee.last_name}` : '') || 'Unknown';
                });
                
                return `
                    <div class="task-list-item" onclick="openTaskDetailModal('${taskId}')">
                        <div class="task-list-item-left">
                            <div class="task-list-item-title">${taskTitle}</div>
                            <div class="task-list-item-meta">
                                <div class="task-list-item-meta-item">
                                    <span></span>
                                    <span>${taskKey}</span>
                                </div>
                                ${projectName !== 'N/A' ? `
                                    <div class="task-list-item-meta-item">
                                        <span></span>
                                        <span>${projectName}</span>
                                    </div>
                                ` : ''}
                                ${formattedDate ? `
                                    <div class="task-list-item-meta-item">
                                        <span></span>
                                        <span>${formattedDate}</span>
                                    </div>
                                ` : ''}
                                ${assigneeNames.length > 0 ? `
                                    <div class="task-list-item-meta-item">
                                        <span></span>
                                        <span>${assigneeNames.join(', ')}${assigneeList.length > 3 ? ` +${assigneeList.length - 3}` : ''}</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="task-list-item-tags">
                                <span class="task-tag task-tag-status">${statusName}</span>
                                <span class="task-tag task-tag-project">${projectName}</span>
                            </div>
                        </div>
                        <div class="task-list-item-right">
                            <span class="task-list-item-status">${statusName}</span>
                            <span class="task-list-item-priority ${priorityLower}">${priority}</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log(`[TASK LIST] Rendered ${allTasksList.length} tasks in list view`);
        }
        
        // Switch task view (List/Calendar/Board)
        function switchTaskView(view) {
            console.log(`[TASK VIEW] Switching to ${view} view`);
            
            // Update active button
            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Find and activate the clicked button
            const clickedBtn = event?.target?.closest('.view-toggle-btn');
            if (clickedBtn) {
                clickedBtn.classList.add('active');
            } else {
                // Fallback: find button by view
                const buttons = document.querySelectorAll('.view-toggle-btn');
                buttons.forEach(btn => {
                    const onclickAttr = btn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'${view}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Hide all task views
            const kanbanBoard = document.getElementById('kanbanBoard');
            const taskListContainer = document.getElementById('taskListContainer');
            const taskCalendarContainer = document.getElementById('taskCalendarContainer');
            
            if (kanbanBoard) kanbanBoard.style.display = 'none';
            if (taskListContainer) taskListContainer.style.display = 'none';
            if (taskCalendarContainer) taskCalendarContainer.style.display = 'none';
            
            // Show selected view
            if (view === 'board') {
                if (kanbanBoard) {
                    kanbanBoard.style.display = 'block';
                    console.log('[TASK VIEW] Board view shown');
                }
            } else if (view === 'list') {
                if (taskListContainer) {
                    taskListContainer.style.display = 'block';
                    console.log('[TASK VIEW] List view shown');
                    // Load and render tasks in list view
                    renderTaskListView();
                } else {
                    // Create list container if it doesn't exist
                    const container = document.createElement('div');
                    container.id = 'taskListContainer';
                    container.className = 'task-list-container';
                    const taskMainContent = document.querySelector('.task-main-content');
                    if (taskMainContent && kanbanBoard) {
                        kanbanBoard.parentNode.insertBefore(container, kanbanBoard);
                        container.style.display = 'block';
                        // Load and render tasks
                        renderTaskListView();
                    }
                }
            } else if (view === 'calendar') {
                // Show calendar view within task page
                if (taskCalendarContainer) {
                    // Check if calendar is already rendered
                    if (taskCalendarContainer.children.length === 0) {
                        // Get calendar page content
                        const calendarPage = document.getElementById('page-calendar');
                        if (calendarPage) {
                            const calendarContent = calendarPage.querySelector('.calendar-page-container');
                            if (calendarContent) {
                                // Clone calendar content
                                const clonedContent = calendarContent.cloneNode(true);
                                taskCalendarContainer.appendChild(clonedContent);
                                console.log('[TASK VIEW] Calendar content cloned');
                            }
                        }
                    }
                    
                    taskCalendarContainer.style.display = 'block';
                    console.log('[TASK VIEW] Calendar view shown');
                    
                    // Initialize calendar
                    setTimeout(() => {
                        if (typeof initCalendar === 'function') {
                            initCalendar();
                            console.log('[TASK VIEW] Calendar initialized');
                        } else {
                            console.error('[TASK VIEW] initCalendar function not found');
                        }
                    }, 200);
                } else {
                    console.error('[TASK VIEW] Calendar container not found');
                }
            }
        }
        
        // Make functions available globally - ensure they're accessible
        if (typeof window !== 'undefined') {
            window.switchPage = switchPage;
            window.switchTaskView = switchTaskView;
            window.renderTaskListView = renderTaskListView;
            window.initCalendar = initCalendar;
            window.goToToday = goToToday;
            window.previousWeek = previousWeek;
            window.nextWeek = nextWeek;
            window.switchCalendarView = switchCalendarView;
            window.initCalendarWeek = initCalendarWeek;
            window.updateCalendarHeaders = updateCalendarHeaders;
            window.renderCalendarTimeSlots = renderCalendarTimeSlots;
            window.renderCalendarEvents = renderCalendarEvents;
            window.updateCurrentTimeIndicator = updateCurrentTimeIndicator;
            
            console.log('[CALENDAR] All calendar functions registered globally');
        }
        
        // Handle task card click (prevent modal during drag)
        let dragStartTime = 0;
        let dragStartPos = { x: 0, y: 0 };
        
        function handleTaskCardClick(event, taskId) {
            // Check if this was a drag operation (moved more than 5px or took more than 200ms)
            const timeDiff = Date.now() - dragStartTime;
            const xDiff = Math.abs(event.clientX - dragStartPos.x);
            const yDiff = Math.abs(event.clientY - dragStartPos.y);
            const moved = xDiff > 5 || yDiff > 5;
            
            if (moved || timeDiff > 200) {
                // This was a drag, not a click
                dragStartTime = 0;
                return;
            }
            
            // Prevent event bubbling
            event.stopPropagation();
            
            // Open task detail modal
            openTaskDetailModal(taskId);
        }
        
        // Track drag start for task cards
        document.addEventListener('dragstart', function(event) {
            if (event.target.classList.contains('kanban-task-card')) {
                dragStartTime = Date.now();
                dragStartPos = { x: event.clientX, y: event.clientY };
            }
        });
        
        // Task Detail Modal Functions
        async function openTaskDetailModal(taskId) {
            console.log(`[TASK DETAIL] Opening modal for task ID: ${taskId}`);
            
            const modal = document.getElementById('taskDetailModal');
            if (!modal) {
                console.error('[TASK DETAIL] Modal not found');
                return;
            }
            
            // Show modal
            modal.classList.add('show');
            
            // Show loading state
            const modalBody = document.getElementById('taskDetailBody');
            if (modalBody) {
                modalBody.innerHTML = '<div style="text-align: center; padding: 40px; color: #6B7280;">Loading task details...</div>';
            }
            
            try {
                // Fetch task details from API
                console.log(`[TASK DETAIL] Fetching task details from API...`);
                const result = await pywebview.api.fetch_task(taskId);
                console.log(`[TASK DETAIL] API Response:`, result);
                
                if (result && result.success && result.task) {
                    const task = result.task;
                    console.log(`[TASK DETAIL] Task data:`, task);
                    populateTaskDetailModal(task);
                } else {
                    const errorMsg = result?.error || result?.message || 'Failed to fetch task details';
                    console.error(`[TASK DETAIL] Error: ${errorMsg}`);
                    if (modalBody) {
                        modalBody.innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="color: #EF4444; margin-bottom: 16px;">Error loading task details</div>
                                <div style="color: #6B7280; font-size: 14px;">${errorMsg}</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error(`[TASK DETAIL] Exception:`, error);
                if (modalBody) {
                    modalBody.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="color: #EF4444; margin-bottom: 16px;">Error loading task details</div>
                            <div style="color: #6B7280; font-size: 14px;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }
        
        function closeTaskDetailModal() {
            const modal = document.getElementById('taskDetailModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        function populateTaskDetailModal(task) {
            console.log(`[TASK DETAIL] Populating modal with task data`);
            
            // Extract task data
            const taskName = task.task_name || task.name || task.title || 'Untitled Task';
            const taskKey = task.task_key || task.key || task.id?.substring(0, 8).toUpperCase() || 'N/A';
            const projectName = task.project_name || (task.project && task.project.name) || task.project_name || 'N/A';
            const startDate = task.start_date || task.startDate || '';
            const dueDate = task.due_date || task.dueDate || task.due_date_time || '';
            const taskStatus = task.status || task.task_status || 'New';
            const statusName = typeof taskStatus === 'object' ? taskStatus.name : taskStatus;
            const taskType = task.task_type || (task.task_type_obj && task.task_type_obj.name) || 'N/A';
            const priority = task.priority || task.task_priority || 'Medium';
            const updatedBy = task.updated_by || (task.updated_by_user && (task.updated_by_user.first_name + ' ' + task.updated_by_user.last_name)) || 'N/A';
            const createdBy = task.created_by || (task.created_by_user && (task.created_by_user.first_name + ' ' + task.created_by_user.last_name)) || 'N/A';
            const createdOn = task.created_at || task.created_on || task.createdAt || '';
            const updatedOn = task.updated_at || task.updated_on || task.updatedAt || '';
            
            // Get assignees
            const assignees = task.task_assignees || task.assignees || task.assigned_to || [];
            const assigneeList = Array.isArray(assignees) ? assignees : (assignees ? [assignees] : []);
            
            // Format dates
            function formatDateForDisplay(dateStr) {
                if (!dateStr) return 'N/A';
                try {
                    const date = new Date(dateStr);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                } catch (e) {
                    return dateStr;
                }
            }
            
            // Update modal title
            const modalTitle = document.getElementById('taskDetailTitle');
            if (modalTitle) {
                modalTitle.textContent = taskName;
            }
            
            // Populate modal body
            const modalBody = document.getElementById('taskDetailBody');
            if (modalBody) {
                modalBody.innerHTML = `
                    <!-- Task Information -->
                    <div class="task-detail-info-grid">
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Task Key</div>
                            <div class="task-detail-info-value">${taskKey}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Project</div>
                            <div class="task-detail-info-value">${projectName}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Start Date</div>
                            <div class="task-detail-info-value">${formatDateForDisplay(startDate)}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Task Status</div>
                            <div class="task-detail-info-value">${statusName}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Due Date</div>
                            <div class="task-detail-info-value">${formatDateForDisplay(dueDate)}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Task Type</div>
                            <div class="task-detail-info-value">${taskType}</div>
                        </div>
                    </div>
                    
                    <!-- Assignees Section -->
                    <div class="task-detail-section">
                        <div class="task-detail-section-title">Assignees</div>
                        ${assigneeList.length > 0 ? `
                            <table class="task-detail-assignees-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>Mail ID</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${assigneeList.map(assignee => {
                                        const name = assignee.name || 
                                                   (assignee.user && (assignee.user.first_name + ' ' + assignee.user.last_name)) ||
                                                   (assignee.first_name && assignee.last_name ? `${assignee.first_name} ${assignee.last_name}` : '') ||
                                                   assignee.user_name ||
                                                   'Unknown';
                                        const designation = assignee.designation || 
                                                          (assignee.user && assignee.user.designation) ||
                                                          assignee.role ||
                                                          'N/A';
                                        const email = assignee.email || 
                                                    (assignee.user && assignee.user.email) ||
                                                    assignee.mail_id ||
                                                    'N/A';
                                        const initials = getInitials(name);
                                        return `
                                            <tr>
                                                <td>
                                                    <div style="display: flex; align-items: center;">
                                                        <div class="task-detail-assignee-avatar">${initials}</div>
                                                        <span>${name}</span>
                                                    </div>
                                                </td>
                                                <td>${designation}</td>
                                                <td>${email}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div style="padding: 20px; text-align: center; color: #6B7280; background: #F9FAFB; border-radius: 8px;">
                                No assignees
                            </div>
                        `}
                    </div>
                    
                    <!-- Additional Task Details -->
                    <div class="task-detail-info-grid">
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Priority</div>
                            <div class="task-detail-info-value">${priority}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Updated By</div>
                            <div class="task-detail-info-value">${updatedBy}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Created By</div>
                            <div class="task-detail-info-value">${createdBy}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Created On</div>
                            <div class="task-detail-info-value">${formatDateForDisplay(createdOn)}</div>
                        </div>
                        <div class="task-detail-info-item">
                            <div class="task-detail-info-label">Updated On</div>
                            <div class="task-detail-info-value">${formatDateForDisplay(updatedOn)}</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Initialize appointments when page loads
        function initializeAppointments() {
            // Wait for pywebview to be available
            if (typeof pywebview !== 'undefined' && pywebview.api && pywebview.api.fetch_appointments) {
                console.log('[APPOINTMENTS] Initializing appointments...');
                // Load and render appointments in schedule widget after a short delay
                setTimeout(() => {
                    renderAppointmentsInSchedule().catch(err => {
                        console.error('[APPOINTMENTS] Error initializing appointments:', err);
                    });
                }, 1500);
            } else {
                console.log('[APPOINTMENTS] Waiting for pywebview API...');
                // Retry after a short delay if pywebview not ready
                setTimeout(initializeAppointments, 500);
            }
        }
        
        // Also call after initialize() completes - add a small delay to ensure API is ready
        function tryInitializeAppointmentsAfterAPI() {
            if (typeof pywebview !== 'undefined' && pywebview.api && pywebview.api.fetch_appointments) {
                console.log('[APPOINTMENTS] API ready, loading appointments...');
                setTimeout(() => {
                    renderAppointmentsInSchedule().catch(err => {
                        console.error('[APPOINTMENTS] Error loading appointments:', err);
                    });
                }, 2000);
            } else {
                // Retry after a short delay
                setTimeout(tryInitializeAppointmentsAfterAPI, 1000);
            }
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeAppointments();
                // Also try after a delay in case API loads later
                setTimeout(tryInitializeAppointmentsAfterAPI, 3000);
            });
        } else {
            // DOM already loaded
            initializeAppointments();
            setTimeout(tryInitializeAppointmentsAfterAPI, 3000);
        }
    </script>
    
    <!-- Task Detail Modal -->
    <div class="task-detail-modal" id="taskDetailModal" onclick="if(event.target.id === 'taskDetailModal') closeTaskDetailModal()">
        <div class="task-detail-modal-content" onclick="event.stopPropagation()">
            <div class="task-detail-header">
                <div class="task-detail-title-section">
                    <h2 class="task-detail-title" id="taskDetailTitle">Task Details</h2>
                    <svg class="task-detail-edit-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                        <path d="M11.0131 1.42782C11.7472 0.693744 12.8171 0.693744 13.5512 1.42782L18.5722 6.44882C19.3063 7.18289 19.3063 8.25281 18.5722 8.98688L7.96309 19.5959C7.53269 20.0263 6.95821 20.2621 6.35889 20.2621H2.43751C1.58523 20.2621 0.896912 19.5738 0.896912 18.7215V14.8001C0.896912 14.2008 1.13272 13.6263 1.56312 13.1959L12.1722 2.58688C12.9063 1.85281 13.9762 1.85281 14.7103 2.58688L17.4131 5.28966C18.1472 6.02374 18.1472 7.09366 17.4131 7.82773L6.80401 18.4368C6.37361 18.8672 5.79913 19.103 5.19981 19.103H2.43751V16.3407C2.43751 15.7404 2.67332 15.1659 3.10372 14.7355L13.7128 4.12641C14.4469 3.39234 15.5168 3.39234 16.2509 4.12641L18.9537 6.82919C19.6877 7.56327 19.6877 8.63319 18.9537 9.36726L8.34458 19.9763C7.91418 20.4067 7.3397 20.6425 6.74038 20.6425H2.43751C1.58523 20.6425 0.896912 19.9542 0.896912 19.1019V14.799C0.896912 14.1997 1.13272 13.6252 1.56312 13.1948L12.1722 2.58578Z" fill="currentColor"/>
                    </svg>
                </div>
                <button class="task-detail-close" onclick="closeTaskDetailModal()"></button>
            </div>
            <div class="task-detail-body" id="taskDetailBody">
                <!-- Task details will be populated here -->
            </div>
            <div class="task-detail-footer">
                <button class="task-detail-btn-cancel" onclick="closeTaskDetailModal()">Cancel</button>
                <button class="task-detail-btn-save" onclick="closeTaskDetailModal()">Save</button>
            </div>
        </div>
    </div>
</body>
</html>

